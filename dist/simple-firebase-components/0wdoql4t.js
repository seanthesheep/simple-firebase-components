/*! Built with http://stenciljs.com */

window["simple-firebase-components"].loadComponents("0wdoql4t",function importComponent(exports,h,Context,publicPath){"use strict";function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}function deepCopy(e){return deepExtend(void 0,e)}function deepExtend(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:var n=t;return new Date(n.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(var r in t)t.hasOwnProperty(r)&&(e[r]=deepExtend(e[r],t[r]));return e}function patchProperty(e,t,n){e[t]=n}function createSubscribe(e,t){var n=new ObserverProxy(e,t);return n.subscribe.bind(n)}function implementsAnyMethods(e,t){if("object"!=typeof e||null===e)return!1;for(var n=0,r=t;n<r.length;n++){var o=r[n];if(o in e&&"function"==typeof e[o])return!0}return!1}function noop(){}function createFirebaseNamespace(){function e(e){return e=e||DEFAULT_ENTRY_NAME,contains(o,e)||error("no-app",{name:e}),o[e]}function t(){return Object.keys(o).map(function(e){return o[e]})}function n(e,t){Object.keys(i).forEach(function(n){var o=r(e,n);null!==o&&a[o]&&a[o](t,e)})}function r(e,t){return"serverAuth"===t?null:t}var o={},i={},a={},s={__esModule:!0,initializeApp:function(e,t){void 0===t?t=DEFAULT_ENTRY_NAME:"string"==typeof t&&""!==t||error("bad-app-name",{name:t+""}),contains(o,t)&&error("duplicate-app",{name:t});var r=new FirebaseAppImpl(e,t,s);return o[t]=r,n(r,"create"),r},app:e,apps:null,Promise:Promise,SDK_VERSION:"4.6.1",INTERNAL:{registerService:function(n,r,o,u,c){i[n]&&error("duplicate-service",{name:n}),i[n]=r,u&&(a[n]=u,t().forEach(function(e){u("create",e)}));var h=function(t){return void 0===t&&(t=e()),"function"!=typeof t[n]&&error("invalid-app-argument",{name:n}),t[n]()};return void 0!==o&&deepExtend(h,o),s[n]=h,FirebaseAppImpl.prototype[n]=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._getService.bind(this,n).apply(this,c?e:[])},h},createFirebaseNamespace:createFirebaseNamespace,extendNamespace:function(e){deepExtend(s,e)},createSubscribe:createSubscribe,ErrorFactory:ErrorFactory,removeApp:function(e){n(o[e],"delete"),delete o[e]},factories:i,useAsService:r,Promise:Promise,deepExtend:deepExtend}};return patchProperty(s,"default",s),Object.defineProperty(s,"apps",{get:t}),patchProperty(e,"App",FirebaseAppImpl),s}function error(e,t){throw appErrors.create(e,t)}function getLogLevel(){return logLevel}function setLogLevel(e){logLevel=e}function debug(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(logLevel<=LogLevel.DEBUG){var o=(new Date).toISOString(),i=n.map(argToString);console.log.apply(console,["Firestore ("+SDK_VERSION+") "+o+" ["+e+"]: "+t].concat(i))}}function error$1(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(logLevel<=LogLevel.ERROR){var r=(new Date).toISOString(),o=t.map(argToString);console.error.apply(console,["Firestore ("+SDK_VERSION+") "+r+": "+e].concat(o))}}function argToString(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function fail(e){var t="FIRESTORE ("+SDK_VERSION+") INTERNAL ASSERTION FAILED: "+e;throw error$1(t),new Error(t)}function assert$1(e,t){e||fail(t)}function emptyByteString(){return PlatformSupport.getPlatform().emptyByteString}function makeConstructorPrivate(e,t){function n(){var e="This constructor is private.";throw t&&(e+=" ",e+=t),new FirestoreError(Code.INVALID_ARGUMENT,e)}n.prototype=e.prototype;for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}function contains$2(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function defaulted(e,t){return void 0!==e?e:t}function forEachNumber(e,t){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=parseInt(n,10);isNaN(r)||t(r,e[n])}}function forEach$1(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function isEmpty$1(e){assert$1(null!=e&&"object"==typeof e,"isEmpty() expects object parameter.");for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function shallowCopy(e){assert$1(e&&"object"==typeof e,"shallowCopy() expects object parameter.");var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}function validateExactNumberOfArgs(e,t,n){if(t.length!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires "+formatPlural(n,"argument")+", but was called with "+formatPlural(t.length,"argument")+".")}function validateAtLeastNumberOfArgs(e,t,n){if(t.length<n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires at least "+formatPlural(n,"argument")+", but was called with "+formatPlural(t.length,"argument")+".")}function validateBetweenNumberOfArgs(e,t,n,r){if(t.length<n||t.length>r)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires between "+n+" and "+r+" arguments, but was called with "+formatPlural(t.length,"argument")+".")}function validateNamedArrayAtLeastNumberOfElements(e,t,n,r){if(!(t instanceof Array)||t.length<r)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" argument to be an array with at least "+formatPlural(r,"element")+".")}function validateArgType(e,t,n,r){validateType(e,t,ordinal(n)+" argument",r)}function validateOptionalArgType(e,t,n,r){void 0!==r&&validateArgType(e,t,n,r)}function validateNamedType(e,t,n,r){validateType(e,t,n+" option",r)}function validateNamedOptionalType(e,t,n,r){void 0!==r&&validateNamedType(e,t,n,r)}function validateType(e,t,n,r){if(typeof r!==t||"object"===t&&!isPlainObject(r)){var o=valueDescription(r);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires its "+n+" to be of type "+t+", but it was: "+o)}}function isPlainObject(e){return"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype}function valueDescription(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";var t=tryGetCustomObjectType(e);return t?"a custom "+t+" object":"an object"}return"function"==typeof e?"a function":fail("Unknown wrong type: "+typeof e)}function tryGetCustomObjectType(e){if(e.constructor){var t=/function\s+([^\s(]+)\s*\(/.exec(e.constructor.toString());if(t&&t.length>1)return t[1]}return null}function validateDefined(e,t,n){if(void 0===n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires a valid "+ordinal(t)+" argument, but it was undefined.")}function validateOptionNames(e,t,n){forEach$1(t,function(t,r){if(n.indexOf(t)<0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Unknown option '"+t+"' passed to function "+e+"(). Available options: "+n.join(", "))})}function invalidClassError(e,t,n,r){var o=valueDescription(r);return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() requires its "+ordinal(n)+" argument to be a "+t+", but it was: "+o)}function ordinal(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";default:return e+"th"}}function formatPlural(e,t){return e+" "+t+(1===e?"":"s")}function primitiveComparator(e,t){return e<t?-1:e>t?1:0}function equals(e,t){return null!==e&&void 0!==e?!(!t||!e.equals(t)):e===t}function arrayEquals(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!e[n].equals(t[n]))return!1;return!0}function immediatePredecessor(e){var t=e.length-1;return 0===e.length?"":"\0"===e.charAt(t)?e.substring(0,t):e.substring(0,t)+String.fromCharCode(e.charCodeAt(t)-1)}function immediateSuccessor(e){return e+"\0"}function assertUint8ArrayAvailable(){if("undefined"==typeof Uint8Array)throw new FirestoreError(Code.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function assertBase64Available(){if(!PlatformSupport.getPlatform().base64Available)throw new FirestoreError(Code.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function numericComparator(e,t){return e<t?-1:e>t?1:e===t?0:isNaN(e)?isNaN(t)?0:-1:1}function numericEquals(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function isNullOrUndefined(e){return null===e||void 0===e}function isSafeInteger(e){return isInteger(e)&&e<=MAX_SAFE_INTEGER&&e>=MIN_SAFE_INTEGER}function fieldFilter(e,t,n){if(n.equals(NullValue.INSTANCE)){if(t!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new NullFilter(e)}if(n.equals(DoubleValue.NAN)){if(t!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on NaN.");return new NanFilter(e)}return new RelationFilter(e,t,n)}function isPermanentError(e){switch(e){case Code.OK:return fail("Treated status OK as error");case Code.CANCELLED:case Code.UNKNOWN:case Code.DEADLINE_EXCEEDED:case Code.RESOURCE_EXHAUSTED:case Code.INTERNAL:case Code.UNAVAILABLE:case Code.UNAUTHENTICATED:return!1;case Code.INVALID_ARGUMENT:case Code.NOT_FOUND:case Code.ALREADY_EXISTS:case Code.PERMISSION_DENIED:case Code.FAILED_PRECONDITION:case Code.ABORTED:case Code.OUT_OF_RANGE:case Code.UNIMPLEMENTED:case Code.DATA_LOSS:return!0;default:return fail("Unknown status code: "+e)}}function mapCodeFromRpcStatus(e){var t=RpcCode[e];if(void 0!==t)return mapCodeFromRpcCode(t)}function mapCodeFromRpcCode(e){switch(e){case RpcCode.OK:return Code.OK;case RpcCode.CANCELLED:return Code.CANCELLED;case RpcCode.UNKNOWN:return Code.UNKNOWN;case RpcCode.DEADLINE_EXCEEDED:return Code.DEADLINE_EXCEEDED;case RpcCode.RESOURCE_EXHAUSTED:return Code.RESOURCE_EXHAUSTED;case RpcCode.INTERNAL:return Code.INTERNAL;case RpcCode.UNAVAILABLE:return Code.UNAVAILABLE;case RpcCode.UNAUTHENTICATED:return Code.UNAUTHENTICATED;case RpcCode.INVALID_ARGUMENT:return Code.INVALID_ARGUMENT;case RpcCode.NOT_FOUND:return Code.NOT_FOUND;case RpcCode.ALREADY_EXISTS:return Code.ALREADY_EXISTS;case RpcCode.PERMISSION_DENIED:return Code.PERMISSION_DENIED;case RpcCode.FAILED_PRECONDITION:return Code.FAILED_PRECONDITION;case RpcCode.ABORTED:return Code.ABORTED;case RpcCode.OUT_OF_RANGE:return Code.OUT_OF_RANGE;case RpcCode.UNIMPLEMENTED:return Code.UNIMPLEMENTED;case RpcCode.DATA_LOSS:return Code.DATA_LOSS;default:return fail("Unknown status code: "+e)}}function mapRpcCodeFromCode(e){if(void 0===e)return RpcCode.OK;switch(e){case Code.OK:return RpcCode.OK;case Code.CANCELLED:return RpcCode.CANCELLED;case Code.UNKNOWN:return RpcCode.UNKNOWN;case Code.DEADLINE_EXCEEDED:return RpcCode.DEADLINE_EXCEEDED;case Code.RESOURCE_EXHAUSTED:return RpcCode.RESOURCE_EXHAUSTED;case Code.INTERNAL:return RpcCode.INTERNAL;case Code.UNAVAILABLE:return RpcCode.UNAVAILABLE;case Code.UNAUTHENTICATED:return RpcCode.UNAUTHENTICATED;case Code.INVALID_ARGUMENT:return RpcCode.INVALID_ARGUMENT;case Code.NOT_FOUND:return RpcCode.NOT_FOUND;case Code.ALREADY_EXISTS:return RpcCode.ALREADY_EXISTS;case Code.PERMISSION_DENIED:return RpcCode.PERMISSION_DENIED;case Code.FAILED_PRECONDITION:return RpcCode.FAILED_PRECONDITION;case Code.ABORTED:return RpcCode.ABORTED;case Code.OUT_OF_RANGE:return RpcCode.OUT_OF_RANGE;case Code.UNIMPLEMENTED:return RpcCode.UNIMPLEMENTED;case Code.DATA_LOSS:return RpcCode.DATA_LOSS;default:return fail("Unknown status code: "+e)}}function mapCodeFromHttpStatus(e){switch(e){case 200:return Code.OK;case 400:return Code.INVALID_ARGUMENT;case 401:return Code.UNAUTHENTICATED;case 403:return Code.PERMISSION_DENIED;case 404:return Code.NOT_FOUND;case 409:return Code.ABORTED;case 416:return Code.OUT_OF_RANGE;case 429:return Code.RESOURCE_EXHAUSTED;case 499:return Code.CANCELLED;case 500:return Code.UNKNOWN;case 501:return Code.UNIMPLEMENTED;case 503:return Code.UNAVAILABLE;case 504:return Code.DEADLINE_EXCEEDED;default:return e>=200&&e<300?Code.OK:e>=400&&e<500?Code.FAILED_PRECONDITION:e>=500&&e<600?Code.INTERNAL:Code.UNKNOWN}}function maybeDocumentMap(){return EMPTY_MAYBE_DOCUMENT_MAP}function documentMap(){return EMPTY_DOCUMENT_MAP}function documentVersionMap(){return EMPTY_DOCUMENT_VERSION_MAP}function documentKeySet(){return EMPTY_DOCUMENT_KEY_SET}function applyResumeToken(e,t){t.length>0&&(e.resumeToken=t)}function assertPresent(e,t){assert$1(!isNullOrUndefined(e),t+" is missing")}function parseInt64(e){return"number"==typeof e?e:"string"==typeof e?parseInt(e,10):fail("can't parse "+e)}function hasTag(e,t,n){return t===n||!t&&n in e}function fromDotSeparatedString(e){if(e.search(RESERVED)>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(FieldPath$1.bind.apply(FieldPath$1,[void 0].concat(e.split("."))))}catch(t){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}function compareChangeType(e,t){var n=function(e){switch(e){case ChangeType.Added:return 1;case ChangeType.Modified:case ChangeType.Metadata:return 2;case ChangeType.Removed:return 0;default:return fail("Unknown ChangeType: "+e)}};return n(e)-n(t)}function encode(e){for(var t="",n=0;n<e.length;n++)t.length>0&&(t=encodeSeparator(t)),t=encodeSegment(e.get(n),t);return encodeSeparator(t)}function encodeSegment(e,t){for(var n=t,r=e.length,o=0;o<r;o++){var i=e.charAt(o);switch(i){case"\0":n+=escapeChar+encodedNul;break;case escapeChar:n+=escapeChar+encodedEscape;break;default:n+=i}}return n}function encodeSeparator(e){return e+escapeChar+encodedSeparatorChar}function decode$1(e){var t=e.length;if(assert$1(t>=2,"Invalid path "+e),2===t)return assert$1(e.charAt(0)===escapeChar&&e.charAt(1)===encodedSeparatorChar,"Non-empty path "+e+" had length 2"),ResourcePath.EMPTY_PATH;for(var n=t-2,r=[],o="",i=0;i<t;){var a=e.indexOf(escapeChar,i);switch((a<0||a>n)&&fail('Invalid encoded resource path: "'+e+'"'),e.charAt(a+1)){case encodedSeparatorChar:var s=e.substring(i,a),u=void 0;0===o.length?u=s:(u=o+=s,o=""),r.push(u);break;case encodedNul:o+=e.substring(i,a),o+="\0";break;case encodedEscape:o+=e.substring(i,a+1);break;default:fail('Invalid encoded resource path: "'+e+'"')}i=a+2}return new ResourcePath(r)}function createOrUpgradeDb(e,t){assert$1(0===t,"Unexpected upgrade from version "+t),e.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath}),e.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath}),e.createObjectStore(DbTargetDocument.store,{keyPath:DbTargetDocument.keyPath}).createIndex(DbTargetDocument.documentTargetsIndex,DbTargetDocument.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath}).createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(DbDocumentMutation.store),e.createObjectStore(DbRemoteDocument.store),e.createObjectStore(DbOwner.store),e.createObjectStore(DbTargetGlobal.store)}function wrapRequest(e){return new PersistencePromise(function(t,n){e.onsuccess=function(e){var n=e.target.result;t(n)},e.onerror=function(e){n(e.target.error)}})}function validateStreamToken(e){return assert$1("string"==typeof e,"Persisting non-string stream token not supported."),e}function mutationsStore(e){return getStore(e,DbMutationBatch.store)}function documentMutationsStore(e){return getStore(e,DbDocumentMutation.store)}function mutationQueuesStore(e){return getStore(e,DbMutationQueue.store)}function getStore(e,t){return e instanceof SimpleDbTransaction?e.store(t):fail("Invalid transaction object provided!")}function targetsStore(e){return getStore$1(e,DbTarget.store)}function globalTargetStore(e){return getStore$1(e,DbTargetGlobal.store)}function documentTargetStore(e){return getStore$1(e,DbTargetDocument.store)}function getStore$1(e,t){return e instanceof SimpleDbTransaction?e.store(t):fail("Invalid transaction object provided!")}function remoteDocumentsStore(e){return e instanceof SimpleDbTransaction?e.store(DbRemoteDocument.store):fail("Invalid transaction object provided!")}function dbKey(e){return e.path.toArray()}function isDocumentQuery(e){return void 0!==e.documents}function makeCredentialsProvider(e){if(!e)return new EmptyCredentialsProvider;switch(e.type){case"google-auth":return new GoogleCredentialsProvider(e.client);case"gapi":return new FirstPartyCredentialsProvider(e.client,e.sessionIndex||"0");case"provider":return e.client;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}function isPartialObserver(e){return implementsAnyMethods$1(e,["next","error","complete"])}function implementsAnyMethods$1(e,t){if("object"!=typeof e||null===e)return!1;for(var n=e,r=0,o=t;r<o.length;r++){var i=o[r];if(i in n&&"function"==typeof n[i])return!0}return!1}function isWrite(e){switch(e){case UserDataSource.Set:case UserDataSource.MergeSet:case UserDataSource.Update:return!0;case UserDataSource.QueryValue:return!1;default:throw fail("Unexpected case for UserDataSource: "+e)}}function looksLikeJsonObject(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof GeoPoint||e instanceof Blob||e instanceof DocumentKeyReference||e instanceof FieldValueImpl)}function validatePlainObject(e,t,n){if(!looksLikeJsonObject(n)||!isPlainObject(n)){var r=valueDescription(n);throw"an object"===r?t.createError(e+" a custom object"):t.createError(e+" "+r)}}function fieldPathFromArgument(e,t){if(t instanceof FieldPath$1)return t._internalPath;if("string"==typeof t)return fieldPathFromDotSeparatedString(e,t);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function fieldPathFromDotSeparatedString(e,t){try{return fromDotSeparatedString(t)._internalPath}catch(t){var n=errorMessage(t);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() called with invalid data. "+n)}}function errorMessage(e){return e instanceof Error?e.message:e.toString()}function validateSetOptions(e,t){return void 0===t?{merge:!1}:(validateOptionNames(e,t,["merge"]),validateNamedOptionalType(e,"boolean","merge",t.merge),t)}function validateReference(e,t,n){if(t instanceof DocumentReference){if(t.firestore!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}throw invalidClassError(e,"DocumentReference",1,t)}function changesFromSnapshot(e,t){if(t.oldDocs.isEmpty()){var n,r=0;return t.docChanges.map(function(o){var i=new DocumentSnapshot(e,o.doc.key,o.doc,t.fromCache);return assert$1(o.type===ChangeType.Added,"Invalid event type for first snapshot"),assert$1(!n||t.query.docComparator(n,o.doc)<0,"Got added events in wrong order"),n=o.doc,{type:"added",doc:i,oldIndex:-1,newIndex:r++}})}var o=t.oldDocs;return t.docChanges.map(function(n){var r=new DocumentSnapshot(e,n.doc.key,n.doc,t.fromCache),i=-1,a=-1;return n.type!==ChangeType.Added&&(assert$1((i=o.indexOf(n.doc.key))>=0,"Index for document not found"),o=o.delete(n.doc.key)),n.type!==ChangeType.Removed&&(a=(o=o.add(n.doc)).indexOf(n.doc.key)),{type:resultChangeType(n.type),doc:r,oldIndex:i,newIndex:a}})}function resultChangeType(e){switch(e){case ChangeType.Added:return"added";case ChangeType.Modified:case ChangeType.Metadata:return"modified";case ChangeType.Removed:return"removed";default:return fail("Unknown change type: "+e)}}function configureForFirebase(e){e.INTERNAL.registerService("firestore",function(e){return new Firestore(e)},shallowCopy(firestoreNamespace))}function registerFirestore(e){configureForFirebase(e)}var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},promise$2=createCommonjsModule(function(e){!function(t){function n(){}function r(e,t){return function(){e.apply(t,arguments)}}function o(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function i(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(e){return void s(t.promise,e)}a(t.promise,r)}else(1===e._state?a:s)(t.promise,e._value)})):e._deferreds.push(t)}function a(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof o)return e._state=3,e._value=t,void u(e);if("function"==typeof n)return void h(r(n,t),e)}e._state=1,e._value=t,u(e)}catch(t){s(e,t)}}function s(e,t){e._state=2,e._value=t,u(e)}function u(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)i(e,e._deferreds[t]);e._deferreds=null}function c(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function h(e,t){var n=!1;try{e(function(e){n||(n=!0,a(t,e))},function(e){n||(n=!0,s(t,e))})}catch(e){if(n)return;n=!0,s(t,e)}}var l=setTimeout;o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var r=new this.constructor(n);return i(this,new c(e,t,r)),r},o.all=function(e){var t=Array.prototype.slice.call(e);return new o(function(e,n){function r(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){r(i,e)},n)}t[i]=a,0==--o&&e(t)}catch(e){n(e)}}if(0===t.length)return e([]);for(var o=t.length,i=0;i<t.length;i++)r(i,t[i])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(e){return new o(function(t,n){n(e)})},o.race=function(e){return new o(function(t,n){for(var r=0,o=e.length;r<o;r++)e[r].then(t,n)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){l(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},o._setImmediateFn=function(e){o._immediateFn=e},o._setUnhandledRejectionFn=function(e){o._unhandledRejectionFn=e},e.exports?e.exports=o:t.Promise||(t.Promise=o)}(commonjsGlobal)}),__global=function(){if(void 0!==commonjsGlobal)return commonjsGlobal;if("undefined"!=typeof window)return window;if("undefined"!=typeof self)return self;throw new Error("unable to locate global object")}();"undefined"==typeof Promise&&(__global.Promise=Promise=promise$2),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return i;o++}}}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return o;o++}return-1}});var Deferred=function(){function e(){var e=this;this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})}return e.prototype.wrapCallback=function(e){var t=this;return function(n,r){n?t.reject(n):t.resolve(r),"function"==typeof e&&(t.promise.catch(function(){}),1===e.length?e(n):e(n,r))}},e}(),ERROR_NAME="FirebaseError",captureStackTrace=Error.captureStackTrace,FirebaseError=function(){return function(e,t){if(this.code=e,this.message=t,captureStackTrace)captureStackTrace(this,ErrorFactory.prototype.create);else{var n=Error.apply(this,arguments);this.name=ERROR_NAME,Object.defineProperty(this,"stack",{get:function(){return n.stack}})}}}();FirebaseError.prototype=Object.create(Error.prototype),FirebaseError.prototype.constructor=FirebaseError,FirebaseError.prototype.name=ERROR_NAME;var ErrorFactory=function(){function e(e,t,n){this.service=e,this.serviceName=t,this.errors=n,this.pattern=/\{\$([^}]+)}/g}return e.prototype.create=function(e,t){void 0===t&&(t={});var n,r=this.errors[e],o=this.service+"/"+e;n=void 0===r?"Error":r.replace(this.pattern,function(e,n){var r=t[n];return void 0!==r?r.toString():"<"+n+"?>"}),n=this.serviceName+": "+n+" ("+o+").";var i=new FirebaseError(o,n);for(var a in t)t.hasOwnProperty(a)&&"_"!==a.slice(-1)&&(i[a]=t[a]);return i},e}(),Hash=function(){return function(){this.blockSize=-1}}(),__extends=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Sha1=function(e){function t(){var t=e.call(this)||this;t.chain_=[],t.buf_=[],t.W_=[],t.pad_=[],t.inbuf_=0,t.total_=0,t.blockSize=64,t.pad_[0]=128;for(var n=1;n<t.blockSize;++n)t.pad_[n]=0;return t.reset(),t}return __extends(t,e),t.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},t.prototype.compress_=function(e,t){t||(t=0);var n=this.W_;if("string"==typeof e)for(h=0;h<16;h++)n[h]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(h=0;h<16;h++)n[h]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(h=16;h<80;h++){l=n[h-3]^n[h-8]^n[h-14]^n[h-16];n[h]=4294967295&(l<<1|l>>>31)}for(var r,o,i=this.chain_[0],a=this.chain_[1],s=this.chain_[2],u=this.chain_[3],c=this.chain_[4],h=0;h<80;h++){h<40?h<20?(r=u^a&(s^u),o=1518500249):(r=a^s^u,o=1859775393):h<60?(r=a&s|u&(a|s),o=2400959708):(r=a^s^u,o=3395469782);var l=(i<<5|i>>>27)+r+c+o+n[h]&4294967295;c=u,u=s,s=4294967295&(a<<30|a>>>2),a=i,i=l}this.chain_[0]=this.chain_[0]+i&4294967295,this.chain_[1]=this.chain_[1]+a&4294967295,this.chain_[2]=this.chain_[2]+s&4294967295,this.chain_[3]=this.chain_[3]+u&4294967295,this.chain_[4]=this.chain_[4]+c&4294967295},t.prototype.update=function(e,t){if(null!=e){void 0===t&&(t=e.length);for(var n=t-this.blockSize,r=0,o=this.buf_,i=this.inbuf_;r<t;){if(0==i)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if("string"==typeof e){for(;r<t;)if(o[i]=e.charCodeAt(r),++i,++r,i==this.blockSize){this.compress_(o),i=0;break}}else for(;r<t;)if(o[i]=e[r],++i,++r,i==this.blockSize){this.compress_(o),i=0;break}}this.inbuf_=i,this.total_+=t}},t.prototype.digest=function(){var e=[],t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(r=this.blockSize-1;r>=56;r--)this.buf_[r]=255&t,t/=256;this.compress_(this.buf_);for(var n=0,r=0;r<5;r++)for(var o=24;o>=0;o-=8)e[n]=this.chain_[r]>>o&255,++n;return e},t}(Hash),ObserverProxy=function(){function e(e,t){var n=this;this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(function(){e(n)}).catch(function(e){n.error(e)})}return e.prototype.next=function(e){this.forEachObserver(function(t){t.next(e)})},e.prototype.error=function(e){this.forEachObserver(function(t){t.error(e)}),this.close(e)},e.prototype.complete=function(){this.forEachObserver(function(e){e.complete()}),this.close()},e.prototype.subscribe=function(e,t,n){var r,o=this;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");void 0===(r=implementsAnyMethods(e,["next","error","complete"])?e:{next:e,error:t,complete:n}).next&&(r.next=noop),void 0===r.error&&(r.error=noop),void 0===r.complete&&(r.complete=noop);var i=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(function(){try{o.finalError?r.error(o.finalError):r.complete()}catch(e){}}),this.observers.push(r),i},e.prototype.unsubscribeOne=function(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))},e.prototype.forEachObserver=function(e){if(!this.finalized)for(var t=0;t<this.observers.length;t++)this.sendOne(t,e)},e.prototype.sendOne=function(e,t){var n=this;this.task.then(function(){if(void 0!==n.observers&&void 0!==n.observers[e])try{t(n.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})},e.prototype.close=function(e){var t=this;this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(function(){t.observers=void 0,t.onNoObservers=void 0}))},e}(),contains=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},DEFAULT_ENTRY_NAME="[DEFAULT]",tokenListeners=[],FirebaseAppImpl=function(){function e(e,t,n){this.firebase_=n,this.isDeleted_=!1,this.services_={},this.name_=t,this.options_=deepCopy(e),this.INTERNAL={getUid:function(){return null},getToken:function(){return Promise.resolve(null)},addAuthTokenListener:function(e){tokenListeners.push(e),setTimeout(function(){return e(null)},0)},removeAuthTokenListener:function(e){tokenListeners=tokenListeners.filter(function(t){return t!==e})}}}return Object.defineProperty(e.prototype,"name",{get:function(){return this.checkDestroyed_(),this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"options",{get:function(){return this.checkDestroyed_(),this.options_},enumerable:!0,configurable:!0}),e.prototype.delete=function(){var e=this;return new Promise(function(t){e.checkDestroyed_(),t()}).then(function(){e.firebase_.INTERNAL.removeApp(e.name_);var t=[];return Object.keys(e.services_).forEach(function(n){Object.keys(e.services_[n]).forEach(function(r){t.push(e.services_[n][r])})}),Promise.all(t.map(function(e){return e.INTERNAL.delete()}))}).then(function(){e.isDeleted_=!0,e.services_={}})},e.prototype._getService=function(e,t){if(void 0===t&&(t=DEFAULT_ENTRY_NAME),this.checkDestroyed_(),this.services_[e]||(this.services_[e]={}),!this.services_[e][t]){var n=t!==DEFAULT_ENTRY_NAME?t:void 0,r=this.firebase_.INTERNAL.factories[e](this,this.extendApp.bind(this),n);this.services_[e][t]=r}return this.services_[e][t]},e.prototype.extendApp=function(e){var t=this;deepExtend(this,e),e.INTERNAL&&e.INTERNAL.addAuthTokenListener&&(tokenListeners.forEach(function(e){t.INTERNAL.addAuthTokenListener(e)}),tokenListeners=[])},e.prototype.checkDestroyed_=function(){this.isDeleted_&&error("app-deleted",{name:this.name_})},e}();FirebaseAppImpl.prototype.name&&FirebaseAppImpl.prototype.options||FirebaseAppImpl.prototype.delete||console.log("dc");var errors={"no-app":"No Firebase App '{$name}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$name}","duplicate-app":"Firebase App named '{$name}' already exists","app-deleted":"Firebase App named '{$name}' already deleted","duplicate-service":"Firebase service named '{$name}' already registered","sa-not-supported":"Initializing the Firebase SDK with a service account is only allowed in a Node.js environment. On client devices, you should instead initialize the SDK with an api key and auth domain","invalid-app-argument":"firebase.{$name}() takes either no argument or a Firebase App instance."},appErrors=new ErrorFactory("app","Firebase",errors),firebase$1=createFirebaseNamespace(),esm=Object.freeze({firebase:firebase$1,default:firebase$1}),require$$1=esm&&firebase$1||esm,app=require$$1.default,SDK_VERSION=firebase$1.SDK_VERSION,LogLevel;!function(e){e[e.DEBUG=0]="DEBUG",e[e.ERROR=1]="ERROR",e[e.SILENT=2]="SILENT"}(LogLevel=LogLevel||(LogLevel={}));var logLevel=LogLevel.ERROR,PlatformSupport=function(){function e(){}return e.setPlatform=function(t){e.platform&&fail("Platform already defined"),e.platform=t},e.getPlatform=function(){return e.platform||fail("Platform not set"),e.platform},e}(),__extends$1=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Code={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},FirestoreError=function(e){function t(t,n){var r=e.call(this,n)||this;return r.code=t,r.message=n,r.name="FirebaseError",r.toString=function(){return r.name+": [code="+r.code+"]: "+r.message},r}return __extends$1(t,e),t}(Error),AutoId=function(){function e(){}return e.newId=function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;n<20;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return assert$1(20===t.length,"Invalid auto ID: "+t),t},e}(),Blob=function(){function e(e){assertBase64Available(),this._binaryString=e}return e.fromBase64String=function(t){validateExactNumberOfArgs("Blob.fromBase64String",arguments,1),validateArgType("Blob.fromBase64String","string",1,t),assertBase64Available();try{return new e(PlatformSupport.getPlatform().atob(t))}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+e)}},e.fromUint8Array=function(t){if(validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1),assertUint8ArrayAvailable(),!(t instanceof Uint8Array))throw invalidClassError("Blob.fromUint8Array","Uint8Array",1,t);return new e(Array.prototype.map.call(t,function(e){return String.fromCharCode(e)}).join(""))},e.prototype.toBase64=function(){return validateExactNumberOfArgs("Blob.toBase64",arguments,0),assertBase64Available(),PlatformSupport.getPlatform().btoa(this._binaryString)},e.prototype.toUint8Array=function(){validateExactNumberOfArgs("Blob.toUint8Array",arguments,0),assertUint8ArrayAvailable();for(var e=new Uint8Array(this._binaryString.length),t=0;t<this._binaryString.length;t++)e[t]=this._binaryString.charCodeAt(t);return e},e.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},e.prototype._equals=function(e){return this._binaryString===e._binaryString},e.prototype._compareTo=function(e){return primitiveComparator(this._binaryString,e._binaryString)},e}(),PublicBlob=makeConstructorPrivate(Blob,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),GeoPoint=function(){function e(e,t){if(validateExactNumberOfArgs("GeoPoint",arguments,2),validateArgType("GeoPoint","number",1,e),validateArgType("GeoPoint","number",2,t),!isFinite(e)||e<-90||e>90)throw new FirestoreError(Code.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new FirestoreError(Code.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}return Object.defineProperty(e.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),e.prototype._equals=function(e){return this._lat===e._lat&&this._long===e._long},e.prototype._compareTo=function(e){return primitiveComparator(this._lat,e._lat)||primitiveComparator(this._long,e._long)},e}(),DatabaseInfo=function(){return function(e,t,n,r){this.databaseId=e,this.persistenceKey=t,this.host=n,this.ssl=r}}(),DEFAULT_DATABASE_NAME="(default)",DatabaseId=function(){function e(e,t){this.projectId=e,this.database=t||DEFAULT_DATABASE_NAME}return Object.defineProperty(e.prototype,"isDefaultDatabase",{get:function(){return this.database===DEFAULT_DATABASE_NAME},enumerable:!0,configurable:!0}),e.prototype.equals=function(t){return t instanceof e&&t.projectId===this.projectId&&t.database===this.database},e.prototype.compareTo=function(e){return primitiveComparator(this.projectId,e.projectId)||primitiveComparator(this.database,e.database)},e}(),__extends$2=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),DOCUMENT_KEY_NAME="__name__",Path=function(){function e(e,t,n){this.init(e,t,n)}return e.prototype.init=function(e,t,n){void 0===t?t=0:t>e.length&&fail("offset "+t+" out of range "+e.length),void 0===n?n=e.length-t:n>e.length-t&&fail("length "+n+" out of range "+(e.length-t)),this.segments=e,this.offset=t,this.len=n},e.prototype.construct=function(e,t,n){var r=Object.create(Object.getPrototypeOf(this));return r.init(e,t,n),r},Object.defineProperty(e.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),e.prototype.equals=function(t){return 0===e.comparator(this,t)},e.prototype.child=function(t){var n=this.segments.slice(this.offset,this.limit());return t instanceof e?t.forEach(function(e){n.push(e)}):"string"==typeof t?n.push(t):fail("Unknown parameter type for Path.child(): "+t),this.construct(n)},e.prototype.limit=function(){return this.offset+this.length},e.prototype.popFirst=function(e){return e=void 0===e?1:e,assert$1(this.length>=e,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+e,this.length-e)},e.prototype.popLast=function(){return assert$1(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},e.prototype.firstSegment=function(){return assert$1(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},e.prototype.lastSegment=function(){return assert$1(!this.isEmpty(),"Can't call lastSegment() on empty path"),this.segments[this.limit()-1]},e.prototype.get=function(e){return assert$1(e<this.length,"Index out of range"),this.segments[this.offset+e]},e.prototype.isEmpty=function(){return 0===this.length},e.prototype.isPrefixOf=function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0},e.prototype.forEach=function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])},e.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},e.comparator=function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var o=e.get(r),i=t.get(r);if(o<i)return-1;if(o>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0},e}(),ResourcePath=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$2(t,e),t.prototype.canonicalString=function(){return this.toArray().join("/")},t.prototype.toString=function(){return this.canonicalString()},t.fromString=function(e){if(e.indexOf("//")>=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid path ("+e+"). Paths must not contain // in them.");return new t(e.split("/").filter(function(e){return e.length>0}))},t.EMPTY_PATH=new t([]),t}(Path),identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,FieldPath=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$2(t,e),t.isValidIdentifier=function(e){return identifierRegExp.test(e)},t.prototype.canonicalString=function(){return this.toArray().map(function(e){return e=e.replace("\\","\\\\").replace("`","\\`"),t.isValidIdentifier(e)||(e="`"+e+"`"),e}).join(".")},t.prototype.toString=function(){return this.canonicalString()},t.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===DOCUMENT_KEY_NAME},t.keyField=function(){return new t([DOCUMENT_KEY_NAME])},t.fromServerFormat=function(e){for(var n=[],r="",o=0,i=function(){if(0===r.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+e+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");n.push(r),r=""},a=!1;o<e.length;){var s=e[o];if("\\"===s){if(o+1===e.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var u=e[o+1];if("\\"!==u&&"."!==u&&"`"!==u)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,o+=2}else"`"===s?(a=!a,o++):"."!==s||a?(r+=s,o++):(i(),o++)}if(i(),a)throw new FirestoreError(Code.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new t(n)},t.EMPTY_PATH=new t([]),t}(Path),DocumentKey=function(){function e(t){this.path=t,assert$1(e.isDocumentKey(t),"Invalid DocumentKey with an odd number of segments: "+t.toArray().join("/"))}return e.prototype.equals=function(e){return null!==e&&0===ResourcePath.comparator(this.path,e.path)},e.prototype.toString=function(){return this.path.toString()},e.comparator=function(e,t){return ResourcePath.comparator(e.path,t.path)},e.isDocumentKey=function(e){return e.length%2==0},e.fromSegments=function(t){return new e(new ResourcePath(t.slice()))},e.fromPathString=function(t){return new e(ResourcePath.fromString(t))},e.EMPTY=new e(new ResourcePath([])),e}(),Document=function(){function e(e,t,n,r){this.key=e,this.version=t,this.data=n,this.hasLocalMutations=r.hasLocalMutations}return e.prototype.field=function(e){return this.data.field(e)},e.prototype.fieldValue=function(e){var t=this.field(e);return t?t.value():void 0},e.prototype.value=function(){return this.data.value()},e.prototype.equals=function(t){return t instanceof e&&this.key.equals(t.key)&&this.version.equals(t.version)&&this.data.equals(t.data)&&this.hasLocalMutations===t.hasLocalMutations},e.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"})"},e.compareByKey=function(e,t){return DocumentKey.comparator(e.key,t.key)},e.compareByField=function(e,t,n){var r=t.field(e),o=n.field(e);return void 0!==r&&void 0!==o?r.compareTo(o):fail("Trying to compare documents on fields that don't exist")},e}(),NoDocument=function(){function e(e,t){this.key=e,this.version=t}return e.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},e.prototype.equals=function(e){return e&&e.version.equals(this.version)&&e.key.equals(this.key)},e.compareByKey=function(e,t){return DocumentKey.comparator(e.key,t.key)},e}(),SortedMap=function(){function e(e,t){this.comparator=e,this.root=t||LLRBNode.EMPTY}return e.prototype.insert=function(t,n){return new e(this.comparator,this.root.insert(t,n,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))},e.prototype.remove=function(t){return new e(this.comparator,this.root.remove(t,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))},e.prototype.get=function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null},e.prototype.getPredecessorKey=function(e){for(var t=this.root,n=null;!t.isEmpty();){var r=this.comparator(e,t.key);if(0===r){if(t.left.isEmpty())return n?n.key:null;for(t=t.left;!t.right.isEmpty();)t=t.right;return t.key}r<0?t=t.left:r>0&&(n=t,t=t.right)}throw fail("Attempted to find predecessor key for a nonexistent key.  What gives?")},e.prototype.indexOf=function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1},e.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(e.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),e.prototype.minKey=function(){return this.root.minKey()},e.prototype.maxKey=function(){return this.root.maxKey()},e.prototype.inorderTraversal=function(e){return this.root.inorderTraversal(e)},e.prototype.forEach=function(e){this.inorderTraversal(function(t,n){return e(t,n),!1})},e.prototype.reverseTraversal=function(e){return this.root.reverseTraversal(e)},e.prototype.getIterator=function(e){return new SortedMapIterator(this.root,null,this.comparator,!1,e)},e.prototype.getIteratorFrom=function(e,t){return new SortedMapIterator(this.root,e,this.comparator,!1,t)},e.prototype.getReverseIterator=function(e){return new SortedMapIterator(this.root,null,this.comparator,!0,e)},e.prototype.getReverseIteratorFrom=function(e,t){return new SortedMapIterator(this.root,e,this.comparator,!0,t)},e}(),SortedMapIterator=function(){function e(e,t,n,r,o){this.resultGenerator=o||null,this.isReverse=r,this.nodeStack=[];for(var i=1;!e.isEmpty();)if(i=t?n(e.key,t):1,r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}return e.prototype.getNext=function(){assert$1(this.nodeStack.length>0,"getNext() called on iterator when hasNext() is false.");var e,t=this.nodeStack.pop();if(e=this.resultGenerator?this.resultGenerator(t.key,t.value):{key:t.key,value:t.value},this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e},e.prototype.hasNext=function(){return this.nodeStack.length>0},e.prototype.peek=function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return this.resultGenerator?this.resultGenerator(e.key,e.value):{key:e.key,value:e.value}},e}(),LLRBNode=function(){function e(t,n,r,o,i){this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=o?o:e.EMPTY,this.right=null!=i?i:e.EMPTY,this.size=this.left.size+1+this.right.size}return e.prototype.copy=function(t,n,r,o,i){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=o?o:this.left,null!=i?i:this.right)},e.prototype.isEmpty=function(){return!1},e.prototype.inorderTraversal=function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)},e.prototype.reverseTraversal=function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)},e.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},e.prototype.minKey=function(){return this.min().key},e.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},e.prototype.insert=function(e,t,n){var r=this,o=n(e,r.key);return(r=o<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===o?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()},e.prototype.removeMin=function(){if(this.left.isEmpty())return e.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()},e.prototype.remove=function(t,n){var r,o=this;if(n(t,o.key)<0)o.left.isEmpty()||o.left.isRed()||o.left.left.isRed()||(o=o.moveRedLeft()),o=o.copy(null,null,null,o.left.remove(t,n),null);else{if(o.left.isRed()&&(o=o.rotateRight()),o.right.isEmpty()||o.right.isRed()||o.right.left.isRed()||(o=o.moveRedRight()),0===n(t,o.key)){if(o.right.isEmpty())return e.EMPTY;r=o.right.min(),o=o.copy(r.key,r.value,null,null,o.right.removeMin())}o=o.copy(null,null,null,null,o.right.remove(t,n))}return o.fixUp()},e.prototype.isRed=function(){return this.color},e.prototype.fixUp=function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e},e.prototype.moveRedLeft=function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e},e.prototype.moveRedRight=function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e},e.prototype.rotateLeft=function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},e.prototype.rotateRight=function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},e.prototype.colorFlip=function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)},e.prototype.checkMaxDepth=function(){var e=this.check();return Math.pow(2,e)<=this.size+1},e.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw fail("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw fail("Right child of ("+this.key+","+this.value+") is red");var e=this.left.check();if(e!==this.right.check())throw fail("Black depths differ");return e+(this.isRed()?0:1)},e.EMPTY=null,e.RED=!0,e.BLACK=!1,e}(),LLRBEmptyNode=function(){function e(){this.size=0}return e.prototype.copy=function(e,t,n,r,o){return this},e.prototype.insert=function(e,t,n){return new LLRBNode(e,t)},e.prototype.remove=function(e,t){return this},e.prototype.isEmpty=function(){return!0},e.prototype.inorderTraversal=function(e){return!1},e.prototype.reverseTraversal=function(e){return!1},e.prototype.minKey=function(){return null},e.prototype.maxKey=function(){return null},e.prototype.isRed=function(){return!1},e.prototype.checkMaxDepth=function(){return!0},e.prototype.check=function(){return 0},e}();LLRBNode.EMPTY=new LLRBEmptyNode;var __extends$3=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),TypeOrder;!function(e){e[e.NullValue=0]="NullValue",e[e.BooleanValue=1]="BooleanValue",e[e.NumberValue=2]="NumberValue",e[e.TimestampValue=3]="TimestampValue",e[e.StringValue=4]="StringValue",e[e.BlobValue=5]="BlobValue",e[e.RefValue=6]="RefValue",e[e.GeoPointValue=7]="GeoPointValue",e[e.ArrayValue=8]="ArrayValue",e[e.ObjectValue=9]="ObjectValue"}(TypeOrder=TypeOrder||(TypeOrder={}));var FieldValue=function(){function e(){}return e.prototype.toString=function(){var e=this.value();return null===e?"null":e.toString()},e.prototype.defaultCompareTo=function(e){return assert$1(this.typeOrder!==e.typeOrder,"Default compareTo should not be used for values of same type."),primitiveComparator(this.typeOrder,e.typeOrder)},e}(),NullValue=function(e){function t(){var t=e.call(this)||this;return t.typeOrder=TypeOrder.NullValue,t.internalValue=null,t}return __extends$3(t,e),t.prototype.value=function(){return null},t.prototype.equals=function(e){return e instanceof t},t.prototype.compareTo=function(e){return e instanceof t?0:this.defaultCompareTo(e)},t.INSTANCE=new t,t}(FieldValue),BooleanValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.BooleanValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue},t.prototype.equals=function(e){return e instanceof t&&this.internalValue===e.internalValue},t.prototype.compareTo=function(e){return e instanceof t?primitiveComparator(this,e):this.defaultCompareTo(e)},t.of=function(e){return e?t.TRUE:t.FALSE},t.TRUE=new t(!0),t.FALSE=new t(!1),t}(FieldValue),NumberValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.NumberValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue},t.prototype.compareTo=function(e){return e instanceof t?numericComparator(this.internalValue,e.internalValue):this.defaultCompareTo(e)},t}(FieldValue),IntegerValue=function(e){function t(t){return e.call(this,t)||this}return __extends$3(t,e),t.prototype.equals=function(e){return e instanceof t&&numericEquals(this.internalValue,e.internalValue)},t}(NumberValue),DoubleValue=function(e){function t(t){var n=e.call(this,t)||this;return n.internalValue=t,n}return __extends$3(t,e),t.prototype.equals=function(e){return e instanceof t&&numericEquals(this.internalValue,e.internalValue)},t.NAN=new t(NaN),t.POSITIVE_INFINITY=new t(1/0),t.NEGATIVE_INFINITY=new t(-1/0),t}(NumberValue),StringValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.StringValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue},t.prototype.equals=function(e){return e instanceof t&&this.internalValue===e.internalValue},t.prototype.compareTo=function(e){return e instanceof t?primitiveComparator(this.internalValue,e.internalValue):this.defaultCompareTo(e)},t}(FieldValue),TimestampValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.TimestampValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue.toDate()},t.prototype.equals=function(e){return e instanceof t&&this.internalValue.equals(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue.compareTo(e.internalValue):e instanceof ServerTimestampValue?-1:this.defaultCompareTo(e)},t}(FieldValue),ServerTimestampValue=function(e){function t(t){var n=e.call(this)||this;return n.localWriteTime=t,n.typeOrder=TypeOrder.TimestampValue,n}return __extends$3(t,e),t.prototype.value=function(){return null},t.prototype.equals=function(e){return e instanceof t&&this.localWriteTime.equals(e.localWriteTime)},t.prototype.compareTo=function(e){return e instanceof t?this.localWriteTime.compareTo(e.localWriteTime):e instanceof TimestampValue?1:this.defaultCompareTo(e)},t.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},t}(FieldValue),BlobValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.BlobValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue},t.prototype.equals=function(e){return e instanceof t&&this.internalValue._equals(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},t}(FieldValue),RefValue=function(e){function t(t,n){var r=e.call(this)||this;return r.databaseId=t,r.key=n,r.typeOrder=TypeOrder.RefValue,r}return __extends$3(t,e),t.prototype.value=function(){return this.key},t.prototype.equals=function(e){return e instanceof t&&(this.key.equals(e.key)&&this.databaseId.equals(e.databaseId))},t.prototype.compareTo=function(e){if(e instanceof t){var n=this.databaseId.compareTo(e.databaseId);return 0!==n?n:DocumentKey.comparator(this.key,e.key)}return this.defaultCompareTo(e)},t}(FieldValue),GeoPointValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.GeoPointValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue},t.prototype.equals=function(e){return e instanceof t&&this.internalValue._equals(e.internalValue)},t.prototype.compareTo=function(e){return e instanceof t?this.internalValue._compareTo(e.internalValue):this.defaultCompareTo(e)},t}(FieldValue),ObjectValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.ObjectValue,n}return __extends$3(t,e),t.prototype.value=function(){var e={};return this.internalValue.inorderTraversal(function(t,n){e[t]=n.value()}),e},t.prototype.forEach=function(e){this.internalValue.inorderTraversal(e)},t.prototype.equals=function(e){if(e instanceof t){for(var n=this.internalValue.getIterator(),r=e.internalValue.getIterator();n.hasNext()&&r.hasNext();){var o=n.getNext(),i=r.getNext();if(o.key!==i.key||!o.value.equals(i.value))return!1}return!n.hasNext()&&!r.hasNext()}return!1},t.prototype.compareTo=function(e){if(e instanceof t){for(var n=this.internalValue.getIterator(),r=e.internalValue.getIterator();n.hasNext()&&r.hasNext();){var o=n.getNext(),i=r.getNext(),a=primitiveComparator(o.key,i.key)||o.value.compareTo(i.value);if(a)return a}return primitiveComparator(n.hasNext(),r.hasNext())}return this.defaultCompareTo(e)},t.prototype.set=function(e,n){if(assert$1(!e.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===e.length)return this.setChild(e.firstSegment(),n);var r=this.child(e.firstSegment());r instanceof t||(r=t.EMPTY);var o=r.set(e.popFirst(),n);return this.setChild(e.firstSegment(),o)},t.prototype.delete=function(e){if(assert$1(!e.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===e.length)return new t(this.internalValue.remove(e.firstSegment()));var n=this.child(e.firstSegment());if(n instanceof t){var r=n.delete(e.popFirst());return new t(this.internalValue.insert(e.firstSegment(),r))}return this},t.prototype.contains=function(e){return void 0!==this.field(e)},t.prototype.field=function(e){assert$1(!e.isEmpty(),"Can't get field of empty path");var n=this;return e.forEach(function(e){n=n instanceof t?n.internalValue.get(e)||void 0:void 0}),n},t.prototype.toString=function(){return JSON.stringify(this.value())},t.prototype.child=function(e){return this.internalValue.get(e)||void 0},t.prototype.setChild=function(e,n){return new t(this.internalValue.insert(e,n))},t.EMPTY=new t(new SortedMap(primitiveComparator)),t}(FieldValue),ArrayValue=function(e){function t(t){var n=e.call(this)||this;return n.internalValue=t,n.typeOrder=TypeOrder.ArrayValue,n}return __extends$3(t,e),t.prototype.value=function(){return this.internalValue.map(function(e){return e.value()})},t.prototype.forEach=function(e){this.internalValue.forEach(e)},t.prototype.equals=function(e){if(e instanceof t){if(this.internalValue.length!==e.internalValue.length)return!1;for(var n=0;n<this.internalValue.length;n++)if(!this.internalValue[n].equals(e.internalValue[n]))return!1;return!0}return!1},t.prototype.compareTo=function(e){if(e instanceof t){for(var n=Math.min(this.internalValue.length,e.internalValue.length),r=0;r<n;r++){var o=this.internalValue[r].compareTo(e.internalValue[r]);if(o)return o}return primitiveComparator(this.internalValue.length,e.internalValue.length)}return this.defaultCompareTo(e)},t.prototype.toString=function(){return JSON.stringify(this.value())},t}(FieldValue),NumberAsAny=Number,MIN_SAFE_INTEGER=NumberAsAny.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),MAX_SAFE_INTEGER=NumberAsAny.MAX_SAFE_INTEGER||Math.pow(2,53)-1,isInteger=NumberAsAny.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},Query=function(){function e(e,t,n,r,o,i){void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===r&&(r=null),void 0===o&&(o=null),void 0===i&&(i=null),this.path=e,this.explicitOrderBy=t,this.filters=n,this.limit=r,this.startAt=o,this.endAt=i,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return e.atPath=function(t){return new e(t)},Object.defineProperty(e.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var e=this.getInequalityFilterField(),t=this.getFirstOrderByField();if(null!==e&&null===t)e.isKeyField()?this.memoizedOrderBy=[KEY_ORDERING_ASC]:this.memoizedOrderBy=[new OrderBy(e),KEY_ORDERING_ASC];else{assert$1(null===e||null!==t&&e.equals(t),"First orderBy should match inequality field."),this.memoizedOrderBy=[];for(var n=!1,r=0,o=this.explicitOrderBy;r<o.length;r++){var i=o[r];this.memoizedOrderBy.push(i),i.field.isKeyField()&&(n=!0)}if(!n){var a=this.explicitOrderBy.length>0?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Direction.ASCENDING;this.memoizedOrderBy.push(a===Direction.ASCENDING?KEY_ORDERING_ASC:KEY_ORDERING_DESC)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),e.prototype.addFilter=function(t){assert$1(null==this.getInequalityFilterField()||!(t instanceof RelationFilter)||!t.isInequality()||t.field.equals(this.getInequalityFilterField()),"Query must only have one inequality field."),assert$1(!DocumentKey.isDocumentKey(this.path),"No filtering allowed for document query");var n=this.filters.concat([t]);return new e(this.path,this.explicitOrderBy.slice(),n,this.limit,this.startAt,this.endAt)},e.prototype.addOrderBy=function(t){assert$1(!DocumentKey.isDocumentKey(this.path),"No ordering allowed for document query"),assert$1(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var n=this.explicitOrderBy.concat([t]);return new e(this.path,n,this.filters.slice(),this.limit,this.startAt,this.endAt)},e.prototype.withLimit=function(t){return new e(this.path,this.explicitOrderBy.slice(),this.filters.slice(),t,this.startAt,this.endAt)},e.prototype.withStartAt=function(t){return new e(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,t,this.endAt)},e.prototype.withEndAt=function(t){return new e(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,t)},e.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var e=this.path.canonicalString();e+="|f:";for(var t=0,n=this.filters;t<n.length;t++)e+=n[t].canonicalId(),e+=",";e+="|ob:";for(var r=0,o=this.orderBy;r<o.length;r++)e+=o[r].canonicalId(),e+=",";isNullOrUndefined(this.limit)||(e+="|l:",e+=this.limit),this.startAt&&(e+="|lb:",e+=this.startAt.canonicalId()),this.endAt&&(e+="|ub:",e+=this.endAt.canonicalId()),this.memoizedCanonicalId=e}return this.memoizedCanonicalId},e.prototype.toString=function(){var e="Query("+this.path.canonicalString();return this.filters.length>0&&(e+=", filters: ["+this.filters.join(", ")+"]"),isNullOrUndefined(this.limit)||(e+=", limit: "+this.limit),this.explicitOrderBy.length>0&&(e+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(e+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(e+=", endAt: "+this.endAt.canonicalId()),e+")"},e.prototype.equals=function(e){if(this.limit!==e.limit)return!1;if(this.orderBy.length!==e.orderBy.length)return!1;for(t=0;t<this.orderBy.length;t++)if(!this.orderBy[t].equals(e.orderBy[t]))return!1;if(this.filters.length!==e.filters.length)return!1;for(var t=0;t<this.filters.length;t++)if(!this.filters[t].equals(e.filters[t]))return!1;return!!this.path.equals(e.path)&&(!(null!==this.startAt?!this.startAt.equals(e.startAt):null!==e.startAt)&&(null!==this.endAt?this.endAt.equals(e.endAt):null===e.endAt))},e.prototype.docComparator=function(e,t){for(var n=!1,r=0,o=this.orderBy;r<o.length;r++){var i=o[r],a=i.compare(e,t);if(0!==a)return a;n=n||i.field.isKeyField()}return assert$1(n,"orderBy used that doesn't compare on key field"),0},e.prototype.matches=function(e){return this.matchesAncestor(e)&&this.matchesOrderBy(e)&&this.matchesFilters(e)&&this.matchesBounds(e)},e.prototype.hasLimit=function(){return!isNullOrUndefined(this.limit)},e.prototype.getFirstOrderByField=function(){return this.explicitOrderBy.length>0?this.explicitOrderBy[0].field:null},e.prototype.getInequalityFilterField=function(){for(var e=0,t=this.filters;e<t.length;e++){var n=t[e];if(n instanceof RelationFilter&&n.isInequality())return n.field}return null},e.prototype.isDocumentQuery=function(){return DocumentKey.isDocumentKey(this.path)&&0===this.filters.length},e.prototype.matchesAncestor=function(e){var t=e.key.path;return DocumentKey.isDocumentKey(this.path)?this.path.equals(t):this.path.isPrefixOf(t)&&this.path.length===t.length-1},e.prototype.matchesOrderBy=function(e){for(var t=0,n=this.explicitOrderBy;t<n.length;t++){var r=n[t];if(!r.field.isKeyField()&&void 0===e.field(r.field))return!1}return!0},e.prototype.matchesFilters=function(e){for(var t=0,n=this.filters;t<n.length;t++)if(!n[t].matches(e))return!1;return!0},e.prototype.matchesBounds=function(e){return!(this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,e))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,e))},e.prototype.assertValidBound=function(e){assert$1(e.position.length<=this.orderBy.length,"Bound is longer than orderBy")},e}(),RelationOp=function(){function e(e){this.name=e}return e.fromString=function(t){switch(t){case"<":return e.LESS_THAN;case"<=":return e.LESS_THAN_OR_EQUAL;case"==":return e.EQUAL;case">=":return e.GREATER_THAN_OR_EQUAL;case">":return e.GREATER_THAN;default:return fail("Unknown relation: "+t)}},e.prototype.toString=function(){return this.name},e.prototype.equals=function(e){return this.name===e.name},e.LESS_THAN=new e("<"),e.LESS_THAN_OR_EQUAL=new e("<="),e.EQUAL=new e("=="),e.GREATER_THAN=new e(">"),e.GREATER_THAN_OR_EQUAL=new e(">="),e}(),RelationFilter=function(){function e(e,t,n){this.field=e,this.op=t,this.value=n}return e.prototype.matches=function(e){if(this.field.isKeyField()){assert$1(this.value instanceof RefValue,"Comparing on key, but filter value not a RefValue");var t=this.value,n=DocumentKey.comparator(e.key,t.key);return this.matchesComparison(n)}var r=e.field(this.field);return void 0!==r&&this.matchesValue(r)},e.prototype.matchesValue=function(e){return this.value.typeOrder===e.typeOrder&&this.matchesComparison(e.compareTo(this.value))},e.prototype.matchesComparison=function(e){switch(this.op){case RelationOp.LESS_THAN:return e<0;case RelationOp.LESS_THAN_OR_EQUAL:return e<=0;case RelationOp.EQUAL:return 0===e;case RelationOp.GREATER_THAN:return e>0;case RelationOp.GREATER_THAN_OR_EQUAL:return e>=0;default:return fail("Unknown relation op"+this.op)}},e.prototype.isInequality=function(){return this.op!==RelationOp.EQUAL},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},e.prototype.equals=function(t){return t instanceof e&&(this.op.equals(t.op)&&this.field.equals(t.field)&&this.value.equals(t.value))},e.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},e}(),NullFilter=function(){function e(e){this.field=e}return e.prototype.matches=function(e){var t=e.field(this.field);return void 0!==t&&null===t.value()},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"},e.prototype.toString=function(){return this.field.canonicalString()+" IS null"},e.prototype.equals=function(t){return t instanceof e&&this.field.equals(t.field)},e}(),NanFilter=function(){function e(e){this.field=e}return e.prototype.matches=function(e){var t=e.field(this.field).value();return"number"==typeof t&&isNaN(t)},e.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"},e.prototype.equals=function(t){return t instanceof e&&this.field.equals(t.field)},e}(),Direction=function(){function e(e){this.name=e}return e.prototype.toString=function(){return this.name},e.ASCENDING=new e("asc"),e.DESCENDING=new e("desc"),e}(),Bound=function(){function e(e,t){this.position=e,this.before=t}return e.prototype.canonicalId=function(){for(var e=this.before?"b:":"a:",t=0,n=this.position;t<n.length;t++)e+=n[t].toString();return e},e.prototype.sortsBeforeDocument=function(e,t){assert$1(this.position.length<=e.length,"Bound has more components than query's orderBy");for(var n=0,r=0;r<this.position.length;r++){var o=e[r],i=this.position[r];if(o.field.isKeyField())assert$1(i instanceof RefValue,"Bound has a non-key value where the key path is being used."),n=DocumentKey.comparator(i.key,t.key);else{var a=t.field(o.field);assert$1(void 0!==a,"Field should exist since document matched the orderBy already."),n=i.compareTo(a)}if(o.dir===Direction.DESCENDING&&(n*=-1),0!==n)break}return this.before?n<=0:n<0},e.prototype.equals=function(e){if(null===e)return!1;if(this.before!==e.before||this.position.length!==e.position.length)return!1;for(var t=0;t<this.position.length;t++){var n=this.position[t],r=e.position[t];return n.equals(r)}return!0},e}(),OrderBy=function(){function e(e,t){this.field=e,void 0===t&&(t=Direction.ASCENDING),this.dir=t,this.isKeyOrderBy=e.isKeyField()}return e.prototype.compare=function(e,t){var n=this.isKeyOrderBy?Document.compareByKey(e,t):Document.compareByField(this.field,e,t);switch(this.dir){case Direction.ASCENDING:return n;case Direction.DESCENDING:return-1*n;default:return fail("Unknown direction: "+this.dir)}},e.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},e.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},e.prototype.equals=function(e){return this.dir===e.dir&&this.field.equals(e.field)},e}(),KEY_ORDERING_ASC=new OrderBy(FieldPath.keyField(),Direction.ASCENDING),KEY_ORDERING_DESC=new OrderBy(FieldPath.keyField(),Direction.DESCENDING),isoRegExp=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),Timestamp=function(){function e(e,t){this.seconds=e,this.nanos=t,assert$1(t>=0,"timestamp nanoseconds out of range: "+t),assert$1(t<1e9,"timestamp nanoseconds out of range"+t),assert$1(e>=-62135596800,"timestamp seconds out of range: "+e),assert$1(e<253402300800,"timestamp seconds out of range"+e)}return e.now=function(){return e.fromEpochMilliseconds(Date.now())},e.fromDate=function(t){return e.fromEpochMilliseconds(t.getTime())},e.fromEpochMilliseconds=function(t){var n=Math.floor(t/1e3);return new e(n,1e6*(t-1e3*n))},e.fromISOString=function(t){var n=0,r=isoRegExp.exec(t);if(assert$1(!!r,"invalid timestamp: "+t),r[1]){var o=r[1];o=(o+"000000000").substr(0,9),n=parseInt(o,10)}var i=new Date(t);return new e(Math.floor(i.getTime()/1e3),n)},e.prototype.toDate=function(){return new Date(this.toEpochMilliseconds())},e.prototype.toEpochMilliseconds=function(){return 1e3*this.seconds+this.nanos/1e6},e.prototype.compareTo=function(e){return this.seconds===e.seconds?primitiveComparator(this.nanos,e.nanos):primitiveComparator(this.seconds,e.seconds)},e.prototype.equals=function(e){return e.seconds===this.seconds&&e.nanos===this.nanos},e.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanos="+this.nanos+")"},e}(),SnapshotVersion=function(){function e(e){this.timestamp=e}return e.fromMicroseconds=function(t){var n=Math.floor(t/1e6);return new e(new Timestamp(n,t%1e6*1e3))},e.fromTimestamp=function(t){return new e(t)},e.forDeletedDoc=function(){return e.MIN},e.prototype.compareTo=function(e){return this.timestamp.compareTo(e.timestamp)},e.prototype.equals=function(e){return this.timestamp.equals(e.timestamp)},e.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanos/1e3},e.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},e.prototype.toTimestamp=function(){return this.timestamp},e.MIN=new e(new Timestamp(0,0)),e}(),QueryPurpose;!function(e){e[e.Listen=0]="Listen",e[e.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",e[e.LimboResolution=2]="LimboResolution"}(QueryPurpose=QueryPurpose||(QueryPurpose={}));var QueryData=function(){function e(e,t,n,r,o){void 0===r&&(r=SnapshotVersion.MIN),void 0===o&&(o=emptyByteString()),this.query=e,this.targetId=t,this.purpose=n,this.snapshotVersion=r,this.resumeToken=o}return e.prototype.update=function(t){return new e(this.query,this.targetId,this.purpose,t.snapshotVersion,t.resumeToken)},e.prototype.equals=function(e){return this.targetId===e.targetId&&this.purpose===e.purpose&&this.snapshotVersion.equals(e.snapshotVersion)&&this.resumeToken===e.resumeToken&&this.query.equals(e.query)},e}(),__extends$4=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),FieldMask=function(){function e(e){this.fields=e}return e.prototype.equals=function(e){return arrayEquals(this.fields,e.fields)},e}(),ServerTimestampTransform=function(){function e(){}return e.prototype.equals=function(t){return t instanceof e},e.instance=new e,e}(),FieldTransform=function(){function e(e,t){this.field=e,this.transform=t}return e.prototype.equals=function(e){return this.field.equals(e.field)&&this.transform.equals(e.transform)},e}(),MutationResult=function(){return function(e,t){this.version=e,this.transformResults=t}}(),MutationType;!function(e){e[e.Set=0]="Set",e[e.Patch=1]="Patch",e[e.Transform=2]="Transform",e[e.Delete=3]="Delete"}(MutationType=MutationType||(MutationType={}));var Precondition=function(){function e(e,t){this.updateTime=e,this.exists=t,assert$1(void 0===e||void 0===t,'Precondition can specify "exists" or "updateTime" but not both')}return e.exists=function(t){return new e(void 0,t)},e.updateTime=function(t){return new e(t)},Object.defineProperty(e.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),e.prototype.isValidFor=function(e){return void 0!==this.updateTime?e instanceof Document&&e.version.equals(this.updateTime):void 0!==this.exists?this.exists?e instanceof Document:null===e||e instanceof NoDocument:(assert$1(this.isNone,"Precondition should be empty"),!0)},e.prototype.equals=function(e){return equals(this.updateTime,e.updateTime)&&this.exists===e.exists},e.NONE=new e,e}(),Mutation=function(){function e(){}return e.prototype.verifyKeyMatches=function(e){null!=e&&assert$1(e.key.equals(this.key),"Can only apply a mutation to a document with the same key")},e.getPostMutationVersion=function(e){return e instanceof Document?e.version:SnapshotVersion.MIN},e}(),SetMutation=function(e){function t(t,n,r){var o=e.call(this)||this;return o.key=t,o.value=n,o.precondition=r,o.type=MutationType.Set,o}return __extends$4(t,e),t.prototype.applyToRemoteDocument=function(e,t){this.verifyKeyMatches(e),assert$1(null==t.transformResults,"Transform results received by SetMutation.");var n=Mutation.getPostMutationVersion(e);return new Document(this.key,n,this.value,{hasLocalMutations:!1})},t.prototype.applyToLocalView=function(e,t){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var n=Mutation.getPostMutationVersion(e);return new Document(this.key,n,this.value,{hasLocalMutations:!0})},t.prototype.equals=function(e){return e instanceof t&&this.key.equals(e.key)&&this.value.equals(e.value)&&this.precondition.equals(e.precondition)},t}(Mutation),PatchMutation=function(e){function t(t,n,r,o){var i=e.call(this)||this;return i.key=t,i.data=n,i.fieldMask=r,i.precondition=o,i.type=MutationType.Patch,i}return __extends$4(t,e),t.prototype.applyToRemoteDocument=function(e,t){if(this.verifyKeyMatches(e),assert$1(null==t.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(e))return e;var n=Mutation.getPostMutationVersion(e),r=this.patchDocument(e);return new Document(this.key,n,r,{hasLocalMutations:!1})},t.prototype.applyToLocalView=function(e,t){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var n=Mutation.getPostMutationVersion(e),r=this.patchDocument(e);return new Document(this.key,n,r,{hasLocalMutations:!0})},t.prototype.equals=function(e){return e instanceof t&&this.key.equals(e.key)&&this.fieldMask.equals(e.fieldMask)&&this.precondition.equals(e.precondition)},t.prototype.patchDocument=function(e){var t;return t=e instanceof Document?e.data:ObjectValue.EMPTY,this.patchObject(t)},t.prototype.patchObject=function(e){for(var t=0,n=this.fieldMask.fields;t<n.length;t++){var r=n[t],o=this.data.field(r);e=void 0!==o?e.set(r,o):e.delete(r)}return e},t}(Mutation),TransformMutation=function(e){function t(t,n){var r=e.call(this)||this;return r.key=t,r.fieldTransforms=n,r.type=MutationType.Transform,r.precondition=Precondition.exists(!0),r}return __extends$4(t,e),t.prototype.applyToRemoteDocument=function(e,t){this.verifyKeyMatches(e),assert$1(null!=t.transformResults,"Transform results missing for TransformMutation.");var n=t.transformResults;if(!this.precondition.isValidFor(e))return e;var r=this.requireDocument(e),o=this.transformObject(r.data,n);return new Document(this.key,r.version,o,{hasLocalMutations:!1})},t.prototype.applyToLocalView=function(e,t){if(this.verifyKeyMatches(e),!this.precondition.isValidFor(e))return e;var n=this.requireDocument(e),r=this.localTransformResults(t),o=this.transformObject(n.data,r);return new Document(this.key,n.version,o,{hasLocalMutations:!0})},t.prototype.equals=function(e){return e instanceof t&&this.key.equals(e.key)&&arrayEquals(this.fieldTransforms,e.fieldTransforms)&&this.precondition.equals(e.precondition)},t.prototype.requireDocument=function(e){assert$1(e instanceof Document,"Unknown MaybeDocument type "+e);var t=e;return assert$1(t.key.equals(this.key),"Can only transform a document with the same key"),t},t.prototype.localTransformResults=function(e){for(var t=[],n=0,r=this.fieldTransforms;n<r.length;n++){var o=r[n].transform;if(!(o instanceof ServerTimestampTransform))return fail("Encountered unknown transform: "+o);t.push(new ServerTimestampValue(e))}return t},t.prototype.transformObject=function(e,t){assert$1(t.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var n=0;n<this.fieldTransforms.length;n++){var r=this.fieldTransforms[n],o=r.transform,i=r.field;if(!(o instanceof ServerTimestampTransform))return fail("Encountered unknown transform: "+o);e=e.set(i,t[n])}return e},t}(Mutation),DeleteMutation=function(e){function t(t,n){var r=e.call(this)||this;return r.key=t,r.precondition=n,r.type=MutationType.Delete,r}return __extends$4(t,e),t.prototype.applyToRemoteDocument=function(e,t){return this.verifyKeyMatches(e),assert$1(null==t.transformResults,"Transform results received by DeleteMutation."),new NoDocument(this.key,SnapshotVersion.MIN)},t.prototype.applyToLocalView=function(e,t){return this.verifyKeyMatches(e),this.precondition.isValidFor(e)?(e&&assert$1(e.key.equals(this.key),"Can only apply mutation to document with same key"),new NoDocument(this.key,SnapshotVersion.forDeletedDoc())):e},t.prototype.equals=function(e){return e instanceof t&&this.key.equals(e.key)&&this.precondition.equals(e.precondition)},t}(Mutation),ExistenceFilter=function(){function e(e){this.count=e}return e.prototype.equals=function(e){return e&&e.count===this.count},e}(),RpcCode;!function(e){e[e.OK=0]="OK",e[e.CANCELLED=1]="CANCELLED",e[e.UNKNOWN=2]="UNKNOWN",e[e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",e[e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",e[e.NOT_FOUND=5]="NOT_FOUND",e[e.ALREADY_EXISTS=6]="ALREADY_EXISTS",e[e.PERMISSION_DENIED=7]="PERMISSION_DENIED",e[e.UNAUTHENTICATED=16]="UNAUTHENTICATED",e[e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",e[e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",e[e.ABORTED=10]="ABORTED",e[e.OUT_OF_RANGE=11]="OUT_OF_RANGE",e[e.UNIMPLEMENTED=12]="UNIMPLEMENTED",e[e.INTERNAL=13]="INTERNAL",e[e.UNAVAILABLE=14]="UNAVAILABLE",e[e.DATA_LOSS=15]="DATA_LOSS"}(RpcCode||(RpcCode={}));var SortedSet=function(){function e(e){this.comparator=e,this.data=new SortedMap(this.comparator)}return e.fromMapKeys=function(t){var n=new e(t.comparator);return t.forEach(function(e){n=n.add(e)}),n},e.prototype.has=function(e){return null!==this.data.get(e)},e.prototype.first=function(){return this.data.minKey()},e.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(e.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),e.prototype.indexOf=function(e){return this.data.indexOf(e)},e.prototype.forEach=function(e){this.data.inorderTraversal(function(t,n){return e(t),!1})},e.prototype.forEachInRange=function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}},e.prototype.forEachWhile=function(e,t){var n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return},e.prototype.firstAfterOrEqual=function(e){var t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null},e.prototype.add=function(e){return this.copy(this.data.remove(e).insert(e,!0))},e.prototype.delete=function(e){return this.has(e)?this.copy(this.data.remove(e)):this},e.prototype.isEmpty=function(){return this.data.isEmpty()},e.prototype.unionWith=function(e){var t=this;return e.forEach(function(e){t=t.add(e)}),t},e.prototype.equals=function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.data.getIterator(),r=t.data.getIterator();n.hasNext();){var o=n.getNext().key,i=r.getNext().key;if(0!==this.comparator(o,i))return!1}return!0},e.prototype.toString=function(){var e=[];return this.forEach(function(t){return e.push(t)}),"SortedSet("+e.toString()+")"},e.prototype.copy=function(t){var n=new e(this.comparator);return n.data=t,n},e}(),EMPTY_MAYBE_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator),EMPTY_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator),EMPTY_DOCUMENT_VERSION_MAP=new SortedMap(DocumentKey.comparator),EMPTY_DOCUMENT_KEY_SET=new SortedSet(DocumentKey.comparator),RemoteEvent=function(){function e(e,t,n){this.snapshotVersion=e,this.targetChanges=t,this.documentUpdates=n}return e.prototype.addDocumentUpdate=function(e){this.documentUpdates=this.documentUpdates.insert(e.key,e)},e.prototype.handleExistenceFilterMismatch=function(e){this.targetChanges[e]={mapping:new ResetMapping,snapshotVersion:SnapshotVersion.MIN,currentStatusUpdate:CurrentStatusUpdate.MarkNotCurrent,resumeToken:emptyByteString()}},e}(),CurrentStatusUpdate;!function(e){e[e.None=0]="None",e[e.MarkNotCurrent=1]="MarkNotCurrent",e[e.MarkCurrent=2]="MarkCurrent"}(CurrentStatusUpdate=CurrentStatusUpdate||(CurrentStatusUpdate={}));var EMPTY_KEY_SET=documentKeySet(),ResetMapping=function(){function e(){this.docs=EMPTY_KEY_SET}return Object.defineProperty(e.prototype,"documents",{get:function(){return this.docs},enumerable:!0,configurable:!0}),e.prototype.add=function(e){this.docs=this.docs.add(e)},e.prototype.delete=function(e){this.docs=this.docs.delete(e)},e.prototype.equals=function(e){return null!==e&&this.docs.equals(e.docs)},e}(),UpdateMapping=function(){function e(){this.addedDocuments=EMPTY_KEY_SET,this.removedDocuments=EMPTY_KEY_SET}return e.prototype.applyToKeySet=function(e){var t=e;return this.addedDocuments.forEach(function(e){return t=t.add(e)}),this.removedDocuments.forEach(function(e){return t=t.delete(e)}),t},e.prototype.add=function(e){this.addedDocuments=this.addedDocuments.add(e),this.removedDocuments=this.removedDocuments.delete(e)},e.prototype.delete=function(e){this.addedDocuments=this.addedDocuments.delete(e),this.removedDocuments=this.removedDocuments.add(e)},e.prototype.equals=function(e){return null!==e&&this.addedDocuments.equals(e.addedDocuments)&&this.removedDocuments.equals(e.removedDocuments)},e}(),DocumentWatchChange=function(){return function(e,t,n,r){this.updatedTargetIds=e,this.removedTargetIds=t,this.key=n,this.newDoc=r}}(),ExistenceFilterChange=function(){return function(e,t){this.targetId=e,this.existenceFilter=t}}(),WatchTargetChangeState;!function(e){e[e.NoChange=0]="NoChange",e[e.Added=1]="Added",e[e.Removed=2]="Removed",e[e.Current=3]="Current",e[e.Reset=4]="Reset"}(WatchTargetChangeState=WatchTargetChangeState||(WatchTargetChangeState={}));var WatchTargetChange=function(){return function(e,t,n,r){void 0===n&&(n=emptyByteString()),void 0===r&&(r=null),this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}(),WatchChangeAggregator=function(){function e(e,t,n){this.snapshotVersion=e,this.listenTargets=t,this.existenceFilters={},this.targetChanges={},this.documentUpdates=maybeDocumentMap(),this.frozen=!1,this.pendingTargetResponses=shallowCopy(n)}return e.prototype.add=function(e){assert$1(!this.frozen,"Trying to modify frozen WatchChangeAggregator."),e instanceof DocumentWatchChange?this.addDocumentChange(e):e instanceof WatchTargetChange?this.addTargetChange(e):e instanceof ExistenceFilterChange?this.addExistenceFilterChange(e):fail("Unknown watch change: "+e)},e.prototype.addChanges=function(e){var t=this;assert$1(!this.frozen,"Trying to modify frozen WatchChangeAggregator."),e.forEach(function(e){return t.add(e)})},e.prototype.createRemoteEvent=function(){var e=this,t=this.targetChanges;return forEachNumber(this.targetChanges,function(n){e.isActiveTarget(n)||delete t[n]}),this.frozen=!0,new RemoteEvent(this.snapshotVersion,t,this.documentUpdates)},e.prototype.ensureTargetChange=function(e){var t=this.targetChanges[e];return t||(t={currentStatusUpdate:CurrentStatusUpdate.None,snapshotVersion:this.snapshotVersion,mapping:new UpdateMapping,resumeToken:emptyByteString()},this.targetChanges[e]=t),t},e.prototype.isActiveTarget=function(e){return!contains$2(this.pendingTargetResponses,e)&&contains$2(this.listenTargets,e)},e.prototype.addDocumentChange=function(e){for(var t=!1,n=0,r=e.updatedTargetIds;n<r.length;n++){a=r[n];this.isActiveTarget(a)&&((s=this.ensureTargetChange(a)).mapping.add(e.key),t=!0)}for(var o=0,i=e.removedTargetIds;o<i.length;o++){var a=i[o];if(this.isActiveTarget(a)){var s=this.ensureTargetChange(a);s.mapping.delete(e.key),t=!0}}e.newDoc&&t&&(this.documentUpdates=this.documentUpdates.insert(e.key,e.newDoc))},e.prototype.addTargetChange=function(e){var t=this;e.targetIds.forEach(function(n){var r=t.ensureTargetChange(n);switch(e.state){case WatchTargetChangeState.NoChange:t.isActiveTarget(n)&&applyResumeToken(r,e.resumeToken);break;case WatchTargetChangeState.Added:t.recordTargetResponse(n),contains$2(t.pendingTargetResponses,n)||(r.mapping=new UpdateMapping,r.currentStatusUpdate=CurrentStatusUpdate.None,delete t.existenceFilters[n]),applyResumeToken(r,e.resumeToken);break;case WatchTargetChangeState.Removed:t.recordTargetResponse(n),assert$1(!e.cause,"WatchChangeAggregator does not handle errored targets");break;case WatchTargetChangeState.Current:t.isActiveTarget(n)&&(r.currentStatusUpdate=CurrentStatusUpdate.MarkCurrent,applyResumeToken(r,e.resumeToken));break;case WatchTargetChangeState.Reset:t.isActiveTarget(n)&&(r.mapping=new ResetMapping,applyResumeToken(r,e.resumeToken));break;default:fail("Unknown target watch change state: "+e.state)}})},e.prototype.recordTargetResponse=function(e){var t=(this.pendingTargetResponses[e]||0)-1;0===t?delete this.pendingTargetResponses[e]:this.pendingTargetResponses[e]=t},e.prototype.addExistenceFilterChange=function(e){this.isActiveTarget(e.targetId)&&(this.existenceFilters[e.targetId]=e.existenceFilter)},e}(),DIRECTIONS=function(){var e={};return e[Direction.ASCENDING.name]="ASCENDING",e[Direction.DESCENDING.name]="DESCENDING",e}(),OPERATORS=function(){var e={};return e[RelationOp.LESS_THAN.name]="LESS_THAN",e[RelationOp.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",e[RelationOp.GREATER_THAN.name]="GREATER_THAN",e[RelationOp.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",e[RelationOp.EQUAL.name]="EQUAL",e}(),JsonProtoSerializer=function(){function e(e,t){this.databaseId=e,this.options=t}return e.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},e.prototype.unsafeCastProtoByteString=function(e){return e},e.prototype.fromRpcStatus=function(e){var t=void 0===e.code?Code.UNKNOWN:mapCodeFromRpcCode(e.code);return new FirestoreError(t,e.message||"")},e.prototype.toTimestamp=function(e){return{seconds:e.seconds,nanos:e.nanos}},e.prototype.fromTimestamp=function(e){if("string"==typeof e)return Timestamp.fromISOString(e);assert$1(!!e,"Cannot deserialize null or undefined timestamp.");var t=parseInt64(e.seconds||"0"),n=e.nanos||0;return new Timestamp(t,n)},e.prototype.toBytes=function(e){return this.options.useProto3Json?e.toBase64():this.unsafeCastProtoByteString(e.toUint8Array())},e.prototype.fromBlob=function(e){return"string"==typeof e?(assert$1(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Blob.fromBase64String(e)):(assert$1(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead."),Blob.fromUint8Array(e))},e.prototype.toVersion=function(e){return this.toTimestamp(e.toTimestamp())},e.prototype.fromVersion=function(e){return assert$1(!!e,"Trying to deserialize version that isn't set"),SnapshotVersion.fromTimestamp(this.fromTimestamp(e))},e.prototype.toResourceName=function(e,t){return this.fullyQualifiedPrefixPath(e).child("documents").child(t).canonicalString()},e.prototype.fromResourceName=function(e){var t=ResourcePath.fromString(e);return assert$1(this.isValidResourceName(t),"Tried to deserialize invalid key "+t.toString()),t},e.prototype.toName=function(e){return this.toResourceName(this.databaseId,e.path)},e.prototype.fromName=function(e){var t=this.fromResourceName(e);return assert$1(t.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+t.get(1)+" vs "+this.databaseId.projectId),assert$1(!t.get(3)&&!this.databaseId.database||t.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+t.get(3)+" vs "+this.databaseId.database),new DocumentKey(this.extractLocalPathFromResourceName(t))},e.prototype.toQueryPath=function(e){return 0===e.length?this.encodedDatabaseId:this.toResourceName(this.databaseId,e)},e.prototype.fromQueryPath=function(e){var t=this.fromResourceName(e);return 4===t.length?ResourcePath.EMPTY_PATH:this.extractLocalPathFromResourceName(t)},Object.defineProperty(e.prototype,"encodedDatabaseId",{get:function(){return new ResourcePath(["projects",this.databaseId.projectId,"databases",this.databaseId.database]).canonicalString()},enumerable:!0,configurable:!0}),e.prototype.fullyQualifiedPrefixPath=function(e){return new ResourcePath(["projects",e.projectId,"databases",e.database])},e.prototype.extractLocalPathFromResourceName=function(e){return assert$1(e.length>4&&"documents"===e.get(4),"tried to deserialize invalid key "+e.toString()),e.popFirst(5)},e.prototype.isValidResourceName=function(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)},e.prototype.toValue=function(e){if(e instanceof NullValue)return{nullValue:"NULL_VALUE"};if(e instanceof BooleanValue)return{booleanValue:e.value()};if(e instanceof IntegerValue)return{integerValue:""+e.value()};if(e instanceof DoubleValue){var t=e.value();if(this.options.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:e.value()}}return e instanceof StringValue?{stringValue:e.value()}:e instanceof ObjectValue?{mapValue:this.toMapValue(e)}:e instanceof ArrayValue?{arrayValue:this.toArrayValue(e)}:e instanceof TimestampValue?{timestampValue:this.toTimestamp(e.internalValue)}:e instanceof GeoPointValue?{geoPointValue:{latitude:e.value().latitude,longitude:e.value().longitude}}:e instanceof BlobValue?{bytesValue:this.toBytes(e.value())}:e instanceof RefValue?{referenceValue:this.toResourceName(e.databaseId,e.key.path)}:fail("Unknown FieldValue "+JSON.stringify(e))},e.prototype.fromValue=function(e){var t=this,n=e.value_type;if(hasTag(e,n,"nullValue"))return NullValue.INSTANCE;if(hasTag(e,n,"booleanValue"))return BooleanValue.of(e.booleanValue);if(hasTag(e,n,"integerValue"))return new IntegerValue(parseInt64(e.integerValue));if(hasTag(e,n,"doubleValue")){if(this.options.useProto3Json){if("NaN"===e.doubleValue)return DoubleValue.NAN;if("Infinity"===e.doubleValue)return DoubleValue.POSITIVE_INFINITY;if("-Infinity"===e.doubleValue)return DoubleValue.NEGATIVE_INFINITY}return new DoubleValue(e.doubleValue)}if(hasTag(e,n,"stringValue"))return new StringValue(e.stringValue);if(hasTag(e,n,"mapValue"))return this.fromFields(e.mapValue.fields||{});if(hasTag(e,n,"arrayValue")){assertPresent(e.arrayValue,"arrayValue");var r=e.arrayValue.values||[];return new ArrayValue(r.map(function(e){return t.fromValue(e)}))}if(hasTag(e,n,"timestampValue"))return assertPresent(e.timestampValue,"timestampValue"),new TimestampValue(this.fromTimestamp(e.timestampValue));if(hasTag(e,n,"geoPointValue")){assertPresent(e.geoPointValue,"geoPointValue");var o=e.geoPointValue.latitude||0,i=e.geoPointValue.longitude||0;return new GeoPointValue(new GeoPoint(o,i))}if(hasTag(e,n,"bytesValue")){assertPresent(e.bytesValue,"bytesValue");var a=this.fromBlob(e.bytesValue);return new BlobValue(a)}if(hasTag(e,n,"referenceValue")){assertPresent(e.referenceValue,"referenceValue");var s=this.fromResourceName(e.referenceValue),u=new DatabaseId(s.get(1),s.get(3)),c=new DocumentKey(this.extractLocalPathFromResourceName(s));return new RefValue(u,c)}return fail("Unknown Value proto "+JSON.stringify(e))},e.prototype.toMutationDocument=function(e,t){return{name:this.toName(e),fields:this.toFields(t)}},e.prototype.toDocument=function(e){return assert$1(!e.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(e.key),fields:this.toFields(e.data),updateTime:this.toTimestamp(e.version.toTimestamp())}},e.prototype.fromDocument=function(e){return new Document(this.fromName(e.name),this.fromVersion(e.updateTime),this.fromFields(e.fields||{}),{hasLocalMutations:!1})},e.prototype.toFields=function(e){var t=this,n={};return e.forEach(function(e,r){n[e]=t.toValue(r)}),n},e.prototype.fromFields=function(e){var t=this,n=e,r=ObjectValue.EMPTY;return forEach$1(n,function(e,n){r=r.set(new FieldPath([e]),t.fromValue(n))}),r},e.prototype.toMapValue=function(e){return{fields:this.toFields(e)}},e.prototype.toArrayValue=function(e){var t=this,n=[];return e.forEach(function(e){n.push(t.toValue(e))}),{values:n}},e.prototype.fromFound=function(e){assert$1(!!e.found,"Tried to deserialize a found document from a missing document."),assertPresent(e.found.name,"doc.found.name"),assertPresent(e.found.updateTime,"doc.found.updateTime");var t=this.fromName(e.found.name),n=this.fromVersion(e.found.updateTime),r=this.fromFields(e.found.fields||{});return new Document(t,n,r,{hasLocalMutations:!1})},e.prototype.fromMissing=function(e){assert$1(!!e.missing,"Tried to deserialize a missing document from a found document."),assert$1(!!e.readTime,"Tried to deserialize a missing document without a read time.");var t=this.fromName(e.missing),n=this.fromVersion(e.readTime);return new NoDocument(t,n)},e.prototype.fromMaybeDocument=function(e){var t=e.result_type;return hasTag(e,t,"found")?this.fromFound(e):hasTag(e,t,"missing")?this.fromMissing(e):fail("invalid batch get response: "+JSON.stringify(e))},e.prototype.toWatchTargetChangeState=function(e){switch(e){case WatchTargetChangeState.Added:return"ADD";case WatchTargetChangeState.Current:return"CURRENT";case WatchTargetChangeState.NoChange:return"NO_CHANGE";case WatchTargetChangeState.Removed:return"REMOVE";case WatchTargetChangeState.Reset:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+e)}},e.prototype.toTestWatchChange=function(e){if(e instanceof ExistenceFilterChange)return{filter:{count:e.existenceFilter.count,targetId:e.targetId}};if(e instanceof DocumentWatchChange){if(e.newDoc instanceof Document){t=e.newDoc;return{documentChange:{document:{name:this.toName(t.key),fields:this.toFields(t.data),updateTime:this.toVersion(t.version)},targetIds:e.updatedTargetIds,removedTargetIds:e.removedTargetIds}}}if(e.newDoc instanceof NoDocument){var t=e.newDoc;return{documentDelete:{document:this.toName(t.key),readTime:this.toVersion(t.version),removedTargetIds:e.removedTargetIds}}}if(null===e.newDoc)return{documentRemove:{document:this.toName(e.key),removedTargetIds:e.removedTargetIds}}}if(e instanceof WatchTargetChange){var n=void 0;return e.cause&&(n={code:mapRpcCodeFromCode(e.cause.code),message:e.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(e.state),targetIds:e.targetIds,resumeToken:this.unsafeCastProtoByteString(e.resumeToken),cause:n}}}return fail("Unrecognized watch change: "+JSON.stringify(e))},e.prototype.fromWatchChange=function(e){var t,n=e.change_type;if(hasTag(e,n,"targetChange")){assertPresent(e.targetChange,"targetChange");var r=this.fromWatchTargetChangeState(e.targetChange.targetChangeType||"NO_CHANGE"),o=e.targetChange.targetIds||[],i=e.targetChange.resumeToken||this.emptyByteString(),a=e.targetChange.cause,s=a&&this.fromRpcStatus(a);t=new WatchTargetChange(r,o,i,s||null)}else if(hasTag(e,n,"documentChange")){assertPresent(e.documentChange,"documentChange"),assertPresent(e.documentChange.document,"documentChange.name"),assertPresent(e.documentChange.document.name,"documentChange.document.name"),assertPresent(e.documentChange.document.updateTime,"documentChange.document.updateTime");var u=e.documentChange,c=this.fromName(u.document.name),h=this.fromVersion(u.document.updateTime),l=this.fromFields(u.document.fields||{}),f=new Document(c,h,l,{hasLocalMutations:!1}),d=u.targetIds||[],p=u.removedTargetIds||[];t=new DocumentWatchChange(d,p,f.key,f)}else if(hasTag(e,n,"documentDelete")){assertPresent(e.documentDelete,"documentDelete"),assertPresent(e.documentDelete.document,"documentDelete.document");var m=e.documentDelete,c=this.fromName(m.document),h=m.readTime?this.fromVersion(m.readTime):SnapshotVersion.forDeletedDoc(),f=new NoDocument(c,h),p=m.removedTargetIds||[];t=new DocumentWatchChange([],p,f.key,f)}else if(hasTag(e,n,"documentRemove")){assertPresent(e.documentRemove,"documentRemove"),assertPresent(e.documentRemove.document,"documentRemove");var y=e.documentRemove,c=this.fromName(y.document),p=y.removedTargetIds||[];t=new DocumentWatchChange([],p,c,null)}else{if(!hasTag(e,n,"filter"))return fail("Unknown change type "+JSON.stringify(e));assertPresent(e.filter,"filter"),assertPresent(e.filter.targetId,"filter.targetId");var g=e.filter,v=g.count||0,b=new ExistenceFilter(v),T=g.targetId;t=new ExistenceFilterChange(T,b)}return t},e.prototype.fromWatchTargetChangeState=function(e){return"NO_CHANGE"===e?WatchTargetChangeState.NoChange:"ADD"===e?WatchTargetChangeState.Added:"REMOVE"===e?WatchTargetChangeState.Removed:"CURRENT"===e?WatchTargetChangeState.Current:"RESET"===e?WatchTargetChangeState.Reset:fail("Got unexpected TargetChange.state: "+e)},e.prototype.versionFromListenResponse=function(e){if(!hasTag(e,e.response_type,"targetChange"))return SnapshotVersion.MIN;var t=e.targetChange;return t.targetIds&&t.targetIds.length?SnapshotVersion.MIN:t.readTime?this.fromVersion(t.readTime):SnapshotVersion.MIN},e.prototype.toMutation=function(e){var t,n=this;if(e instanceof SetMutation)t={update:this.toMutationDocument(e.key,e.value)};else if(e instanceof DeleteMutation)t={delete:this.toName(e.key)};else if(e instanceof PatchMutation)t={update:this.toMutationDocument(e.key,e.data),updateMask:this.toDocumentMask(e.fieldMask)};else{if(!(e instanceof TransformMutation))return fail("Unknown mutation type "+e.type);t={transform:{document:this.toName(e.key),fieldTransforms:e.fieldTransforms.map(function(e){return n.toFieldTransform(e)})}}}return e.precondition.isNone||(t.currentDocument=this.toPrecondition(e.precondition)),t},e.prototype.fromMutation=function(e){var t=this,n=e.currentDocument?this.fromPrecondition(e.currentDocument):Precondition.NONE;if(e.update){assertPresent(e.update.name,"name");var r=this.fromName(e.update.name),o=this.fromFields(e.update.fields||{});if(e.updateMask){var i=this.fromDocumentMask(e.updateMask);return new PatchMutation(r,o,i,n)}return new SetMutation(r,o,n)}if(e.delete){r=this.fromName(e.delete);return new DeleteMutation(r,n)}if(e.transform){var r=this.fromName(e.transform.document),a=e.transform.fieldTransforms.map(function(e){return t.fromFieldTransform(e)});return assert$1(!0===n.exists,'Transforms only support precondition "exists == true"'),new TransformMutation(r,a)}return fail("unknown mutation proto: "+JSON.stringify(e))},e.prototype.toPrecondition=function(e){return assert$1(!e.isNone,"Can't serialize an empty precondition"),void 0!==e.updateTime?{updateTime:this.toVersion(e.updateTime)}:void 0!==e.exists?{exists:e.exists}:fail("Unknown precondition")},e.prototype.fromPrecondition=function(e){return void 0!==e.updateTime?Precondition.updateTime(this.fromVersion(e.updateTime)):void 0!==e.exists?Precondition.exists(e.exists):Precondition.NONE},e.prototype.fromWriteResult=function(e){var t=this,n=e.updateTime?this.fromVersion(e.updateTime):null,r=null;return e.transformResults&&(r=e.transformResults.map(function(e){return t.fromValue(e)})),new MutationResult(n,r)},e.prototype.fromWriteResults=function(e){var t=this;return(e||[]).map(function(e){return t.fromWriteResult(e)})},e.prototype.toFieldTransform=function(e){return assert$1(e.transform instanceof ServerTimestampTransform,"Unknown transform: "+e.transform),{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"}},e.prototype.fromFieldTransform=function(e){assert$1("REQUEST_TIME"===e.setToServerValue,"Unknown transform proto: "+JSON.stringify(e));var t=FieldPath.fromServerFormat(e.fieldPath);return new FieldTransform(t,ServerTimestampTransform.instance)},e.prototype.toDocumentsTarget=function(e){return{documents:[this.toQueryPath(e.path)]}},e.prototype.fromDocumentsTarget=function(e){var t=e.documents.length;assert$1(1===t,"DocumentsTarget contained other than 1 document: "+t);var n=e.documents[0];return Query.atPath(this.fromQueryPath(n))},e.prototype.toQueryTarget=function(e){var t={structuredQuery:{}};if(e.path.isEmpty())t.parent=this.toQueryPath(ResourcePath.EMPTY_PATH);else{var n=e.path;assert$1(n.length%2!=0,"Document queries with filters are not supported."),t.parent=this.toQueryPath(n.popLast()),t.structuredQuery.from=[{collectionId:n.lastSegment()}]}var r=this.toFilter(e.filters);r&&(t.structuredQuery.where=r);var o=this.toOrder(e.orderBy);o&&(t.structuredQuery.orderBy=o);var i=this.toLimit(e.limit);return void 0!==i&&(t.structuredQuery.limit=i),e.startAt&&(t.structuredQuery.startAt=this.toCursor(e.startAt)),e.endAt&&(t.structuredQuery.endAt=this.toCursor(e.endAt)),t},e.prototype.fromQueryTarget=function(e){var t=this.fromQueryPath(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0;if(r>0){assert$1(1===r,"StructuredQuery.from with more than one collection is not supported.");var o=n.from[0];t=t.child(o.collectionId)}var i=[];n.where&&(i=this.fromFilter(n.where));var a=[];n.orderBy&&(a=this.fromOrder(n.orderBy));var s=null;n.limit&&(s=n.limit);var u=null;n.startAt&&(u=this.fromCursor(n.startAt));var c=null;return n.endAt&&(c=this.fromCursor(n.endAt)),new Query(t,a,i,s,u,c)},e.prototype.toListenRequestLabels=function(e){var t=this.toLabel(e.purpose);return null==t?null:{"goog-listen-tags":t}},e.prototype.toLabel=function(e){switch(e){case QueryPurpose.Listen:return null;case QueryPurpose.ExistenceFilterMismatch:return"existence-filter-mismatch";case QueryPurpose.LimboResolution:return"limbo-document";default:return fail("Unrecognized query purpose: "+e)}},e.prototype.toTarget=function(e){var t,n=e.query;return t=n.isDocumentQuery()?{documents:this.toDocumentsTarget(n)}:{query:this.toQueryTarget(n)},t.targetId=e.targetId,e.resumeToken.length>0&&(t.resumeToken=this.unsafeCastProtoByteString(e.resumeToken)),t},e.prototype.toFilter=function(e){var t=this;if(0!==e.length){var n=e.map(function(e){return e instanceof RelationFilter?t.toRelationFilter(e):t.toUnaryFilter(e)});return 1===n.length?n[0]:{compositeFilter:{op:"AND",filters:n}}}},e.prototype.fromFilter=function(e){var t=this;return e?void 0!==e.unaryFilter?[this.fromUnaryFilter(e)]:void 0!==e.fieldFilter?[this.fromRelationFilter(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(function(e){return t.fromFilter(e)}).reduce(function(e,t){return e.concat(t)}):fail("Unknown filter: "+JSON.stringify(e)):[]},e.prototype.toOrder=function(e){var t=this;if(0!==e.length)return e.map(function(e){return t.toPropertyOrder(e)})},e.prototype.fromOrder=function(e){var t=this;return e.map(function(e){return t.fromPropertyOrder(e)})},e.prototype.toLimit=function(e){if(!isNullOrUndefined(e))return e},e.prototype.toCursor=function(e){var t=this;return{before:e.before,values:e.position.map(function(e){return t.toValue(e)})}},e.prototype.fromCursor=function(e){var t=this,n=!!e.before,r=e.values.map(function(e){return t.fromValue(e)});return new Bound(r,n)},e.prototype.toDirection=function(e){return DIRECTIONS[e.name]},e.prototype.fromDirection=function(e){switch(e){case"ASCENDING":return Direction.ASCENDING;case"DESCENDING":return Direction.DESCENDING;default:return}},e.prototype.toOperatorName=function(e){return OPERATORS[e.name]},e.prototype.fromOperatorName=function(e){switch(e){case"EQUAL":return RelationOp.EQUAL;case"GREATER_THAN":return RelationOp.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return RelationOp.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return RelationOp.LESS_THAN;case"LESS_THAN_OR_EQUAL":return RelationOp.LESS_THAN_OR_EQUAL;case"OPERATOR_UNSPECIFIED":return fail("Unspecified relation");default:return fail("Unknown relation")}},e.prototype.toFieldPathReference=function(e){return{fieldPath:e.canonicalString()}},e.prototype.fromFieldPathReference=function(e){return FieldPath.fromServerFormat(e.fieldPath)},e.prototype.toPropertyOrder=function(e){return{field:this.toFieldPathReference(e.field),direction:this.toDirection(e.dir)}},e.prototype.fromPropertyOrder=function(e){return new OrderBy(this.fromFieldPathReference(e.field),this.fromDirection(e.direction))},e.prototype.toRelationFilter=function(e){return e instanceof RelationFilter?{fieldFilter:{field:this.toFieldPathReference(e.field),op:this.toOperatorName(e.op),value:this.toValue(e.value)}}:fail("Unrecognized filter: "+JSON.stringify(e))},e.prototype.fromRelationFilter=function(e){return new RelationFilter(this.fromFieldPathReference(e.fieldFilter.field),this.fromOperatorName(e.fieldFilter.op),this.fromValue(e.fieldFilter.value))},e.prototype.toUnaryFilter=function(e){return e instanceof NanFilter?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NAN"}}:e instanceof NullFilter?{unaryFilter:{field:this.toFieldPathReference(e.field),op:"IS_NULL"}}:fail("Unrecognized filter: "+JSON.stringify(e))},e.prototype.fromUnaryFilter=function(e){switch(e.unaryFilter.op){case"IS_NAN":var t=this.fromFieldPathReference(e.unaryFilter.field);return new NanFilter(t);case"IS_NULL":var n=this.fromFieldPathReference(e.unaryFilter.field);return new NullFilter(n);case"OPERATOR_UNSPECIFIED":return fail("Unspecified filter");default:return fail("Unknown filter")}},e.prototype.toDocumentMask=function(e){return{fieldPaths:e.fields.map(function(e){return e.canonicalString()})}},e.prototype.fromDocumentMask=function(e){var t=(e.fieldPaths||[]).map(function(e){return FieldPath.fromServerFormat(e)});return new FieldMask(t)},e}(),dist=createCommonjsModule(function(module){(function(){function l(e){return"string"==typeof e}function ba(){}function ca(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var n=Object.prototype.toString.call(e);if("[object Window]"==n)return"object";if("[object Array]"==n||"number"==typeof e.length&&void 0!==e.splice&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("splice"))return"array";if("[object Function]"==n||void 0!==e.call&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===e.call)return"object";return t}function n(e){return"array"==ca(e)}function da(e){var t=ca(e);return"array"==t||"object"==t&&"number"==typeof e.length}function ea(e){return"function"==ca(e)}function p(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function ha(e,t,n){return e.call.apply(e.bind,arguments)}function ia(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function r(e,t,n){return(r=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ha:ia).apply(null,arguments)}function ja(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function u(e,t){function n(){}n.prototype=t.prototype,e.L=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Bb=function(e,n,r){for(var o=Array(arguments.length-2),i=2;i<arguments.length;i++)o[i-2]=arguments[i];return t.prototype[n].apply(e,o)}}function ka(e){if(Error.captureStackTrace)Error.captureStackTrace(this,ka);else{var t=Error().stack;t&&(this.stack=t)}e&&(this.message=String(e))}function la(e,t){for(var n=e.split("%s"),r="",o=Array.prototype.slice.call(arguments,1);o.length&&1<n.length;)r+=n.shift()+o.shift();return r+n.join("%s")}function na(e,t){return e<t?-1:e>t?1:0}function oa(e,t){t.unshift(e),ka.call(this,la.apply(null,t)),t.shift()}function pa(e,t){throw new oa("Failure"+(e?": "+e:""),Array.prototype.slice.call(arguments,1))}function w(){0!=ra&&(sa[this[q]||(this[q]=++fa)]=this),this.i=this.i,this.A=this.A}function va(e){e:{for(var t=wa,n=e.length,r=l(e)?e.split(""):e,o=0;o<n;o++)if(o in r&&t.call(void 0,r[o],o,e)){t=o;break e}t=-1}return 0>t?null:l(e)?e.charAt(t):e[t]}function xa(e){if(!n(e))for(var t=e.length-1;0<=t;t--)delete e[t];e.length=0}function ya(e){return Array.prototype.concat.apply([],arguments)}function za(e){var t=e.length;if(0<t){for(var n=Array(t),r=0;r<t;r++)n[r]=e[r];return n}return[]}function y(e){return-1!=x.indexOf(e)}function Ca(e,t,n){for(var r in e)t.call(n,e[r],r,e)}function Da(e){var t,n=[],r=0;for(t in e)n[r++]=e[t];return n}function Ea(e){var t,n=[],r=0;for(t in e)n[r++]=t;return n}function Fa(e){var t,n={};for(t in e)n[t]=e[t];return n}function Ha(e,t){for(var n,r,o=1;o<arguments.length;o++){r=arguments[o];for(n in r)e[n]=r[n];for(var i=0;i<Ga.length;i++)n=Ga[i],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Ia(e){return Ia[" "](e),e}function Ja(e,t){var n=Ka;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e)}function Pa(){var e=k.document;return e?e.documentMode:void 0}function Ua(e){return Ja(e,function(){for(var t=0,n=ma(String(Qa)).split("."),r=ma(String(e)).split("."),o=Math.max(n.length,r.length),i=0;0==t&&i<o;i++){var a=n[i]||"",s=r[i]||"";do{if(a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==a[0].length&&0==s[0].length)break;t=na(0==a[1].length?0:parseInt(a[1],10),0==s[1].length?0:parseInt(s[1],10))||na(0==a[2].length,0==s[2].length)||na(a[2],s[2]),a=a[3],s=s[3]}while(0==t)}return 0<=t})}function A(e,t){this.type=e,this.a=this.target=t,this.Qa=!0}function ab(e,t){if(A.call(this,e?e.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,e){var n=this.type=e.type,r=e.changedTouches?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.a=t,t=e.relatedTarget){if(Na){e:{try{Ia(t.nodeName);var o=!0;break e}catch(e){}o=!1}o||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,null===r?(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0):(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType=l(e.pointerType)?e.pointerType:bb[e.pointerType]||"",this.c=e,e.defaultPrevented&&this.b()}}function db(e){return!(!e||!e[cb])}function fb(e,t,n,r,o){this.listener=e,this.a=null,this.src=t,this.type=n,this.capture=!!r,this.ga=o,this.key=++eb,this.Y=this.ca=!1}function gb(e){e.Y=!0,e.listener=null,e.a=null,e.src=null,e.ga=null}function hb(e){this.src=e,this.a={},this.b=0}function jb(e,t){var n=t.type;if(n in e.a){var r,o=e.a[n],i=ta(o,t);(r=0<=i)&&Array.prototype.splice.call(o,i,1),r&&(gb(t),0==e.a[n].length&&(delete e.a[n],e.b--))}}function kb(e,t,n,r,o){return e=e.a[t.toString()],t=-1,e&&(t=ib(e,n,r,o)),-1<t?e[t]:null}function ib(e,t,n,r){for(var o=0;o<e.length;++o){var i=e[o];if(!i.Y&&i.listener==t&&i.capture==!!n&&i.ga==r)return o}return-1}function ob(e,t,r,o,i){if(o&&o.once)return pb(e,t,r,o,i);if(n(t)){for(var a=0;a<t.length;a++)ob(e,t[a],r,o,i);return null}return r=qb(r),db(e)?e.aa(t,r,p(o)?!!o.capture:!!o,i):rb(e,t,r,!1,o,i)}function rb(e,t,n,r,o,i){if(!t)throw Error("Invalid event type");var a=p(o)?!!o.capture:!!o,s=sb(e);if(s||(e[lb]=s=new hb(e)),(n=s.add(t,n,r,a,i)).a)return n;if(r=tb(),n.a=r,r.src=e,r.listener=n,e.addEventListener)$a||(o=a),void 0===o&&(o=!1),e.addEventListener(t.toString(),r,o);else if(e.attachEvent)e.attachEvent(ub(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function tb(){var e=vb,t=Ya?function(n){return e.call(t.src,t.listener,n)}:function(n){if(!(n=e.call(t.src,t.listener,n)))return n};return t}function pb(e,t,r,o,i){if(n(t)){for(var a=0;a<t.length;a++)pb(e,t[a],r,o,i);return null}return r=qb(r),db(e)?e.Ia(t,r,p(o)?!!o.capture:!!o,i):rb(e,t,r,!0,o,i)}function wb(e,t,r,o,i){if(n(t))for(var a=0;a<t.length;a++)wb(e,t[a],r,o,i);else o=p(o)?!!o.capture:!!o,r=qb(r),db(e)?e.wa(t,r,o,i):e&&(e=sb(e))&&(t=kb(e,t,r,o,i))&&xb(t)}function xb(e){if("number"!=typeof e&&e&&!e.Y){var t=e.src;if(db(t))jb(t.c,e);else{var n=e.type,r=e.a;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(ub(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=sb(t))?(jb(n,e),0==n.b&&(n.src=null,t[lb]=null)):gb(e)}}}function ub(e){return e in mb?mb[e]:mb[e]="on"+e}function yb(e,t,n,r){var o=!0;if((e=sb(e))&&(t=e.a[t.toString()]))for(t=t.concat(),e=0;e<t.length;e++){var i=t[e];i&&i.capture==n&&!i.Y&&(i=zb(i,r),o=o&&!1!==i)}return o}function zb(e,t){var n=e.listener,r=e.ga||e.src;return e.ca&&xb(e),n.call(r,t)}function vb(e,t){if(e.Y)return!0;if(!Ya){if(!t)e:{t=["window","event"];for(var n=k,r=0;r<t.length;r++)if(null==(n=n[t[r]])){t=null;break e}t=n}if(r=t,t=new ab(r,this),n=!0,!(0>r.keyCode||void 0!=r.returnValue)){e:{var o=!1;if(0==r.keyCode)try{r.keyCode=-1;break e}catch(e){o=!0}(o||void 0==r.returnValue)&&(r.returnValue=!0)}for(r=[],o=t.a;o;o=o.parentNode)r.push(o);for(e=e.type,o=r.length-1;0<=o;o--){t.a=r[o];var i=yb(r[o],e,!0,t);n=n&&i}for(o=0;o<r.length;o++)t.a=r[o],i=yb(r[o],e,!1,t),n=n&&i}return n}return zb(e,new ab(t,this))}function sb(e){return(e=e[lb])instanceof hb?e:null}function qb(e){return ea(e)?e:(e[Ab]||(e[Ab]=function(t){return e.handleEvent(t)}),e[Ab])}function B(){w.call(this),this.c=new hb(this),this.P=this,this.J=null}function Bb(e,t,n,r){if(!(t=e.c.a[String(t)]))return!0;t=t.concat();for(var o=!0,i=0;i<t.length;++i){var a=t[i];if(a&&!a.Y&&a.capture==n){var s=a.listener,u=a.ga||a.src;a.ca&&jb(e.c,a),o=!1!==s.call(u,r)&&o}}return o&&0!=r.Qa}function Cb(e){return!/^\s*$/.test(e)&&/^[\],:{}\s\u2028\u2029]*$/.test(e.replace(/\\["\\\/bfnrtu]/g,"@").replace(/(?:"[^"\\\n\r\u2028\u2029\x00-\x08\x0a-\x1f]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)[\s\u2028\u2029]*(?=:|,|]|}|$)/g,"]").replace(/(?:^|:|,)(?:[\s\u2028\u2029]*\[)+/g,""))}function Db(a){if(a=String(a),Cb(a))try{return eval("("+a+")")}catch(e){}throw Error("Invalid JSON string: "+a)}function Eb(e){var t=[];return Fb(new Gb,e,t),t.join("")}function Gb(){}function Fb(e,t,r){if(null==t)r.push("null");else{if("object"==typeof t){if(n(t)){var o=t;t=o.length,r.push("[");for(var i="",a=0;a<t;a++)r.push(i),Fb(e,o[a],r),i=",";return void r.push("]")}if(!(t instanceof String||t instanceof Number||t instanceof Boolean)){r.push("{"),i="";for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&"function"!=typeof(a=t[o])&&(r.push(i),Hb(o,r),r.push(":"),Fb(e,a,r),i=",");return void r.push("}")}t=t.valueOf()}switch(typeof t){case"string":Hb(t,r);break;case"number":r.push(isFinite(t)&&!isNaN(t)?String(t):"null");break;case"boolean":r.push(String(t));break;case"function":r.push("null");break;default:throw Error("Unknown type: "+typeof t)}}}function Hb(e,t){t.push('"',e.replace(Jb,function(e){var t=Ib[e];return t||(t="\\u"+(65536|e.charCodeAt(0)).toString(16).substr(1),Ib[e]=t),t}),'"')}function Kb(e,t,n){this.f=n,this.c=e,this.g=t,this.b=0,this.a=null}function Lb(){this.b=this.a=null}function Ob(){var e=Pb,t=null;return e.a&&(t=e.a,e.a=e.a.next,e.a||(e.b=null),t.next=null),t}function Mb(){this.next=this.b=this.a=null}function Qb(e){k.setTimeout(function(){throw e},0)}function Sb(){var e=k.MessageChannel;if(void 0===e&&"undefined"!=typeof window&&window.postMessage&&window.addEventListener&&!y("Presto")&&(e=function(){var e=document.createElement("IFRAME");e.style.display="none",e.src="",document.documentElement.appendChild(e);var t=e.contentWindow;(e=t.document).open(),e.write(""),e.close();var n="callImmediate"+Math.random(),o="file:"==t.location.protocol?"*":t.location.protocol+"//"+t.location.host;e=r(function(e){"*"!=o&&e.origin!=o||e.data!=n||this.port1.onmessage()},this),t.addEventListener("message",e,!1),this.port1={},this.port2={postMessage:function(){t.postMessage(n,o)}}}),void 0!==e&&!y("Trident")&&!y("MSIE")){var t=new e,n={},o=n;return t.port1.onmessage=function(){if(void 0!==n.next){var e=(n=n.next).Ba;n.Ba=null,e()}},function(e){o.next={Ba:e},o=o.next,t.port2.postMessage(0)}}return"undefined"!=typeof document&&"onreadystatechange"in document.createElement("SCRIPT")?function(e){var t=document.createElement("SCRIPT");t.onreadystatechange=function(){t.onreadystatechange=null,t.parentNode.removeChild(t),t=null,e(),e=null},document.documentElement.appendChild(t)}:function(e){k.setTimeout(e,0)}}function Ub(){if(-1!=String(k.Promise).indexOf("[native code]")){var e=k.Promise.resolve(void 0);Tb=function(){e.then(Vb)}}else Tb=function(){var e=Vb;!ea(k.setImmediate)||k.Window&&k.Window.prototype&&!y("Edge")&&k.Window.prototype.setImmediate==k.setImmediate?(Rb||(Rb=Sb()),Rb(e)):k.setImmediate(e)}}function Vb(){for(var e;e=Ob();){try{e.a.call(e.b)}catch(e){Qb(e)}C.g(e),C.b<C.f&&(C.b++,e.next=C.a,C.a=e)}Wb=!1}function Xb(e,n){B.call(this),this.b=e||1,this.a=n||k,this.f=r(this.jb,this),this.g=t()}function Yb(e){e.$=!1,e.K&&(e.a.clearTimeout(e.K),e.K=null)}function Zb(e,t,n){if(ea(e))n&&(e=r(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=r(e.handleEvent,e)}return 2147483647<Number(t)?-1:k.setTimeout(e,t||0)}function $b(e,t,n){w.call(this),this.f=null!=n?r(e,n):e,this.c=t,this.b=r(this.cb,this),this.a=[]}function ac(e){e.X=Zb(e.b,e.c),e.f.apply(null,e.a)}function D(e){w.call(this),this.b=e,this.a={}}function cc(e){Ca(e.a,function(e,t){this.a.hasOwnProperty(t)&&xb(e)},e),e.a={}}function dc(e,t,n,r,o){this.reset(e,t,n,r,o)}function fc(e){this.f=e,this.b=this.c=this.a=null}function E(e,t){this.name=e,this.value=t}function lc(e){return e.c?e.c:e.a?lc(e.a):(pa("Root logger has no level set."),null)}function oc(e){nc||(nc=new fc(""),mc[""]=nc,nc.c=jc);var t;if(!(t=mc[e])){t=new fc(e);var n=e.lastIndexOf("."),r=e.substr(n+1);(n=oc(e.substr(0,n))).b||(n.b={}),n.b[r]=t,t.a=n,mc[e]=t}return t}function F(e,t){e&&e.log(hc,t,void 0)}function pc(e,t){e&&e.log(ic,t,void 0)}function H(e,t){e&&e.log(kc,t,void 0)}function qc(){this.a=oc("goog.labs.net.webChannel.WebChannelDebug"),this.b=!0}function rc(e,t,n,r,o,i){I(e,function(){if(e.b)if(i)for(var a="",s=i.split("&"),u=0;u<s.length;u++){var c=s[u].split("=");if(1<c.length){var h=c[0];c=c[1];var l=h.split("_");a=2<=l.length&&"type"==l[1]?a+(h+"=")+c+"&":a+(h+"=redacted&")}}else a=null;else a=i;return"XMLHTTP REQ ("+r+") [attempt "+o+"]: "+t+"\n"+n+"\n"+a})}function sc(e,t,n,r,o,i,a){I(e,function(){return"XMLHTTP RESP ("+r+") [ attempt "+o+"]: "+t+"\n"+n+"\n"+i+" "+a})}function tc(e,t,n,r){I(e,function(){return"XMLHTTP TEXT ("+t+"): "+uc(e,n)+(r?" "+r:"")})}function vc(e,t){I(e,function(){return"TIMEOUT: "+t})}function J(e,t){H(e.a,t)}function wc(e,t,n){(e=e.a)&&e.log(gc,n||"Exception",t)}function I(e,t){pc(e.a,t)}function xc(e,t){(e=e.a)&&e.log(gc,t,void 0)}function uc(e,t){if(!e.b)return t;if(!t)return null;try{var r=JSON.parse(t);if(r)for(var o=0;o<r.length;o++)if(n(r[o])){var i=r[o];if(!(2>i.length)){var a=i[1];if(n(a)&&!(1>a.length)){var s=a[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var u=1;u<a.length;u++)a[u]=""}}}return Eb(r)}catch(n){return J(e,"Exception parsing expected JS array - probably was not JS"),t}}function zc(e){A.call(this,"serverreachability",e)}function Ac(){yc.dispatchEvent(new zc(yc))}function Bc(e){A.call(this,"statevent",e)}function K(){yc.dispatchEvent(new Bc(yc))}function Cc(e){A.call(this,"timingevent",e)}function Dc(){yc.dispatchEvent(new Cc(yc))}function Ec(e,t){if(!ea(e))throw Error("Fn must not be null and must be a function");return k.setTimeout(function(){e()},t)}function Hc(){}function Ic(e){var t;return(t=e.a)||(t={},Jc(e)&&(t[0]=!0,t[1]=!0),t=e.a=t),t}function Lc(){}function Mc(e){return(e=Jc(e))?new ActiveXObject(e):new XMLHttpRequest}function Jc(e){if(!e.b&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var t=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],n=0;n<t.length;n++){var r=t[n];try{return new ActiveXObject(r),e.b=r}catch(e){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed")}return e.b}function L(e,t,n,r,o){this.i=e,this.b=t,this.f=r,this.T=o||1,this.N=new D(this),this.S=Nc,(e=this.H=new Xb).b=Oc,e.K&&e.$?(Yb(e),e.start()):e.K&&Yb(e),this.j=null,this.c=!1,this.G=this.g=this.h=this.J=this.C=this.U=this.s=null,this.o=[],this.a=null,this.D=0,this.l=this.m=null,this.B=-1,this.A=!1,this.P=0,this.I=null,this.M=!1}function Pc(e,t){switch(e){case 0:return"Non-200 return code ("+t+")";case 1:return"XMLHTTP failure (no data)";case 2:return"HttpConnection timeout";default:return"Unknown error"}}function Sc(e,t,n){e.J=1,e.h=Tc(M(t)),e.G=n,e.M=!0,Uc(e,null)}function Vc(e,t,n,r){e.J=1,e.h=Tc(M(t)),e.G=null,e.M=n,Uc(e,r)}function Uc(e,n){e.C=t(),Wc(e),e.g=M(e.h),Xc(e.g,"t",e.T),e.D=0,e.a=e.i.da(e.i.ia()?n:null),0<e.P&&(e.I=new $b(r(e.Ra,e,e.a),e.P)),e.N.aa(e.a,"readystatechange",e.gb),n=e.j?Fa(e.j):{},e.G?(e.m||(e.m="POST"),n["Content-Type"]="application/x-www-form-urlencoded",e.a.fa(e.g,e.m,e.G,n)):(e.m="GET",e.a.fa(e.g,e.m,null,n)),Ac(),rc(e.b,e.m,e.g,e.f,e.T,e.G)}function Yc(e){var t=N(e.a),n=e.a.Ga();if(!(3>t||3==t&&!La&&!e.a.V())){e.A||4!=t||7==n||Ac(),Zc(e);var r=e.a.W();e.B=r,(n=e.a.V())||J(e.b,function(){return"No response text for uri "+e.g+" status "+r}),e.c=200==r,sc(e.b,e.m,e.g,e.f,e.T,t,r),e.c?(e.M?($c(e,t,n),La&&e.c&&3==t&&ad(e)):(tc(e.b,e.f,n,null),bd(e,n)),4==t&&cd(e),e.c&&!e.A&&(4==t?e.i.va(e):(e.c=!1,Wc(e)))):(400==r&&0<n.indexOf("Unknown SID")?(e.l=3,K(),F(e.b.a,"XMLHTTP Unknown SID ("+e.f+")")):(e.l=0,K(),F(e.b.a,"XMLHTTP Bad status "+r+" ("+e.f+")")),cd(e),dd(e))}}function $c(e,t,n){for(var r=!0;!e.A&&e.D<n.length;){var o=ed(e,n);if(o==Rc){4==t&&(e.l=4,K(),r=!1),tc(e.b,e.f,null,"[Incomplete Response]");break}if(o==Qc){e.l=4,K(),tc(e.b,e.f,n,"[Invalid Chunk]"),r=!1;break}tc(e.b,e.f,o,null),bd(e,o)}4==t&&0==n.length&&(e.l=1,K(),r=!1),e.c=e.c&&r,r||(tc(e.b,e.f,n,"[Invalid Chunked Response]"),cd(e),dd(e))}function ad(e){e.N.aa(e.H,"tick",e.fb),e.H.start()}function ed(e,t){var n=e.D,r=t.indexOf("\n",n);return-1==r?Rc:(n=Number(t.substring(n,r)),isNaN(n)?Qc:(r+=1)+n>t.length?Rc:(t=t.substr(r,n),e.D=r+n,t))}function Wc(e){e.U=t()+e.S,fd(e,e.S)}function fd(e,t){if(null!=e.s)throw Error("WatchDog timer not null");e.s=Ec(r(e.eb,e),t)}function Zc(e){e.s&&(k.clearTimeout(e.s),e.s=null)}function dd(e){e.i.Ka()||e.A||e.i.va(e)}function cd(e){Zc(e);var t=e.I;t&&"function"==typeof t.Z&&t.Z(),e.I=null,Yb(e.H),cc(e.N),e.a&&(t=e.a,e.a=null,t.abort(),t.Z())}function bd(e,t){try{e.i.Na(e,t),Ac()}catch(t){wc(e.b,t,"Error in httprequest callback")}}function gd(e){if(e.v&&"function"==typeof e.v)return e.v();if(l(e))return e.split("");if(da(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}return Da(e)}function hd(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(da(e)||l(e))ua(e,t,void 0);else{if(e.O&&"function"==typeof e.O)var n=e.O();else if(e.v&&"function"==typeof e.v)n=void 0;else if(da(e)||l(e)){n=[];for(var r=e.length,o=0;o<r;o++)n.push(o)}else n=Ea(e);o=(r=gd(e)).length;for(var i=0;i<o;i++)t.call(void 0,r[i],n&&n[i],e)}}function O(e,t){this.b={},this.a=[],this.c=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(e){e instanceof O?(n=e.O(),r=e.v()):(n=Ea(e),r=Da(e));for(var o=0;o<n.length;o++)this.set(n[o],r[o])}}function jd(e){e.b={},e.a.length=0,e.c=0}function kd(e,t){return!!P(e.b,t)&&(delete e.b[t],e.c--,e.a.length>2*e.c&&id(e),!0)}function id(e){if(e.c!=e.a.length){for(var t=0,n=0;t<e.a.length;){var r=e.a[t];P(e.b,r)&&(e.a[n++]=r),t++}e.a.length=n}if(e.c!=e.a.length){var o={};for(n=t=0;t<e.a.length;)r=e.a[t],P(o,r)||(e.a[n++]=r,o[r]=1),t++;e.a.length=n}}function P(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function md(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),o=null;if(0<=r){var i=e[n].substring(0,r);o=e[n].substring(r+1)}else i=e[n];t(i,o?decodeURIComponent(o.replace(/\+/g," ")):"")}}}function Q(e,t){this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1;var n;e instanceof Q?(this.h=void 0!==t?t:e.h,nd(this,e.f),this.j=e.j,od(this,e.b),pd(this,e.i),this.a=e.a,qd(this,rd(e.c)),this.g=e.g):e&&(n=String(e).match(ld))?(this.h=!!t,nd(this,n[1]||"",!0),this.j=sd(n[2]||""),od(this,n[3]||"",!0),pd(this,n[4]),this.a=sd(n[5]||"",!0),qd(this,n[6]||"",!0),this.g=sd(n[7]||"")):(this.h=!!t,this.c=new td(null,0,this.h))}function M(e){return new Q(e)}function nd(e,t,n){e.f=n?sd(t,!0):t,e.f&&(e.f=e.f.replace(/:$/,""))}function od(e,t,n){e.b=n?sd(t,!0):t}function pd(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.i=t}else e.i=null}function qd(e,t,n){t instanceof td?(e.c=t,zd(e.c,e.h)):(n||(t=ud(t,Ad)),e.c=new td(t,0,e.h))}function R(e,t,n){e.c.set(t,n)}function Xc(e,t,r){n(r)||(r=[String(r)]),Bd(e.c,t,r)}function Tc(e){return R(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^t()).toString(36)),e}function Cd(e){return e instanceof Q?M(e):new Q(e,void 0)}function Dd(e,t,n,r){var o=new Q(null,void 0);return e&&nd(o,e),t&&od(o,t),n&&pd(o,n),r&&(o.a=r),o}function sd(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function ud(e,t,n){return l(e)?(e=encodeURI(e).replace(t,Ed),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function Ed(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}function td(e,t,n){this.b=this.a=null,this.c=e||null,this.f=!!n}function S(e){e.a||(e.a=new O,e.b=0,e.c&&md(e.c,function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)}))}function Gd(e,t){S(e),t=Fd(e,t),P(e.a.b,t)&&(e.c=null,e.b-=e.a.get(t).length,kd(e.a,t))}function Hd(e,t){return S(e),t=Fd(e,t),P(e.a.b,t)}function Bd(e,t,n){Gd(e,t),0<n.length&&(e.c=null,e.a.set(Fd(e,t),za(n)),e.b+=n.length)}function rd(e){var t=new td;return t.c=e.c,e.a&&(t.a=new O(e.a),t.b=e.b),t}function Fd(e,t){return t=String(t),e.f&&(t=t.toLowerCase()),t}function zd(e,t){t&&!e.f&&(S(e),e.c=null,e.a.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Gd(this,t),Bd(this,n,e))},e)),e.f=t}function Id(){this.a=t()}function Kd(){Jd||(Jd=new Id)}function Ld(){Jd||(Jd=new Id)}function Md(){}function Od(){A.call(this,"d")}function Pd(){A.call(this,"c")}function Qd(e,t){this.a=e,this.b=t,this.c=this.i=null,this.h=!1,this.l=null,this.f=-1,this.m=this.g=null}function Rd(e){J(e.b,"TestConnection: starting stage 2");var t=e.a.H.a;if(null!=t)J(e.b,function(){return"Buffered"}),K(),t?(K(),Sd(e.a,e,!1)):(K(),Sd(e.a,e,!0));else{e.c=new L(e,e.b,0,void 0,void 0),e.c.j=e.i;var n=Td(e.a,e.g,e.l);K(),Xc(n,"TYPE","xmlhttp");var r=e.a.j,o=e.a.J;r&&o&&R(n,r,o),Vc(e.c,n,!1,e.g)}}function Vd(){this.a=this.b=null}function T(e){if(this.a=new O,e)for(var t=(e=gd(e)).length,n=0;n<t;n++)this.add(e[n])}function Wd(e){var t=typeof e;return"object"==t&&e||"function"==t?"o"+(e[q]||(e[q]=++fa)):t.charAt(0)+e}function Xd(e,t){this.a=e,this.b=t}function Yd(e){this.g=e||Zd,this.f=k.qa&&k.qa.La&&k.qa.La()&&k.qa.La().Cb?this.g:1,this.a=null,1<this.f&&(this.a=new T),this.b=null,this.c=[]}function $d(e,t){e.a||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(e.f=e.g,e.a=new T,e.b&&(ae(e,e.b),e.b=null))}function be(e){return!!e.b||!!e.a&&e.a.u()>=e.f}function ce(e,t){return e.b?e.b==t:!!e.a&&e.a.contains(t)}function ae(e,t){e.a?e.a.add(t):e.b=t}function de(e,t){e.b&&e.b==t?e.b=null:e.a&&e.a.contains(t)&&kd(e.a.a,Wd(t))}function ee(e){if(null!=e.b)return e.c.concat(e.b.o);if(null!=e.a&&0!=e.a.a.c){var t=e.c;return ua(e.a.v(),function(e){t=t.concat(e.o)}),t}return za(e.c)}function fe(e,t){e.c=e.c.concat(t)}function ge(e,t){this.a=e,this.b=t}function he(){this.a=new ge}function ie(e,t,n){var r=n||"";try{hd(e,function(e,n){var o=e;p(e)&&(o=Eb(e)),t.push(r+n+"="+encodeURIComponent(o))})}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}function je(e,t){var n=new qc;J(n,"TestLoadImage: loading "+e);var r=new Image;r.onload=ja(ke,n,r,"TestLoadImage: loaded",!0,t),r.onerror=ja(ke,n,r,"TestLoadImage: error",!1,t),r.onabort=ja(ke,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=ja(ke,n,r,"TestLoadImage: timeout",!1,t),k.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}function ke(e,t,n,r,o){try{J(e,n),t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,o(r)}catch(t){wc(e,t)}}function U(e){B.call(this),this.headers=new O,this.D=e||null,this.f=!1,this.C=this.a=null,this.M=this.s="",this.j=0,this.g="",this.h=this.I=this.o=this.H=!1,this.l=0,this.B=null,this.N=le,this.G=this.m=!1}function qe(e){return z&&Ua(9)&&"number"==typeof e.timeout&&void 0!==e.ontimeout}function wa(e){return"content-type"==e.toLowerCase()}function oe(e,t){e.f=!1,e.a&&(e.h=!0,e.a.abort(),e.h=!1),e.g=t,e.j=5,re(e),se(e)}function re(e){e.H||(e.H=!0,e.dispatchEvent("complete"),e.dispatchEvent("error"))}function te(e){if(e.f&&void 0!==goog)if(e.C[1]&&4==N(e)&&2==e.W())H(e.b,V(e,"Local request error detected and ignored"));else if(e.o&&4==N(e))Zb(e.Ma,0,e);else if(e.dispatchEvent("readystatechange"),4==N(e)){H(e.b,V(e,"Request complete")),e.f=!1;try{var t=e.W();e:switch(t){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var n=!0;break e;default:n=!1}var r;if(!(r=n)){var o;if(o=0===t){var i=String(e.s).match(ld)[1]||null;if(!i&&k.self&&k.self.location){var a=k.self.location.protocol;i=a.substr(0,a.length-1)}o=!me.test(i?i.toLowerCase():"")}r=o}r?(e.dispatchEvent("complete"),e.dispatchEvent("success")):(e.j=6,e.g=e.Ha()+" ["+e.W()+"]",re(e))}finally{se(e)}}}function se(e,t){if(e.a){pe(e);var n=e.a,r=e.C[0]?ba:null;e.a=null,e.C=null,t||e.dispatchEvent("ready");try{n.onreadystatechange=r}catch(t){(e=e.b)&&e.log(gc,"Problem encountered resetting onreadystatechange: "+t.message,void 0)}}}function pe(e){e.a&&e.G&&(e.a.ontimeout=null),e.B&&(k.clearTimeout(e.B),e.B=null)}function N(e){return e.a?e.a.readyState:0}function V(e,t){return t+" ["+e.M+" "+e.s+" "+e.W()+"]"}function ue(e){var t="";return Ca(e,function(e,n){t+=n,t+=":",t+=e,t+="\r\n"}),t}function ve(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}if(r)return e;if(n=ue(n),l(e)){if(t=encodeURIComponent(String(t)),n=null!=n?"="+encodeURIComponent(String(n)):"",t+=n){if(0>(n=e.indexOf("#"))&&(n=e.length),0>(r=e.indexOf("?"))||r>n){r=n;var o=""}else o=e.substring(r+1,n);n=(e=[e.substr(0,r),o,e.substr(n)])[1],e[1]=t?n?n+"&"+t:t:n,e=e[0]+(e[1]?"?"+e[1]:"")+e[2]}return e}return R(e,t,n),e}function we(e,t,n){this.ya=t||0,this.Aa=0,this.g=[],this.a=new qc,this.H=n||new Vd,this.ja=this.xa=this.D=this.ka=this.b=this.J=this.j=this.U=this.h=this.M=this.i=null,this.Va=this.P=0,this.la=this.B=this.o=this.m=this.l=this.c=null,this.s=this.za=this.N=-1,this.T=this.A=this.C=0,this.S=e&&e.supportsCrossDomainXhr||!1,this.I="",this.f=new Yd(e&&e.concurrentRequestLimit),this.ma=new he,this.G=!e||void 0===e.backgroundChannelTest||e.backgroundChannelTest,this.Ua=e&&e.fastHandshake||!1,e&&e.Fa&&this.a.Fa()}function xe(e){if(J(e.a,"disconnect()"),ye(e),3==e.F){var n=e.P++,r=M(e.D);R(r,"SID",e.I),R(r,"RID",n),R(r,"TYPE","terminate"),ze(e,r),(n=new L(e,e.a,0,n,void 0)).J=2,n.h=Tc(M(r)),r=!1,k.navigator&&k.navigator.sendBeacon&&(r=k.navigator.sendBeacon(n.h.toString(),"")),!r&&k.Image&&((new Image).src=n.h,r=!0),r||(n.a=n.i.da(null),n.a.fa(n.h)),n.C=t(),Wc(n)}Ae(e)}function ye(e){e.B&&(e.B.abort(),e.B=null),e.b&&(e.b.cancel(),e.b=null),e.m&&(k.clearTimeout(e.m),e.m=null),Be(e),e.f.cancel(),e.l&&(k.clearTimeout(e.l),e.l=null)}function Ce(e,t){1e3==e.g.length&&xc(e.a,function(){return"Already have 1000 queued maps upon queueing "+Eb(t)}),e.g.push(new Xd(e.Va++,t)),3==e.F&&De(e)}function De(e){be(e.f)||e.l||(e.l=Ec(r(e.Pa,e),0),e.C=0)}function Ee(e,t){var n=e.f;return(n.b?1:n.a?n.a.u():0)>=e.f.f-(e.l?1:0)?(xc(e.a,"Unexpected retry request is scheduled."),!1):e.l?(J(e.a,"Use the retry request that is already scheduled."),e.g=t.o.concat(e.g),!0):!(1==e.F||2==e.F||2<=e.C)&&(J(e.a,"Going to retry POST"),e.l=Ec(r(e.Pa,e,t),Fe(e,e.C)),e.C++,!0)}function He(e,t){var n;n=t?t.f:e.P++;var r=M(e.D);R(r,"SID",e.I),R(r,"RID",n),R(r,"AID",e.N),ze(e,r),e.h&&e.i&&ve(r,e.h,e.i),n=new L(e,e.a,0,n,e.C+1),null===e.h&&(n.j=e.i),t&&(e.g=t.o.concat(e.g)),t=Ge(e,n),n.setTimeout(Math.round(1e4)+Math.round(1e4*Math.random())),ae(e.f,n),Sc(n,r,t)}function ze(e,t){e.c&&hd({},function(e,n){R(t,n,e)})}function Ge(e,t){var n=Math.min(e.g.length,1e3),o=e.c?r(e.c.Wa,e.c,e):null;e:for(var i=e.g,a=-1;;){var s=["count="+n];-1==a?0<n?(a=i[0].a,s.push("ofs="+a)):a=0:s.push("ofs="+a);for(var u=!0,c=0;c<n;c++){var h=i[c].a,l=i[c].b;if(0>(h-=a))a=Math.max(0,i[c].a-100),u=!1;else try{ie(l,s,"req"+h+"_")}catch(e){o&&o(l)}}if(u){o=s.join("&");break e}}return e=e.g.splice(0,n),t.o=e,o}function Ie(e){if(!e.b&&!e.m){e.T=1;var t=e.Oa;Tb||Ub(),Wb||(Tb(),Wb=!0),Pb.add(t,e),e.A=0}}function Je(e){return e.b||e.m?(xc(e.a,"Request already in progress"),!1):!(3<=e.A)&&(J(e.a,"Going to retry GET"),e.T++,e.m=Ec(r(e.Oa,e),Fe(e,e.A)),e.A++,!0)}function Sd(e,t,n){J(e.a,"Test Connection Finished");var r=t.m;r&&$d(e.f,r),e.la=n,e.s=t.f,J(e.a,"connectChannel_()"),e.D=Ke(e,e.ka),De(e)}function Ud(e,t){J(e.a,"Test Connection Failed"),e.s=t.f,W(e,2)}function Be(e){null!=e.o&&(k.clearTimeout(e.o),e.o=null)}function Fe(e,t){var n=5e3+Math.floor(1e4*Math.random());return e.sa()||(J(e.a,"Inactive channel"),n*=2),n*t}function W(e,t){if(I(e.a,"Error code "+t),2==t){var n=null;e.c&&(n=null);var o=r(e.ib,e);n||(n=new Q("//www.google.com/images/cleardot.gif"),k.location&&"http"==k.location.protocol||nd(n,"https"),Tc(n)),je(n.toString(),o)}else K();J(e.a,"HttpChannel: error - "+t),e.F=0,e.c&&e.c.Ca(e,t),Ae(e),ye(e)}function Ae(e){if(e.F=0,e.s=-1,e.c){var t=ee(e.f);if(0==t.length&&0==e.g.length)e.c.oa(e);else{J(e.a,function(){return"Number of undelivered maps, pending: "+t.length+", outgoing: "+e.g.length}),e.f.c.length=0;var n=za(e.g);e.g.length=0,e.c.oa(e,t,n)}}}function Ke(e,t){return t=Le(e,null,t),J(e.a,"GetForwardChannelUri: "+t),t}function Td(e,t,n){return t=Le(e,e.ia()?t:null,n),J(e.a,"GetBackChannelUri: "+t),t}function Le(e,t,n){var r=Cd(n);if(""!=r.b)t&&od(r,t+"."+r.b),pd(r,r.i);else{var o,i=k.location;o=t?t+"."+i.hostname:i.hostname,r=Dd(i.protocol,o,i.port,n)}return e.U&&Ca(e.U,function(e,t){R(r,t,e)}),t=e.j,n=e.J,t&&n&&R(r,t,n),R(r,"VER",e.pa),ze(e,r),r}function Me(){}function Ne(e){for(var t=arguments[0],n=1;n<arguments.length;n++){var r=arguments[n];if(0==r.lastIndexOf("/",0))t=r;else{var o;(o=""==t)||(o=t.length-1,o=0<=o&&t.indexOf("/",o)==o),t+=o?r:"/"+r}}return t}function Oe(){if(z&&!(10<=Number(Va)))throw Error("Environmental error: no available transport.")}function X(e,t){B.call(this),this.a=new we(t,21),this.b=e,this.s=t&&t.testUrl?t.testUrl:Ne(this.b,"test"),this.f=oc("goog.labs.net.webChannel.WebChannelBaseTransport"),this.g=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.a.i=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),this.a.M=e,(e=t&&t.httpHeadersOverwriteParam)&&!/^[\s\xa0]*$/.test(e)&&(this.a.h=e),this.o=t&&t.supportsCrossDomainXhr||!1,this.m=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!/^[\s\xa0]*$/.test(t)&&(this.a.j=t,null!==(e=this.g)&&t in e&&(e=this.g,t in e&&delete e[t],F(this.f,"Ignore httpSessionIdParam also specified with messageUrlParams: "+t))),this.h=new Pe(this)}function Qe(e){Od.call(this);var t=e.__sm__;if(t){e:{for(var n in t){e=n;break e}e=void 0}(this.c=e)?(e=this.c,this.data=null!==t&&e in t?t[e]:void 0):this.data=t}else this.data=e}function Re(){Pd.call(this),this.status=1}function Pe(e){this.a=e}function Te(){this.b=[],this.a=[]}function Ue(e){return 0==e.b.length&&(e.b=e.a,e.b.reverse(),e.a=[]),e.b.pop()}function Ve(e,t){if(w.call(this),this.h=e||0,this.c=t||10,this.h>this.c)throw Error(We);this.a=new Te,this.b=new T,this.g=null,this.ba()}function Xe(e){if("function"==typeof e.Z)e.Z();else for(var t in e)e[t]=null}function Ye(e,t){this.a=e,this.b=t}function Ze(e){if(this.a=[],e)e:{if(e instanceof Ze){var t=e.O();if(e=e.v(),0>=this.u()){for(var n=this.a,r=0;r<t.length;r++)n.push(new Ye(t[r],e[r]));break e}}else t=Ea(e),e=Da(e);for(r=0;r<t.length;r++)$e(this,t[r],e[r])}}function $e(e,t,n){var r=e.a;for(r.push(new Ye(t,n)),t=r.length-1,n=(e=e.a)[t];0<t&&(r=t-1>>1,e[r].a>n.a);)e[t]=e[r],t=r;e[t]=n}function af(){Ze.call(this)}function Y(e,t){this.f=new af,Ve.call(this,e,t)}function Z(e,t,n,r){this.l=e,this.j=!!r,Y.call(this,t,n)}var g,goog=goog||{},k=this,q="closure_uid_"+(1e9*Math.random()>>>0),fa=0,t=Date.now||function(){return+new Date};u(ka,Error),ka.prototype.name="CustomError";var ma=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")};u(oa,ka),oa.prototype.name="AssertionError";var ra=0,sa={};w.prototype.i=!1,w.prototype.Z=function(){if(!this.i&&(this.i=!0,this.w(),0!=ra)){var e=this[q]||(this[q]=++fa);delete sa[e]}},w.prototype.w=function(){if(this.A)for(;this.A.length;)this.A.shift()()};var ta=Array.prototype.indexOf?function(e,t,n){return Array.prototype.indexOf.call(e,t,n)}:function(e,t,n){if(n=null==n?0:0>n?Math.max(0,e.length+n):n,l(e))return l(t)&&1==t.length?e.indexOf(t,n):-1;for(;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1},ua=Array.prototype.forEach?function(e,t,n){Array.prototype.forEach.call(e,t,n)}:function(e,t,n){for(var r=e.length,o=l(e)?e.split(""):e,i=0;i<r;i++)i in o&&t.call(n,o[i],i,e)},x;e:{var Aa=k.navigator;if(Aa){var Ba=Aa.userAgent;if(Ba){x=Ba;break e}}x=""}var Ga="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");Ia[" "]=ba;var La=y("Opera"),z=y("Trident")||y("MSIE"),Ma=y("Edge"),Na=y("Gecko")&&!(-1!=x.toLowerCase().indexOf("webkit")&&!y("Edge"))&&!(y("Trident")||y("MSIE"))&&!y("Edge"),Oa=-1!=x.toLowerCase().indexOf("webkit")&&!y("Edge"),Qa;e:{var Ra="",Sa=function(){var e=x;return Na?/rv:([^\);]+)(\)|;)/.exec(e):Ma?/Edge\/([\d\.]+)/.exec(e):z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(e):Oa?/WebKit\/(\S+)/.exec(e):La?/(?:Version)[ \/]?(\S+)/.exec(e):void 0}();if(Sa&&(Ra=Sa?Sa[1]:""),z){var Ta=Pa();if(null!=Ta&&Ta>parseFloat(Ra)){Qa=String(Ta);break e}}Qa=Ra}var Ka={},Va,Wa=k.document;Va=Wa&&z?Pa()||("CSS1Compat"==Wa.compatMode?parseInt(Qa,10):5):void 0;var Xa=Object.freeze||function(e){return e},Ya=!z||9<=Number(Va),Za=z&&!Ua("9"),$a=function(){if(!k.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});return k.addEventListener("test",ba,t),k.removeEventListener("test",ba,t),e}();A.prototype.b=function(){this.Qa=!1},u(ab,A);var bb=Xa({2:"touch",3:"pen",4:"mouse"});ab.prototype.b=function(){ab.L.b.call(this);var e=this.c;if(e.preventDefault)e.preventDefault();else if(e.returnValue=!1,Za)try{(e.ctrlKey||112<=e.keyCode&&123>=e.keyCode)&&(e.keyCode=-1)}catch(e){}};var cb="closure_listenable_"+(1e6*Math.random()|0),eb=0;hb.prototype.add=function(e,t,n,r,o){var i=e.toString();(e=this.a[i])||(e=this.a[i]=[],this.b++);var a=ib(e,t,r,o);return-1<a?(t=e[a],n||(t.ca=!1)):(t=new fb(t,this.src,i,!!r,o),t.ca=n,e.push(t)),t};var lb="closure_lm_"+(1e6*Math.random()|0),mb={},Ab="__closure_events_fn_"+(1e9*Math.random()>>>0);u(B,w),B.prototype[cb]=!0,g=B.prototype,g.addEventListener=function(e,t,n,r){ob(this,e,t,n,r)},g.removeEventListener=function(e,t,n,r){wb(this,e,t,n,r)},g.dispatchEvent=function(e){var t,n=this.J;if(n)for(t=[];n;n=n.J)t.push(n);n=this.P;var r=e.type||e;if(l(e))e=new A(e,n);else if(e instanceof A)e.target=e.target||n;else{var o=e;Ha(e=new A(r,n),o)}if(o=!0,t)for(var i=t.length-1;0<=i;i--){var a=e.a=t[i];o=Bb(a,r,!0,e)&&o}if(a=e.a=n,o=Bb(a,r,!0,e)&&o,o=Bb(a,r,!1,e)&&o,t)for(i=0;i<t.length;i++)a=e.a=t[i],o=Bb(a,r,!1,e)&&o;return o},g.w=function(){if(B.L.w.call(this),this.c){var e,t=this.c;for(e in t.a){for(var n=t.a[e],r=0;r<n.length;r++)0,gb(n[r]);delete t.a[e],t.b--}}this.J=null},g.aa=function(e,t,n,r){return this.c.add(String(e),t,!1,n,r)},g.Ia=function(e,t,n,r){return this.c.add(String(e),t,!0,n,r)},g.wa=function(e,t,n,r){var o=this.c;if((e=String(e).toString())in o.a){var i=o.a[e];-1<(t=ib(i,t,n,r))?(gb(i[t]),Array.prototype.splice.call(i,t,1),0==i.length&&(delete o.a[e],o.b--),o=!0):o=!1}else o=!1;return o};var Ib={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\v":"\\u000b"},Jb=/\uffff/.test("")?/[\\"\x00-\x1f\x7f-\uffff]/g:/[\\"\x00-\x1f\x7f-\xff]/g;Kb.prototype.get=function(){if(0<this.b){this.b--;var e=this.a;this.a=e.next,e.next=null}else e=this.c();return e};var C=new Kb(function(){return new Mb},function(e){e.reset()},100);Lb.prototype.add=function(e,t){var n=C.get();n.set(e,t),this.b?this.b.next=n:this.a=n,this.b=n},Mb.prototype.set=function(e,t){this.a=e,this.b=t,this.next=null},Mb.prototype.reset=function(){this.next=this.b=this.a=null};var Rb,Tb,Wb=!1,Pb=new Lb;u(Xb,B),g=Xb.prototype,g.$=!1,g.K=null,g.jb=function(){if(this.$){var e=t()-this.g;0<e&&e<.8*this.b?this.K=this.a.setTimeout(this.f,this.b-e):(this.K&&(this.a.clearTimeout(this.K),this.K=null),this.dispatchEvent("tick"),this.$&&(this.K=this.a.setTimeout(this.f,this.b),this.g=t()))}},g.start=function(){this.$=!0,this.K||(this.K=this.a.setTimeout(this.f,this.b),this.g=t())},g.w=function(){Xb.L.w.call(this),Yb(this),delete this.a},u($b,w),g=$b.prototype,g.ha=!1,g.X=null,g.Ya=function(e){this.a=arguments,this.X?this.ha=!0:ac(this)},g.w=function(){$b.L.w.call(this),this.X&&(k.clearTimeout(this.X),this.X=null,this.ha=!1,this.a=[])},g.cb=function(){this.X=null,this.ha&&(this.ha=!1,ac(this))},u(D,w);var bc=[];D.prototype.aa=function(e,t,r,o){n(t)||(t&&(bc[0]=t.toString()),t=bc);for(var i=0;i<t.length;i++){var a=ob(e,t[i],r||this.handleEvent,o||!1,this.b||this);if(!a)break;this.a[a.key]=a}return this},D.prototype.wa=function(e,t,r,o,i){if(n(t))for(var a=0;a<t.length;a++)this.wa(e,t[a],r,o,i);else r=r||this.handleEvent,o=p(o)?!!o.capture:!!o,i=i||this.b||this,r=qb(r),o=!!o,(t=db(e)?kb(e.c,String(t),r,o,i):e&&(e=sb(e))?kb(e,t,r,o,i):null)&&(xb(t),delete this.a[t.key]);return this},D.prototype.w=function(){D.L.w.call(this),cc(this)},D.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},dc.prototype.a=null;var ec=0;dc.prototype.reset=function(e,n,r,o,i){"number"==typeof i||ec++,o||t(),delete this.a},E.prototype.toString=function(){return this.name};var gc=new E("SEVERE",1e3),hc=new E("WARNING",900),ic=new E("INFO",800),jc=new E("CONFIG",700),kc=new E("FINE",500);fc.prototype.log=function(e,t,n){if(e.value>=lc(this).value)for(ea(t)&&(t=t()),e=new dc(e,String(t),this.f),n&&(e.a=n),n=this;n;)n=n.a};var mc={},nc=null;qc.prototype.Fa=function(){this.b=!1};var yc=new B;u(zc,A),u(Bc,A),u(Cc,A);var Fc={NO_ERROR:0,kb:1,rb:2,qb:3,nb:4,pb:5,sb:6,Sa:7,TIMEOUT:8,vb:9},Gc={mb:"complete",zb:"success",Ta:"error",Sa:"abort",xb:"ready",yb:"readystatechange",TIMEOUT:"timeout",tb:"incrementaldata",wb:"progress",ob:"downloadprogress",Ab:"uploadprogress"};Hc.prototype.a=null;var Kc;u(Lc,Hc),Kc=new Lc;var Nc=45e3,Oc=250,Qc={},Rc={};g=L.prototype,g.setTimeout=function(e){this.S=e},g.gb=function(e){e=e.target;var t=this.I;t&&3==N(e)?(J(this.b,"Throttling readystatechange."),t.Ya()):this.Ra(e)},g.Ra=function(e){try{e==this.a?Yc(this):F(this.b.a,"Called back with an unexpected xmlhttp")}catch(e){if(J(this.b,"Failed call to OnXmlHttpReadyStateChanged_"),this.a&&this.a.V()){var t=this;wc(this.b,e,function(){return"ResponseText: "+t.a.V()})}else wc(this.b,e,"No response text")}},g.fb=function(){var e=N(this.a),t=this.a.V();this.D<t.length&&(Zc(this),$c(this,e,t),this.c&&4!=e&&Wc(this))},g.cancel=function(){this.A=!0,cd(this)},g.eb=function(){this.s=null;var e=t();0<=e-this.U?(this.c&&xc(this.b,"Received watchdog timeout even though request loaded successfully"),vc(this.b,this.g),2!=this.J&&(Ac(),K()),cd(this),this.l=2,dd(this)):(F(this.b.a,"WatchDog timer called too early"),fd(this,this.U-e))},g=O.prototype,g.u=function(){return this.c},g.v=function(){id(this);for(var e=[],t=0;t<this.a.length;t++)e.push(this.b[this.a[t]]);return e},g.O=function(){return id(this),this.a.concat()},g.get=function(e,t){return P(this.b,e)?this.b[e]:t},g.set=function(e,t){P(this.b,e)||(this.c++,this.a.push(e)),this.b[e]=t},g.forEach=function(e,t){for(var n=this.O(),r=0;r<n.length;r++){var o=n[r],i=this.get(o);e.call(t,i,o,this)}};var ld=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;Q.prototype.toString=function(){var e=[],t=this.f;t&&e.push(ud(t,vd,!0),":");var n=this.b;return(n||"file"==t)&&(e.push("//"),(t=this.j)&&e.push(ud(t,vd,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.i)&&e.push(":",String(n))),(n=this.a)&&(this.b&&"/"!=n.charAt(0)&&e.push("/"),e.push(ud(n,"/"==n.charAt(0)?wd:xd,!0))),(n=this.c.toString())&&e.push("?",n),(n=this.g)&&e.push("#",ud(n,yd)),e.join("")},Q.prototype.resolve=function(e){var t=M(this),n=!!e.f;n?nd(t,e.f):n=!!e.j,n?t.j=e.j:n=!!e.b,n?od(t,e.b):n=null!=e.i;var r=e.a;if(n)pd(t,e.i);else if(n=!!e.a){if("/"!=r.charAt(0))if(this.b&&!this.a)r="/"+r;else{var o=t.a.lastIndexOf("/");-1!=o&&(r=t.a.substr(0,o+1)+r)}if(".."==(o=r)||"."==o)r="";else if(-1!=o.indexOf("./")||-1!=o.indexOf("/.")){r=0==o.lastIndexOf("/",0),o=o.split("/");for(var i=[],a=0;a<o.length;){var s=o[a++];"."==s?r&&a==o.length&&i.push(""):".."==s?((1<i.length||1==i.length&&""!=i[0])&&i.pop(),r&&a==o.length&&i.push("")):(i.push(s),r=!0)}r=i.join("/")}else r=o}return n?t.a=r:n=""!==e.c.toString(),n?qd(t,rd(e.c)):n=!!e.g,n&&(t.g=e.g),t};var vd=/[#\/\?@]/g,xd=/[#\?:]/g,wd=/[#\?]/g,Ad=/[#\?@]/g,yd=/#/g;g=td.prototype,g.u=function(){return S(this),this.b},g.add=function(e,t){S(this),this.c=null,e=Fd(this,e);var n=this.a.get(e);return n||this.a.set(e,n=[]),n.push(t),this.b+=1,this},g.forEach=function(e,t){S(this),this.a.forEach(function(n,r){ua(n,function(n){e.call(t,n,r,this)},this)},this)},g.O=function(){S(this);for(var e=this.a.v(),t=this.a.O(),n=[],r=0;r<t.length;r++)for(var o=e[r],i=0;i<o.length;i++)n.push(t[r]);return n},g.v=function(e){S(this);var t=[];if(l(e))Hd(this,e)&&(t=ya(t,this.a.get(Fd(this,e))));else{e=this.a.v();for(var n=0;n<e.length;n++)t=ya(t,e[n])}return t},g.set=function(e,t){return S(this),this.c=null,e=Fd(this,e),Hd(this,e)&&(this.b-=this.a.get(e).length),this.a.set(e,[t]),this.b+=1,this},g.get=function(e,t){return 0<(e=e?this.v(e):[]).length?String(e[0]):t},g.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var e=[],t=this.a.O(),n=0;n<t.length;n++){var r=t[n],o=encodeURIComponent(String(r));r=this.v(r);for(var i=0;i<r.length;i++){var a=o;""!==r[i]&&(a+="="+encodeURIComponent(String(r[i]))),e.push(a)}}return this.c=e.join("&")};var Jd=null;Id.prototype.set=function(e){this.a=e},Id.prototype.reset=function(){this.set(t())},Id.prototype.get=function(){return this.a},u(Ld,Kd);var Nd={OPEN:"a",lb:"b",Ta:"c",ub:"d"};u(Od,A),u(Pd,A),g=Qd.prototype,g.R=null,g.da=function(e){return this.a.da(e)},g.abort=function(){this.c&&(this.c.cancel(),this.c=null),this.f=-1},g.Ka=function(){return!1},g.Na=function(e,t){if(this.f=e.B,0==this.R){if(J(this.b,"TestConnection: Got data for stage 1"),!this.a.G&&(e=e.a)){var n=e.a?e.a.getResponseHeader("X-Client-Wire-Protocol"):null;this.m=n||null,this.a.j&&((e=e.a?e.a.getResponseHeader("X-HTTP-Session-Id"):null)?this.a.J=e:F(this.b.a,"Missing X_HTTP_SESSION_ID in the handshake response"))}if(t){try{var r=this.a.ma.a.parse(t)}catch(e){return wc(this.b,e),void Ud(this.a,this)}this.g=r[0]}else J(this.b,"TestConnection: Null responseText"),Ud(this.a,this)}else 1==this.R&&(this.h?K():"11111"==t?(K(),this.h=!0,(!z||10<=Number(Va))&&(this.f=200,this.c.cancel(),J(this.b,"Test connection succeeded; using streaming connection"),K(),Sd(this.a,this,!0))):(K(),this.h=!1))},g.va=function(){this.f=this.c.B,this.c.c?0==this.R?(this.R=1,J(this.b,"TestConnection: request complete for initial check"),Rd(this)):1==this.R&&(J(this.b,"TestConnection: request complete for stage 2"),this.h?(J(this.b,"Test connection succeeded; using streaming connection"),K(),Sd(this.a,this,!0)):(J(this.b,"Test connection failed; not using streaming"),K(),Sd(this.a,this,!1))):(J(this.b,"TestConnection: request failed, in state "+this.R),0==this.R?K():1==this.R&&K(),Ud(this.a,this))},g.ia=function(){return this.a.ia()},g.sa=function(){return this.a.sa()},T.prototype.u=function(){return this.a.u()},T.prototype.add=function(e){this.a.set(Wd(e),e)},T.prototype.contains=function(e){return e=Wd(e),P(this.a.b,e)},T.prototype.v=function(){return this.a.v()};var Zd=10;Yd.prototype.cancel=function(){this.c=ee(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(ua(this.a.v(),function(e){e.cancel()}),jd(this.a.a))},ge.prototype.stringify=function(e){return k.JSON.stringify(e,this.a)},ge.prototype.parse=function(e){return k.JSON.parse(e,this.b)},u(U,B);var le="";U.prototype.b=oc("goog.net.XhrIo");var me=/^https?$/i,ne=["POST","PUT"];g=U.prototype,g.fa=function(e,t,n,o){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.s+"; newUri="+e);t=t?t.toUpperCase():"GET",this.s=e,this.g="",this.j=0,this.M=t,this.H=!1,this.f=!0,this.a=Mc(this.D?this.D:Kc),this.C=Ic(this.D?this.D:Kc),this.a.onreadystatechange=r(this.Ma,this);try{H(this.b,V(this,"Opening Xhr")),this.I=!0,this.a.open(t,String(e),!0),this.I=!1}catch(e){return H(this.b,V(this,"Error opening Xhr: "+e.message)),void oe(this,e)}e=n||"";var i=new O(this.headers);o&&hd(o,function(e,t){i.set(t,e)}),o=va(i.O()),n=k.FormData&&e instanceof k.FormData,!(0<=ta(ne,t))||o||n||i.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),i.forEach(function(e,t){this.a.setRequestHeader(t,e)},this),this.N&&(this.a.responseType=this.N),"withCredentials"in this.a&&this.a.withCredentials!==this.m&&(this.a.withCredentials=this.m);try{pe(this),0<this.l&&(this.G=qe(this.a),H(this.b,V(this,"Will abort after "+this.l+"ms if incomplete, xhr2 "+this.G)),this.G?(this.a.timeout=this.l,this.a.ontimeout=r(this.Ja,this)):this.B=Zb(this.Ja,this.l,this)),H(this.b,V(this,"Sending request")),this.o=!0,this.a.send(e),this.o=!1}catch(e){H(this.b,V(this,"Send error: "+e.message)),oe(this,e)}},g.Ja=function(){void 0!==goog&&this.a&&(this.g="Timed out after "+this.l+"ms, aborting",this.j=8,H(this.b,V(this,this.g)),this.dispatchEvent("timeout"),this.abort(8))},g.abort=function(e){this.a&&this.f&&(H(this.b,V(this,"Aborting")),this.f=!1,this.h=!0,this.a.abort(),this.h=!1,this.j=e||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),se(this))},g.w=function(){this.a&&(this.f&&(this.f=!1,this.h=!0,this.a.abort(),this.h=!1),se(this,!0)),U.L.w.call(this)},g.Ma=function(){this.i||(this.I||this.o||this.h?te(this):this.bb())},g.bb=function(){te(this)},g.W=function(){try{return 2<N(this)?this.a.status:-1}catch(e){return-1}},g.Ha=function(){try{return 2<N(this)?this.a.statusText:""}catch(e){return H(this.b,"Can not get status: "+e.message),""}},g.V=function(){try{return this.a?this.a.responseText:""}catch(e){return H(this.b,"Can not get responseText: "+e.message),""}},g.Za=function(e){if(this.a){var t=this.a.responseText;e&&0==t.indexOf(e)&&(t=t.substring(e.length));e:{if(e=t,k.JSON)try{var n=k.JSON.parse(e);break e}catch(e){}n=Db(e)}return n}},g.Ga=function(){return this.j},g.$a=function(){return l(this.g)?this.g:String(this.g)},g=we.prototype,g.pa=8,g.F=1,g.Ka=function(){return 0==this.F},g.Pa=function(e){if(this.l=null,J(this.a,"startForwardChannel_"),1==this.F)if(e)xc(this.a,"Not supposed to retry the open");else{J(this.a,"open_()"),this.P=Math.floor(1e5*Math.random()),e=this.P++;var t=new L(this,this.a,0,e,void 0),n=this.i;this.M&&(n?(n=Fa(n),Ha(n,this.M)):n=this.M),null===this.h&&(t.j=n);var r=Ge(this,t),o=M(this.D);R(o,"RID",e),0<this.ya&&R(o,"CVER",this.ya),this.G&&this.j&&R(o,"X-HTTP-Session-Id",this.j),ze(this,o),this.h&&n&&ve(o,this.h,n),ae(this.f,t),this.Ua?(R(o,"$req",r),Sc(t,o,null)):Sc(t,o,r),this.F=2}else 3==this.F&&(e?He(this,e):0==this.g.length?J(this.a,"startForwardChannel_ returned: nothing to send"):be(this.f)?xc(this.a,"startForwardChannel_ returned: connection already in progress"):(He(this),J(this.a,"startForwardChannel_ finished, sent request")))},g.Oa=function(){this.m=null,J(this.a,"Creating new HttpRequest"),this.b=new L(this,this.a,0,"rpc",this.T),null===this.h&&(this.b.j=this.i),this.b.P=0;var e=M(this.xa);R(e,"RID","rpc"),R(e,"SID",this.I),R(e,"CI",this.la?"0":"1"),R(e,"AID",this.N),ze(this,e),R(e,"TYPE","xmlhttp"),this.h&&this.i&&ve(e,this.h,this.i),Vc(this.b,e,!0,this.ja),J(this.a,"New Request created")},g.Na=function(e,t){if(0!=this.F&&(this.b==e||ce(this.f,e)))if(this.s=e.B,ce(this.f,e)&&3==this.F){try{var o=this.ma.a.parse(t)}catch(e){o=null}if(n(o)&&3==o.length)if(0==(t=o)[0])e:if(J(this.a,"Server claims our backchannel is missing."),this.m)J(this.a,"But we are currently starting the request.");else{if(this.b){if(!(this.b.C+3e3<e.C))break e;Be(this),this.b.cancel(),this.b=null}else F(this.a.a,"We do not have a BackChannel established");Je(this),K()}else this.za=t[1],0<(e=this.za-this.N)&&(t=t[2],J(this.a,t+" bytes (in "+e+" arrays) are outstanding on the BackChannel"),37500>t&&this.la&&0==this.A&&!this.o&&(this.o=Ec(r(this.ab,this),6e3)));else J(this.a,"Bad POST response data returned"),W(this,11)}else if(this.b==e&&Be(this),!/^[\s\xa0]*$/.test(t))for(t=o=this.ma.a.parse(t),o=0;o<t.length;o++){var i=t[o];if(this.N=i[0],i=i[1],2==this.F)if("c"==i[0]){this.I=i[1],this.ja=i[2];var a=i[3];null!=a&&(this.pa=a,I(this.a,"VER="+this.pa)),null!=(i=i[4])&&(this.Aa=i,I(this.a,"SVER="+this.Aa)),this.G&&(i=e.a)&&((a=i.a?i.a.getResponseHeader("X-Client-Wire-Protocol"):null)&&$d(this.f,a),this.j&&((i=i.a?i.a.getResponseHeader("X-HTTP-Session-Id"):null)?(this.J=i,R(this.D,this.j,i)):F(this.a.a,"Missing X_HTTP_SESSION_ID in the handshake response"))),this.F=3,this.c&&this.c.Ea(this),this.xa=Td(this,this.ja,this.ka),Ie(this)}else"stop"!=i[0]&&"close"!=i[0]||W(this,7);else 3==this.F&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?W(this,7):xe(this):"noop"!=i[0]&&this.c&&this.c.Da(this,i),this.A=0)}},g.ab=function(){null!=this.o&&(this.o=null,this.b.cancel(),this.b=null,Je(this),K())},g.va=function(e){J(this.a,"Request complete");var n=null;if(this.b==e){Be(this),this.b=null;var r=2}else{if(!ce(this.f,e))return;n=e.o,de(this.f,e),r=1}if(this.s=e.B,0!=this.F)if(e.c)1==r?(Dc((t(),e.C)),De(this)):Ie(this);else{var o=e.l;if(3==o||0==o&&0<this.s)J(this.a,"Not retrying due to error type");else{var i=this;if(J(this.a,function(){return"Maybe retrying, last error: "+Pc(o,i.s)}),1==r&&Ee(this,e)||2==r&&Je(this))return;J(this.a,"Exceeded max number of retries")}switch(n&&0<n.length&&fe(this.f,n),J(this.a,"Error: HTTP request failed"),o){case 1:W(this,5);break;case 4:W(this,10);break;case 3:W(this,6);break;default:W(this,2)}}},g.ib=function(e){e?I(this.a,"Successfully pinged google.com"):I(this.a,"Failed to ping google.com"),K()},g.da=function(e){if(e&&!this.S)throw Error("Can't create secondary domain capable XhrIo object.");return e=new U,e.m=this.S,e},g.sa=function(){return!!this.c&&!0},g.ia=function(){return this.S},new Ld,g=Me.prototype,g.Ea=function(){},g.Da=function(){},g.Ca=function(){},g.oa=function(){},g.Wa=function(){},Oe.prototype.a=function(e,t){return new X(e,t)},u(X,B),X.prototype.j=function(){this.a.c=this.h,this.o&&(this.a.S=!0);var e=this.a,t=this.s,n=this.b,r=this.g||void 0;J(e.a,"connect()"),K(),e.ka=n,e.U=r||{},e.G&&(J(e.a,"connect() bypassed channel-test."),e.H.b=[],e.H.a=!1),J(e.a,"connectTest_()"),e.B=new Qd(e,e.a),null===e.h&&(e.B.i=e.i),n=t,e.h&&e.i&&(n=ve(t,e.h,e.i)),(e=e.B).l=n,t=Ke(e.a,e.l),K(),null!=(n=e.a.H.b)?(e.g=n[0],e.R=1,Rd(e)):(Xc(t,"MODE","init"),!e.a.G&&e.a.j&&Xc(t,"X-HTTP-Session-Id",e.a.j),e.c=new L(e,e.b,0,void 0,void 0),e.c.j=e.i,Vc(e.c,t,!1,null),e.R=0)},X.prototype.close=function(){xe(this.a)},X.prototype.l=function(e){if(l(e)){var t={};t.__data__=e,Ce(this.a,t)}else this.m?(t={},t.__data__=Eb(e),Ce(this.a,t)):Ce(this.a,e)},X.prototype.w=function(){this.a.c=null,delete this.h,xe(this.a),delete this.a,X.L.w.call(this)},u(Qe,Od),u(Re,Pd),u(Pe,Me),Pe.prototype.Ea=function(){pc(this.a.f,"WebChannel opened on "+this.a.b),this.a.dispatchEvent("a")},Pe.prototype.Da=function(e,t){this.a.dispatchEvent(new Qe(t))},Pe.prototype.Ca=function(e,t){pc(this.a.f,"WebChannel aborted on "+this.a.b+" due to channel error: "+t),this.a.dispatchEvent(new Re)},Pe.prototype.oa=function(){pc(this.a.f,"WebChannel closed on "+this.a.b),this.a.dispatchEvent("b")};var Se=ja(function(e,t){function n(){}n.prototype=e.prototype;var r=new n;return e.apply(r,Array.prototype.slice.call(arguments,1)),r},Oe);Te.prototype.u=function(){return this.b.length+this.a.length},Te.prototype.contains=function(e){return 0<=ta(this.b,e)||0<=ta(this.a,e)},Te.prototype.v=function(){for(var e=[],t=this.b.length-1;0<=t;--t)e.push(this.b[t]);var n=this.a.length;for(t=0;t<n;++t)e.push(this.a[t]);return e},u(Ve,w);var We="[goog.structs.Pool] Min can not be greater than max";g=Ve.prototype,g.ea=function(){var e=t();if(!(null!=this.g&&0>e-this.g)){for(var n;0<this.a.u()&&(n=Ue(this.a),!this.ua(n));)this.ba();return!n&&this.u()<this.c&&(n=this.ra()),n&&(this.g=e,this.b.add(n)),n}},g.hb=function(e){return!!kd(this.b.a,Wd(e))&&(this.na(e),!0)},g.na=function(e){kd(this.b.a,Wd(e)),this.ua(e)&&this.u()<this.c?this.a.a.push(e):Xe(e)},g.ba=function(){for(var e=this.a;this.u()<this.h;){var t=this.ra();e.a.push(t)}for(;this.u()>this.c&&0<this.a.u();)Xe(Ue(e))},g.ra=function(){return{}},g.ua=function(e){return"function"!=typeof e.Xa||e.Xa()},g.contains=function(e){return this.a.contains(e)||this.b.contains(e)},g.u=function(){return this.a.u()+this.b.u()},g.w=function(){if(Ve.L.w.call(this),0<this.b.u())throw Error("[goog.structs.Pool] Objects not released");delete this.b;for(var e=this.a;0!=e.b.length||0!=e.a.length;)Xe(Ue(e));delete this.a},Ze.prototype.v=function(){for(var e=this.a,t=[],n=e.length,r=0;r<n;r++)t.push(e[r].b);return t},Ze.prototype.O=function(){for(var e=this.a,t=[],n=e.length,r=0;r<n;r++)t.push(e[r].a);return t},Ze.prototype.u=function(){return this.a.length},u(af,Ze),u(Y,Ve),g=Y.prototype,g.ea=function(e,t){if(!e)return Y.L.ea.call(this);$e(this.f,void 0!==t?t:100,e),this.ta()},g.ta=function(){for(var e=this.f;0<e.u();){var t=this.ea();if(!t)break;var n=e,r=n.a,o=r.length,i=r[0];if(0>=o)i=void 0;else{if(1==o)xa(r);else{r[0]=r.pop(),r=0,o=(n=n.a).length;for(var a=n[r];r<o>>1;){var s=2*r+1,u=2*r+2;if(s=u<o&&n[u].a<n[s].a?u:s,n[s].a>a.a)break;n[r]=n[s],r=s}n[r]=a}i=i.b}i.apply(this,[t])}},g.na=function(e){Y.L.na.call(this,e),this.ta()},g.ba=function(){Y.L.ba.call(this),this.ta()},g.w=function(){Y.L.w.call(this),k.clearTimeout(void 0),xa(this.f.a),this.f=null},u(Z,Y),Z.prototype.ra=function(){var e=new U,t=this.l;return t&&t.forEach(function(t,n){e.headers.set(n,t)}),this.j&&(e.m=!0),e},Z.prototype.ua=function(e){return!e.i&&!e.a},Oe.prototype.createWebChannel=Oe.prototype.a,X.prototype.send=X.prototype.l,X.prototype.open=X.prototype.j,X.prototype.close=X.prototype.close,Fc.NO_ERROR=0,Fc.TIMEOUT=8,Fc.HTTP_ERROR=6,Gc.COMPLETE="complete",Md.EventType=Nd,Nd.OPEN="a",Nd.CLOSE="b",Nd.ERROR="c",Nd.MESSAGE="d",B.prototype.listen=B.prototype.aa,Z.prototype.getObject=Z.prototype.ea,Z.prototype.releaseObject=Z.prototype.hb,U.prototype.listenOnce=U.prototype.Ia,U.prototype.getLastError=U.prototype.$a,U.prototype.getLastErrorCode=U.prototype.Ga,U.prototype.getStatus=U.prototype.W,U.prototype.getStatusText=U.prototype.Ha,U.prototype.getResponseJson=U.prototype.Za,U.prototype.getResponseText=U.prototype.V,U.prototype.getResponseText=U.prototype.V,U.prototype.send=U.prototype.fa,module.exports={createWebChannelTransport:Se,ErrorCode:Fc,EventType:Gc,WebChannel:Md,XhrIoPool:Z}}).call("undefined"!=typeof window?window:commonjsGlobal)}),dist_1=dist.createWebChannelTransport,dist_2=dist.ErrorCode,dist_3=dist.EventType,dist_4=dist.WebChannel,dist_5=dist.XhrIoPool,StreamBridge=function(){function e(e){this.wrappedOnOpen=null,this.wrappedOnClose=null,this.wrappedOnMessage=null,this.sendFn=e.sendFn,this.closeFn=e.closeFn}return e.prototype.onOpen=function(e){assert$1(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=e},e.prototype.onClose=function(e){assert$1(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=e},e.prototype.onMessage=function(e){assert$1(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=e},e.prototype.close=function(){this.closeFn()},e.prototype.send=function(e){this.sendFn(e)},e.prototype.callOnOpen=function(){assert$1(null!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},e.prototype.callOnClose=function(e){assert$1(null!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(e)},e.prototype.callOnMessage=function(e){assert$1(null!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(e)},e}(),LOG_TAG="Connection",RPC_URL_VERSION="v1beta1",X_GOOG_API_CLIENT_VALUE="gl-js/ fire/"+SDK_VERSION,XHR_TIMEOUT_SECS=15,WebChannelConnection=function(){function e(e){this.databaseId=e.databaseId,this.pool=new dist_5;var t=e.ssl?"https":"http";this.baseUrl=t+"://"+e.host}return e.prototype.modifyHeadersForRequest=function(e,t){if(t)for(var n in t.authHeaders)t.authHeaders.hasOwnProperty(n)&&(e[n]=t.authHeaders[n]);e["X-Goog-Api-Client"]=X_GOOG_API_CLIENT_VALUE,e["google-cloud-resource-prefix"]="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},e.prototype.invoke=function(e,t,n){var r=this,o=this.makeUrl(e);return new Promise(function(i,a){r.pool.getObject(function(s){s.listenOnce(dist_3.COMPLETE,function(){try{switch(s.getLastErrorCode()){case dist_2.NO_ERROR:var t=s.getResponseJson();debug(LOG_TAG,"XHR received:",JSON.stringify(t)),i(t);break;case dist_2.TIMEOUT:debug(LOG_TAG,'RPC "'+e+'" timed out'),a(new FirestoreError(Code.DEADLINE_EXCEEDED,"Request time out"));break;case dist_2.HTTP_ERROR:var n=s.getStatus();debug(LOG_TAG,'RPC "'+e+'" failed with status:',n,"response text:",s.getResponseText()),n>0?a(new FirestoreError(mapCodeFromHttpStatus(n),"Server responded with status "+s.getStatusText())):(debug(LOG_TAG,'RPC "'+e+'" failed'),a(new FirestoreError(Code.UNAVAILABLE,"Connection failed.")));break;default:fail('RPC "'+e+'" failed with unanticipated webchannel error '+s.getLastErrorCode()+": "+s.getLastError()+", giving up.")}}finally{debug(LOG_TAG,'RPC "'+e+'" completed.'),r.pool.releaseObject(s)}});var u=JSON.stringify(t);debug(LOG_TAG,"XHR sending: ",o+" "+u);var c={"Content-Type":"text/plain"};r.modifyHeadersForRequest(c,n),s.send(o,"POST",u,c,XHR_TIMEOUT_SECS)})})},e.prototype.openStream=function(t,n){var r=e.RPC_STREAM_SERVICE_MAPPING[t],o=e.RPC_STREAM_NAME_MAPPING[t];r&&o||fail("Unknown RPC name: "+t);var i=[this.baseUrl,"/",r,"/",o,"/channel"],a=dist_1(),s={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},sendRawJson:!0,supportsCrossDomainXhr:!0};this.modifyHeadersForRequest(s.initMessageHeaders,n);var u=i.join("");debug(LOG_TAG,"Creating WebChannel: "+u+" "+s);var c=a.createWebChannel(u,s),h=!1,l=!1,f=new StreamBridge({sendFn:function(e){l?debug(LOG_TAG,"Not sending because WebChannel is closed:",e):(h||(debug(LOG_TAG,"Opening WebChannel transport."),c.open(),h=!0),debug(LOG_TAG,"WebChannel sending:",e),c.send(e))},closeFn:function(){return c.close()}}),d=function(e,t){c.listen(e,function(e){try{t(e)}catch(e){setTimeout(function(){throw e},0)}})};return d(dist_4.EventType.OPEN,function(){l||debug(LOG_TAG,"WebChannel transport opened.")}),d(dist_4.EventType.CLOSE,function(){l||(l=!0,debug(LOG_TAG,"WebChannel transport closed"),f.callOnClose())}),d(dist_4.EventType.ERROR,function(e){l||(l=!0,debug(LOG_TAG,"WebChannel transport errored:",e),f.callOnClose(new FirestoreError(Code.UNAVAILABLE,"The operation could not be completed")))}),d(dist_4.EventType.MESSAGE,function(e){if(!l){var t=e.data[0];assert$1(!!t,"Got a webchannel message without data.");var n=t.error||t[0]&&t[0].error;if(n){debug(LOG_TAG,"WebChannel received error:",n);var r=n.status,o=mapCodeFromRpcStatus(r),i=n.message;void 0===o&&(o=Code.INTERNAL,i="Unknown error status: "+r+" with message "+n.message),l=!0,f.callOnClose(new FirestoreError(o,i)),c.close()}else debug(LOG_TAG,"WebChannel received:",t),f.callOnMessage(t)}}),setTimeout(function(){f.callOnOpen()},0),f},e.prototype.makeUrl=function(e){var t=[this.baseUrl,"/",RPC_URL_VERSION];return t.push("/projects/"),t.push(this.databaseId.projectId),t.push("/databases/"),t.push(this.databaseId.database),t.push("/documents"),t.push(":"),t.push(e),t.join("")},e.RPC_STREAM_SERVICE_MAPPING={Write:"google.firestore.v1beta1.Firestore",Listen:"google.firestore.v1beta1.Firestore"},e.RPC_STREAM_NAME_MAPPING={Write:"Write",Listen:"Listen"},e}(),BrowserPlatform=function(){function e(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return e.prototype.loadConnection=function(e){return Promise.resolve(new WebChannelConnection(e))},e.prototype.newSerializer=function(e){return new JsonProtoSerializer(e,{useProto3Json:!0})},e.prototype.atob=function(e){return atob(e)},e.prototype.btoa=function(e){return btoa(e)},e}();PlatformSupport.setPlatform(new BrowserPlatform);var FieldPath$1=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateNamedArrayAtLeastNumberOfElements("FieldPath",e,"fieldNames",1);for(var n=0;n<e.length;++n)if(validateArgType("FieldPath","string",n,e[n]),0===e[n].length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new FieldPath(e)}return e.documentId=function(){return e._DOCUMENT_ID},e._DOCUMENT_ID=new e(FieldPath.keyField().canonicalString()),e}(),RESERVED=new RegExp("[~\\*/\\[\\]]"),OnlineState;!function(e){e[e.Unknown=0]="Unknown",e[e.Healthy=1]="Healthy",e[e.Failed=2]="Failed"}(OnlineState=OnlineState||(OnlineState={}));var ChangeType;!function(e){e[e.Added=0]="Added",e[e.Removed=1]="Removed",e[e.Modified=2]="Modified",e[e.Metadata=3]="Metadata"}(ChangeType=ChangeType||(ChangeType={}));var SyncState;!function(e){e[e.Local=0]="Local",e[e.Synced=1]="Synced"}(SyncState=SyncState||(SyncState={}));var DocumentChangeSet=function(){function e(){this.changeMap=new SortedMap(DocumentKey.comparator)}return e.prototype.track=function(e){var t=e.doc.key,n=this.changeMap.get(t);n?e.type!==ChangeType.Added&&n.type===ChangeType.Metadata?this.changeMap=this.changeMap.insert(t,e):e.type===ChangeType.Metadata&&n.type!==ChangeType.Removed?this.changeMap=this.changeMap.insert(t,{type:n.type,doc:e.doc}):e.type===ChangeType.Modified&&n.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(t,{type:ChangeType.Modified,doc:e.doc}):e.type===ChangeType.Modified&&n.type===ChangeType.Added?this.changeMap=this.changeMap.insert(t,{type:ChangeType.Added,doc:e.doc}):e.type===ChangeType.Removed&&n.type===ChangeType.Added?this.changeMap=this.changeMap.remove(t):e.type===ChangeType.Removed&&n.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(t,{type:ChangeType.Removed,doc:n.doc}):e.type===ChangeType.Added&&n.type===ChangeType.Removed?this.changeMap=this.changeMap.insert(t,{type:ChangeType.Modified,doc:e.doc}):fail("unsupported combination of changes: "+JSON.stringify(e)+" after "+JSON.stringify(n)):this.changeMap=this.changeMap.insert(t,e)},e.prototype.getChanges=function(){var e=[];return this.changeMap.inorderTraversal(function(t,n){e.push(n)}),e},e}(),DocumentSet=function(){function e(e){this.comparator=e?function(t,n){return e(t,n)||DocumentKey.comparator(t.key,n.key)}:function(e,t){return DocumentKey.comparator(e.key,t.key)},this.keyedMap=documentMap(),this.sortedSet=new SortedMap(this.comparator)}return e.emptySet=function(t){return new e(t.comparator)},e.prototype.has=function(e){return null!=this.keyedMap.get(e)},e.prototype.get=function(e){return this.keyedMap.get(e)},e.prototype.first=function(){return this.sortedSet.minKey()},e.prototype.last=function(){return this.sortedSet.maxKey()},e.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},e.prototype.prevDoc=function(e){assert$1(this.has(e),"Trying to get a previous document to non-existing key: "+e);var t=this.keyedMap.get(e);return this.sortedSet.getPredecessorKey(t)},e.prototype.indexOf=function(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1},Object.defineProperty(e.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){this.sortedSet.inorderTraversal(function(t,n){return e(t),!1})},e.prototype.add=function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))},e.prototype.delete=function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this},e.prototype.equals=function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();n.hasNext();){var o=n.getNext().key,i=r.getNext().key;if(!o.equals(i))return!1}return!0},e.prototype.toString=function(){var e=[];return this.forEach(function(t){e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"},e.prototype.copy=function(t,n){var r=new e;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=n,r},e}(),ObjectMap=function(){function e(e){this.mapKeyFn=e,this.inner={}}return e.prototype.get=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(var r=0,o=n;r<o.length;r++){var i=o[r],a=i[0],s=i[1];if(a.equals(e))return s}},e.prototype.has=function(e){return void 0!==this.get(e)},e.prototype.set=function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0!==r){for(var o=0;o<r.length;o++)if(r[o][0].equals(e))return void(r[o]=[e,t]);r.push([e,t])}else this.inner[n]=[[e,t]]},e.prototype.delete=function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(n[r][0].equals(e))return 1===n.length?delete this.inner[t]:n.splice(r,1),!0;return!1},e.prototype.forEach=function(e){forEach$1(this.inner,function(t,n){for(var r=0,o=n;r<o.length;r++){var i=o[r],a=i[0],s=i[1];e(a,s)}})},e.prototype.isEmpty=function(){return isEmpty$1(this.inner)},e}(),QueryListenersInfo=function(){return function(){this.listeners=[]}}(),EventManager=function(){function e(e){this.syncEngine=e,this.queries=new ObjectMap(function(e){return e.canonicalId()}),this.onlineState=OnlineState.Unknown,this.syncEngine.subscribe(this.onChange.bind(this),this.onError.bind(this))}return e.prototype.listen=function(e){var t=e.query,n=!1,r=this.queries.get(t);return r||(n=!0,r=new QueryListenersInfo,this.queries.set(t,r)),r.listeners.push(e),e.onOnlineStateChanged(this.onlineState),r.viewSnap&&e.onViewSnapshot(r.viewSnap),n?this.syncEngine.listen(t).then(function(e){return r.targetId=e,e}):Promise.resolve(r.targetId)},e.prototype.unlisten=function(e){var t=e.query,n=!1,r=this.queries.get(t);if(r){var o=r.listeners.indexOf(e);o>=0&&(r.listeners.splice(o,1),n=0===r.listeners.length)}return n?(this.queries.delete(t),this.syncEngine.unlisten(t)):Promise.resolve()},e.prototype.onChange=function(e){for(var t=0,n=e;t<n.length;t++){var r=n[t],o=r.query,i=this.queries.get(o);if(i){for(var a=0,s=i.listeners;a<s.length;a++)s[a].onViewSnapshot(r);i.viewSnap=r}}},e.prototype.onError=function(e,t){var n=this.queries.get(e);if(n)for(var r=0,o=n.listeners;r<o.length;r++)o[r].onError(t);this.queries.delete(e)},e.prototype.onOnlineStateChanged=function(e){this.onlineState=e,this.queries.forEach(function(t,n){for(var r=0,o=n.listeners;r<o.length;r++)o[r].onOnlineStateChanged(e)})},e}(),QueryListener=function(){function e(e,t,n){this.query=e,this.queryObserver=t,this.raisedInitialEvent=!1,this.onlineState=OnlineState.Unknown,this.options=n||{}}return e.prototype.onViewSnapshot=function(e){if(assert$1(e.docChanges.length>0||e.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeDocumentMetadataChanges){for(var t=[],n=0,r=e.docChanges;n<r.length;n++){var o=r[n];o.type!==ChangeType.Metadata&&t.push(o)}e={query:e.query,docs:e.docs,oldDocs:e.oldDocs,docChanges:t,fromCache:e.fromCache,hasPendingWrites:e.hasPendingWrites,syncStateChanged:e.syncStateChanged}}this.raisedInitialEvent?this.shouldRaiseEvent(e)&&this.queryObserver.next(e):this.shouldRaiseInitialEvent(e,this.onlineState)&&this.raiseInitialEvent(e),this.snap=e},e.prototype.onError=function(e){this.queryObserver.error(e)},e.prototype.onOnlineStateChanged=function(e){this.onlineState=e,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,e)&&this.raiseInitialEvent(this.snap)},e.prototype.shouldRaiseInitialEvent=function(e,t){if(assert$1(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!e.fromCache)return!0;var n=t!==OnlineState.Failed;return this.options.waitForSyncWhenOnline&&n?(assert$1(e.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!e.docs.isEmpty()||t===OnlineState.Failed},e.prototype.shouldRaiseEvent=function(e){if(e.docChanges.length>0)return!0;var t=this.snap&&this.snap.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeQueryMetadataChanges},e.prototype.raiseInitialEvent=function(t){assert$1(!this.raisedInitialEvent,"Trying to raise initial events for second time"),t={query:t.query,docs:t.docs,oldDocs:DocumentSet.emptySet(t.docs),docChanges:e.getInitialViewChanges(t),fromCache:t.fromCache,hasPendingWrites:t.hasPendingWrites,syncStateChanged:!0},this.raisedInitialEvent=!0,this.queryObserver.next(t)},e.getInitialViewChanges=function(e){var t=[];return e.docs.forEach(function(e){t.push({type:ChangeType.Added,doc:e})}),t},e}(),PersistencePromise=function(){function e(e){var t=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=null,this.isDone=!1,this.callbackAttached=!1,e(function(e){t.isDone=!0,t.result=e,t.nextCallback&&t.nextCallback(e)},function(e){t.isDone=!0,t.error=e,t.catchCallback&&t.catchCallback(e)})}return e.prototype.catch=function(e){return this.next(void 0,e)},e.prototype.next=function(t,n){var r=this;return this.callbackAttached&&fail("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(t,this.result):new e(function(e,o){r.nextCallback=function(n){r.wrapSuccess(t,n).next(e,o)},r.catchCallback=function(t){r.wrapFailure(n,t).next(e,o)}})},e.prototype.toPromise=function(){var e=this;return new Promise(function(t,n){e.next(t,n)})},e.prototype.wrapUserFunction=function(t){try{var n=t();return n instanceof e?n:e.resolve(n)}catch(t){return e.reject(t)}},e.prototype.wrapSuccess=function(t,n){return t?this.wrapUserFunction(function(){return t(n)}):e.resolve(n)},e.prototype.wrapFailure=function(t,n){return t?this.wrapUserFunction(function(){return t(n)}):e.reject(n)},e.resolve=function(t){return new e(function(e,n){e(t)})},e.reject=function(t){return new e(function(e,n){n(t)})},e.waitFor=function(t){return t.reduce(function(e,t,n){return e.next(function(){return t})},e.resolve())},e.map=function(t){var n=[],r=!0,o=e.resolve(null);return t.reduce(function(e,t){return e.next(function(e){return r||n.push(e),r=!1,t})},o).next(function(e){return n.push(e),n})},e}(),EagerGarbageCollector=function(){function e(){this.isEager=!0,this.sources=[],this.potentialGarbage=documentKeySet()}return e.prototype.addGarbageSource=function(e){this.sources.push(e),e.setGarbageCollector(this)},e.prototype.removeGarbageSource=function(e){this.sources.splice(this.sources.indexOf(e),1),e.setGarbageCollector(null)},e.prototype.addPotentialGarbageKey=function(e){this.potentialGarbage=this.potentialGarbage.add(e)},e.prototype.collectGarbage=function(e){var t=this,n=[],r=documentKeySet();return this.potentialGarbage.forEach(function(o){var i=t.documentHasAnyReferences(e,o);n.push(i.next(function(e){return e||(r=r.add(o)),PersistencePromise.resolve()}))}),this.potentialGarbage=documentKeySet(),PersistencePromise.waitFor(n).next(function(){return r})},e.prototype.documentHasAnyReferences=function(e,t){var n=PersistencePromise.resolve(!1);return this.sources.map(function(n){return function(){return n.containsKey(e,t)}}).reduce(function(e,t){return e.next(function(e){return e?PersistencePromise.resolve(!0):t()})},n)},e}(),LocalViewChanges=function(){function e(e,t,n){this.query=e,this.addedKeys=t,this.removedKeys=n}return e.fromSnapshot=function(t){for(var n=documentKeySet(),r=documentKeySet(),o=0,i=t.docChanges;o<i.length;o++){var a=i[o];switch(a.type){case ChangeType.Added:n=n.add(a.doc.key);break;case ChangeType.Removed:r=r.add(a.doc.key)}}return new e(t.query,n,r)},e}(),ReferenceSet=function(){function e(){this.refsByKey=new SortedSet(DocReference.compareByKey),this.refsByTarget=new SortedSet(DocReference.compareByTargetId),this.garbageCollector=null}return e.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},e.prototype.addReference=function(e,t){var n=new DocReference(e,t);this.refsByKey=this.refsByKey.add(n),this.refsByTarget=this.refsByTarget.add(n)},e.prototype.addReferences=function(e,t){var n=this;e.forEach(function(e){return n.addReference(e,t)})},e.prototype.removeReference=function(e,t){this.removeRef(new DocReference(e,t))},e.prototype.removeReferences=function(e,t){var n=this;e.forEach(function(e){return n.removeReference(e,t)})},e.prototype.removeReferencesForId=function(e){var t=this,n=DocumentKey.EMPTY,r=new DocReference(n,e),o=new DocReference(n,e+1);this.refsByTarget.forEachInRange([r,o],function(e){t.removeRef(e)})},e.prototype.removeAllReferences=function(){var e=this;this.refsByKey.forEach(function(t){return e.removeRef(t)})},e.prototype.removeRef=function(e){this.refsByKey=this.refsByKey.delete(e),this.refsByTarget=this.refsByTarget.delete(e),null!==this.garbageCollector&&this.garbageCollector.addPotentialGarbageKey(e.key)},e.prototype.referencesForId=function(e){var t=DocumentKey.EMPTY,n=new DocReference(t,e),r=new DocReference(t,e+1),o=documentKeySet();return this.refsByTarget.forEachInRange([n,r],function(e){o=o.add(e.key)}),o},e.prototype.setGarbageCollector=function(e){this.garbageCollector=e},e.prototype.containsKey=function(e,t){var n=new DocReference(t,0),r=this.refsByKey.firstAfterOrEqual(n);return PersistencePromise.resolve(null!==r&&t.equals(r.key))},e}(),DocReference=function(){function e(e,t){this.key=e,this.targetOrBatchId=t}return e.compareByKey=function(e,t){return DocumentKey.comparator(e.key,t.key)||primitiveComparator(e.targetOrBatchId,t.targetOrBatchId)},e.compareByTargetId=function(e,t){return primitiveComparator(e.targetOrBatchId,t.targetOrBatchId)||DocumentKey.comparator(e.key,t.key)},e}(),RESERVED_BITS=1,GeneratorIds;!function(e){e[e.LocalStore=0]="LocalStore",e[e.SyncEngine=1]="SyncEngine"}(GeneratorIds||(GeneratorIds={}));var TargetIdGenerator=function(){function e(e,t){void 0===t&&(t=0),this.generatorId=e;var n=t>>RESERVED_BITS<<RESERVED_BITS,r=t-n;this.previousId=r>=e?n|this.generatorId:(n|this.generatorId)-(1<<RESERVED_BITS)}return e.prototype.next=function(){return this.previousId+=1<<RESERVED_BITS,this.previousId},e.forLocalStore=function(t){return void 0===t&&(t=0),new e(GeneratorIds.LocalStore,t)},e.forSyncEngine=function(){return new e(GeneratorIds.SyncEngine)},e}(),AddedLimboDocument=function(){return function(e){this.key=e}}(),RemovedLimboDocument=function(){return function(e){this.key=e}}(),View=function(){function e(e,t){this.query=e,this.syncedDocuments=t,this.syncState=null,this.current=!1,this.limboDocuments=documentKeySet(),this.mutatedKeys=documentKeySet(),this.documentSet=new DocumentSet(e.docComparator.bind(e))}return e.prototype.computeDocChanges=function(e,t){var n=this,r=t?t.changeSet:new DocumentChangeSet,o=t?t.documentSet:this.documentSet,i=t?t.mutatedKeys:this.mutatedKeys,a=o,s=!1,u=this.query.hasLimit()&&o.size===this.query.limit?o.last():null;if(e.inorderTraversal(function(e,t){var c=o.get(e),h=t instanceof Document?t:null;if(h&&(assert$1(e.equals(h.key),"Mismatching keys found in document changes: "+e+" != "+h.key),h=n.query.matches(h)?h:null),h?(a=a.add(h),i=h.hasLocalMutations?i.add(e):i.delete(e)):(a=a.delete(e),i=i.delete(e)),c&&h){var l=c.data.equals(h.data);l&&c.hasLocalMutations===h.hasLocalMutations||(l?r.track({type:ChangeType.Metadata,doc:h}):r.track({type:ChangeType.Modified,doc:h}),u&&n.query.docComparator(h,u)>0&&(s=!0))}else!c&&h?r.track({type:ChangeType.Added,doc:h}):c&&!h&&(r.track({type:ChangeType.Removed,doc:c}),u&&(s=!0))}),this.query.hasLimit())for(;a.size>this.query.limit;){var c=a.last();a=a.delete(c.key),r.track({type:ChangeType.Removed,doc:c})}return assert$1(!s||!t,"View was refilled using docs that themselves needed refilling."),{documentSet:a,changeSet:r,needsRefill:s,mutatedKeys:i}},e.prototype.applyChanges=function(e,t){var n=this;assert$1(!e.needsRefill,"Cannot apply changes that need a refill");var r=this.documentSet;this.documentSet=e.documentSet,this.mutatedKeys=e.mutatedKeys;var o=e.changeSet.getChanges();o.sort(function(e,t){return compareChangeType(e.type,t.type)||n.query.docComparator(e.doc,t.doc)});var i=this.applyTargetChange(t),a=0===this.limboDocuments.size&&this.current?SyncState.Synced:SyncState.Local,s=a!==this.syncState;return this.syncState=a,0!==o.length||s?{snapshot:{query:this.query,docs:e.documentSet,oldDocs:r,docChanges:o,fromCache:a===SyncState.Local,syncStateChanged:s,hasPendingWrites:!e.mutatedKeys.isEmpty()},limboChanges:i}:{limboChanges:i}},e.prototype.shouldBeInLimbo=function(e){return!this.syncedDocuments.has(e)&&(!!this.documentSet.has(e)&&!this.documentSet.get(e).hasLocalMutations)},e.prototype.applyTargetChange=function(e){var t=this;if(e){var n=e.mapping;switch(n instanceof ResetMapping?this.syncedDocuments=n.documents:n instanceof UpdateMapping&&(this.syncedDocuments=n.applyToKeySet(this.syncedDocuments)),e.currentStatusUpdate){case CurrentStatusUpdate.MarkCurrent:this.current=!0;break;case CurrentStatusUpdate.MarkNotCurrent:this.current=!1;break;case CurrentStatusUpdate.None:break;default:fail("Unknown current status update: "+e.currentStatusUpdate)}}var r=this.limboDocuments;this.limboDocuments=documentKeySet(),this.current&&this.documentSet.forEach(function(e){t.shouldBeInLimbo(e.key)&&(t.limboDocuments=t.limboDocuments.add(e.key))});var o=[];return r.forEach(function(e){t.limboDocuments.has(e)||o.push(new RemovedLimboDocument(e))}),this.limboDocuments.forEach(function(e){r.has(e)||o.push(new AddedLimboDocument(e))}),o},e}(),LOG_TAG$2="SyncEngine",QueryView=function(){return function(e,t,n,r){this.query=e,this.targetId=t,this.resumeToken=n,this.view=r}}(),SyncEngine=function(){function e(e,t,n){this.localStore=e,this.remoteStore=t,this.currentUser=n,this.viewHandler=null,this.errorHandler=null,this.queryViewsByQuery=new ObjectMap(function(e){return e.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new SortedMap(DocumentKey.comparator),this.limboKeysByTarget={},this.limboDocumentRefs=new ReferenceSet,this.limboCollector=new EagerGarbageCollector,this.mutationUserCallbacks={},this.targetIdGenerator=TargetIdGenerator.forSyncEngine()}return e.prototype.subscribe=function(e,t){assert$1(null!==e&&null!==t,"View and error handlers cannot be null"),assert$1(null===this.viewHandler&&null===this.errorHandler,"SyncEngine already has a subscriber."),this.viewHandler=e,this.errorHandler=t,this.limboCollector.addGarbageSource(this.limboDocumentRefs)},e.prototype.listen=function(e){var t=this;return this.assertSubscribed("listen()"),assert$1(!this.queryViewsByQuery.has(e),"We already listen to the query: "+e),this.localStore.allocateQuery(e).then(function(n){return t.localStore.executeQuery(e).then(function(r){return t.localStore.remoteDocumentKeys(n.targetId).then(function(o){var i=new View(e,o),a=i.computeDocChanges(r),s=i.applyChanges(a);assert$1(0===s.limboChanges.length,"View returned limbo docs before target ack from the server."),assert$1(!!s.snapshot,"applyChanges for new view should always return a snapshot");var u=new QueryView(e,n.targetId,n.resumeToken,i);t.queryViewsByQuery.set(e,u),t.queryViewsByTarget[n.targetId]=u,t.viewHandler([s.snapshot]),t.remoteStore.listen(n)})}).then(function(){return n.targetId})})},e.prototype.unlisten=function(e){var t=this;this.assertSubscribed("unlisten()");var n=this.queryViewsByQuery.get(e);return assert$1(!!n,"Trying to unlisten on query not found:"+e),this.localStore.releaseQuery(e).then(function(){return t.remoteStore.unlisten(n.targetId),t.removeAndCleanupQuery(n).then(function(){return t.localStore.collectGarbage()})})},e.prototype.write=function(e,t){var n=this;return this.assertSubscribed("write()"),this.localStore.localWrite(e).then(function(e){return n.addMutationCallback(e.batchId,t),n.emitNewSnapsAndNotifyLocalStore(e.changes)}).then(function(){return n.remoteStore.fillWritePipeline()})},e.prototype.wrapUpdateFunctionError=function(e){return e},e.prototype.runTransaction=function(e,t){var n=this;void 0===t&&(t=5),assert$1(t>=0,"Got negative number of retries for transaction.");var r=this.remoteStore.createTransaction();return function(){try{var t=e(r);return!isNullOrUndefined(t)&&t.catch&&t.then?t.catch(function(e){return Promise.reject(n.wrapUpdateFunctionError(e))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(e){return Promise.reject(n.wrapUpdateFunctionError(e))}}().then(function(o){return r.commit().then(function(){return o}).catch(function(r){return 0===t?Promise.reject(r):n.runTransaction(e,t-1)})})},e.prototype.applyRemoteEvent=function(e){var t=this;return this.assertSubscribed("applyRemoteEvent()"),forEachNumber(e.targetChanges,function(n,r){var o=t.limboKeysByTarget[n];o&&r.currentStatusUpdate===CurrentStatusUpdate.MarkCurrent&&!e.documentUpdates.get(o)&&e.addDocumentUpdate(new NoDocument(o,e.snapshotVersion))}),this.localStore.applyRemoteEvent(e).then(function(n){return t.emitNewSnapsAndNotifyLocalStore(n,e)})},e.prototype.rejectListen=function(e,t){var n=this;this.assertSubscribed("rejectListens()");var r=this.limboKeysByTarget[e];if(r){this.limboTargetsByKey=this.limboTargetsByKey.remove(r),delete this.limboKeysByTarget[e];var o=new SortedMap(DocumentKey.comparator);o=o.insert(r,new NoDocument(r,SnapshotVersion.forDeletedDoc()));var i=new RemoteEvent(SnapshotVersion.MIN,{},o);return this.applyRemoteEvent(i)}var a=this.queryViewsByTarget[e];return assert$1(!!a,"Unknown targetId: "+e),this.localStore.releaseQuery(a.query).then(function(){return n.removeAndCleanupQuery(a).then(function(){n.errorHandler(a.query,t)})})},e.prototype.applySuccessfulWrite=function(e){var t=this;return this.assertSubscribed("applySuccessfulWrite()"),this.processUserCallback(e.batch.batchId,null),this.localStore.acknowledgeBatch(e).then(function(e){return t.emitNewSnapsAndNotifyLocalStore(e)})},e.prototype.rejectFailedWrite=function(e,t){var n=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(e,t),this.localStore.rejectBatch(e).then(function(e){return n.emitNewSnapsAndNotifyLocalStore(e)})},e.prototype.addMutationCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];n||(n=new SortedMap(primitiveComparator)),n=n.insert(e,t),this.mutationUserCallbacks[this.currentUser.toKey()]=n},e.prototype.processUserCallback=function(e,t){var n=this.mutationUserCallbacks[this.currentUser.toKey()];if(n){var r=n.get(e);r&&(assert$1(e===n.minKey(),"Mutation callbacks processed out-of-order?"),t?r.reject(t):r.resolve(),n=n.remove(e)),this.mutationUserCallbacks[this.currentUser.toKey()]=n}},e.prototype.removeAndCleanupQuery=function(e){return this.queryViewsByQuery.delete(e.query),delete this.queryViewsByTarget[e.targetId],this.limboDocumentRefs.removeReferencesForId(e.targetId),this.gcLimboDocuments()},e.prototype.updateTrackedLimbos=function(e,t){for(var n=0,r=t;n<r.length;n++){var o=r[n];o instanceof AddedLimboDocument?(this.limboDocumentRefs.addReference(o.key,e),this.trackLimboChange(o)):o instanceof RemovedLimboDocument?(debug(LOG_TAG$2,"Document no longer in limbo: "+o.key),this.limboDocumentRefs.removeReference(o.key,e)):fail("Unknown limbo change: "+JSON.stringify(o))}return this.gcLimboDocuments()},e.prototype.trackLimboChange=function(e){var t=e.key;if(!this.limboTargetsByKey.get(t)){debug(LOG_TAG$2,"New document in limbo: "+t);var n=this.targetIdGenerator.next(),r=Query.atPath(t.path);this.limboKeysByTarget[n]=t,this.remoteStore.listen(new QueryData(r,n,QueryPurpose.Listen)),this.limboTargetsByKey=this.limboTargetsByKey.insert(t,n)}},e.prototype.gcLimboDocuments=function(){var e=this;return this.limboCollector.collectGarbage(null).next(function(t){t.forEach(function(t){var n=e.limboTargetsByKey.get(t);null!==n&&(e.remoteStore.unlisten(n),e.limboTargetsByKey=e.limboTargetsByKey.remove(t),delete e.limboKeysByTarget[n])})}).toPromise()},e.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},e.prototype.emitNewSnapsAndNotifyLocalStore=function(e,t){var n=this,r=[],o=[],i=[];return this.queryViewsByQuery.forEach(function(a,s){i.push(Promise.resolve().then(function(){var t=s.view.computeDocChanges(e);return t.needsRefill?n.localStore.executeQuery(s.query).then(function(e){return s.view.computeDocChanges(e,t)}):t}).then(function(e){var i=t&&t.targetChanges[s.targetId],a=s.view.applyChanges(e,i);return n.updateTrackedLimbos(s.targetId,a.limboChanges).then(function(){if(a.snapshot){r.push(a.snapshot);var e=LocalViewChanges.fromSnapshot(a.snapshot);o.push(e)}})}))}),Promise.all(i).then(function(){return n.viewHandler(r),n.localStore.notifyLocalViewChanges(o)}).then(function(){return n.localStore.collectGarbage()})},e.prototype.assertSubscribed=function(e){assert$1(null!==this.viewHandler&&null!==this.errorHandler,"Trying to call "+e+" before calling subscribe().")},e.prototype.handleUserChange=function(e){var t=this;return this.currentUser=e,this.localStore.handleUserChange(e).then(function(e){return t.emitNewSnapsAndNotifyLocalStore(e)}).then(function(){return t.remoteStore.handleUserChange(e)})},e}(),BATCHID_UNKNOWN=-1,MutationBatch=function(){function e(e,t,n){this.batchId=e,this.localWriteTime=t,this.mutations=n}return e.prototype.applyToRemoteDocument=function(e,t,n){t&&assert$1(t.key.equals(e),"applyToRemoteDocument: key "+e+" should match maybeDoc key\n        "+t.key);var r=n.mutationResults;assert$1(r.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+r.length+").");for(var o=0;o<this.mutations.length;o++){var i=this.mutations[o];if(i.key.equals(e)){var a=r[o];t=i.applyToRemoteDocument(t,a)}}return t},e.prototype.applyToLocalView=function(e,t){t&&assert$1(t.key.equals(e),"applyToLocalDocument: key "+e+" should match maybeDoc key\n        "+t.key);for(var n=0;n<this.mutations.length;n++){var r=this.mutations[n];r.key.equals(e)&&(t=r.applyToLocalView(t,this.localWriteTime))}return t},e.prototype.keys=function(){for(var e=documentKeySet(),t=0,n=this.mutations;t<n.length;t++){var r=n[t];e=e.add(r.key)}return e},e.prototype.equals=function(e){return this.batchId===e.batchId&&arrayEquals(this.mutations,e.mutations)},e.prototype.isTombstone=function(){return 0===this.mutations.length},e.prototype.toTombstone=function(){return new e(this.batchId,this.localWriteTime,[])},e}(),MutationBatchResult=function(){function e(e,t,n,r,o){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.streamToken=r,this.docVersions=o}return e.from=function(t,n,r,o){assert$1(t.mutations.length===r.length,"Mutations sent "+t.mutations.length+" must equal results received "+r.length);for(var i=documentVersionMap(),a=t.mutations,s=0;s<a.length;s++){var u=r[s].version;null===u&&(u=n),i=i.insert(a[s].key,u)}return new e(t,n,r,o,i)},e}(),escapeChar="",encodedSeparatorChar="",encodedNul="",encodedEscape="",SCHEMA_VERSION=1,DbTimestamp=function(){return function(e,t){this.seconds=e,this.nanos=t}}(),DbOwner=function(){function e(e,t){this.ownerId=e,this.leaseTimestampMs=t}return e.store="owner",e}(),DbMutationQueue=function(){function e(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}return e.store="mutationQueues",e.keyPath="userId",e}(),DbMutationBatch=function(){function e(e,t,n,r){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.mutations=r}return e.store="mutations",e.keyPath=["userId","batchId"],e}(),DbDocumentMutation=function(){function e(){}return e.prefixForUser=function(e){return[e]},e.prefixForPath=function(e,t){return[e,encode(t)]},e.key=function(e,t,n){return[e,encode(t),n]},e.store="documentMutations",e.PLACEHOLDER=new e,e}(),DbNoDocument=function(){return function(e,t){this.path=e,this.readTime=t}}(),DbRemoteDocument=function(){function e(e,t){this.noDocument=e,this.document=t}return e.store="remoteDocuments",e}(),DbTarget=function(){function e(e,t,n,r,o,i){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=o,this.query=i}return e.store="targets",e.keyPath="targetId",e.queryTargetsIndexName="queryTargetsIndex",e.queryTargetsKeyPath=["canonicalId","targetId"],e}(),DbTargetDocument=function(){function e(e,t){this.targetId=e,this.path=t}return e.store="targetDocuments",e.keyPath=["targetId","path"],e.documentTargetsIndex="documentTargetsIndex",e.documentTargetsKeyPath=["path","targetId"],e}(),DbTargetGlobal=function(){function e(e,t,n){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n}return e.key="targetGlobalKey",e.store="targetGlobal",e}(),ALL_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbOwner.store,DbTargetGlobal.store,DbTargetDocument.store],LOG_TAG$4="SimpleDb",SimpleDb=function(){function e(e){this.db=e}return e.openOrCreate=function(t,n,r){return assert$1(e.isAvailable(),"IndexedDB not supported in current environment."),debug(LOG_TAG$4,"Opening database:",t),new PersistencePromise(function(o,i){var a=window.indexedDB.open(t,n);a.onsuccess=function(t){var n=t.target.result;o(new e(n))},a.onerror=function(e){i(e.target.error)},a.onupgradeneeded=function(e){debug(LOG_TAG$4,'Database "'+t+'" requires upgrade from version:',e.oldVersion);var n=e.target.result;r(n,e.oldVersion)}}).toPromise()},e.delete=function(e){return debug(LOG_TAG$4,"Removing database:",e),wrapRequest(window.indexedDB.deleteDatabase(e)).toPromise()},e.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;var e=window.navigator.userAgent;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0)},e.prototype.runTransaction=function(e,t,n){var r=new SimpleDbTransaction(this.db,e,t),o=n(r).catch(function(e){return r.abort(),PersistencePromise.reject(e)}).toPromise();return r.completionPromise.then(function(){return o})},e.prototype.close=function(){this.db.close()},e}(),IterationController=function(){function e(e){this.dbCursor=e,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(e.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cursor",{set:function(e){this.dbCursor=e},enumerable:!0,configurable:!0}),e.prototype.done=function(){this.shouldStop=!0},e.prototype.skip=function(e){this.nextKey=e},e.prototype.delete=function(){return wrapRequest(this.dbCursor.delete())},e}(),SimpleDbTransaction=function(){function e(e,t,n){var r=this;this.aborted=!1,this.transaction=e.transaction(n,t),this.completionPromise=new Promise(function(e,t){r.transaction.onabort=r.transaction.oncomplete=function(t){e()},r.transaction.onerror=function(e){t(e.target.error)}})}return e.prototype.abort=function(){this.aborted||(debug(LOG_TAG$4,"Aborting transaction."),this.aborted=!0,this.transaction.abort())},e.prototype.store=function(e){var t=this.transaction.objectStore(e);return assert$1(!!t,"Object store not part of transaction: "+e),new SimpleDbStore(t)},e}(),SimpleDbStore=function(){function e(e){this.store=e}return e.prototype.put=function(e,t){var n;return void 0!==t?(debug(LOG_TAG$4,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(debug(LOG_TAG$4,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),wrapRequest(n)},e.prototype.get=function(e){var t=this;return wrapRequest(this.store.get(e)).next(function(n){return void 0===n&&(n=null),debug(LOG_TAG$4,"GET",t.store.name,e,n),n})},e.prototype.delete=function(e){return debug(LOG_TAG$4,"DELETE",this.store.name,e),wrapRequest(this.store.delete(e))},e.prototype.loadAll=function(e,t){var n=this.cursor(this.options(e,t)),r=[];return this.iterateCursor(n,function(e,t){r.push(t)}).next(function(){return r})},e.prototype.deleteAll=function(e,t){debug(LOG_TAG$4,"DELETE ALL",this.store.name);var n=this.options(e,t);n.keysOnly=!1;var r=this.cursor(n);return this.iterateCursor(r,function(e,t,n){return n.delete()})},e.prototype.iterate=function(e,t){var n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.iterateCursor(r,t)},e.prototype.iterateCursor=function(e,t){var n=[];return new PersistencePromise(function(r,o){e.onerror=function(e){o(e.target.error)},e.onsuccess=function(e){var o=e.target.result;if(o){var i=new IterationController(o),a=t(o.primaryKey,o.value,i);a instanceof PersistencePromise&&n.push(a),i.isDone?r():null===i.skipToKey?o.continue():o.continue(i.skipToKey)}else r()}}).next(function(){return PersistencePromise.waitFor(n)})},e.prototype.options=function(e,t){var n=void 0;return void 0!==e&&("string"==typeof e?n=e:(assert$1(void 0===t,"3rd argument must not be defined if 2nd is a range."),t=e)),{index:n,range:t}},e.prototype.cursor=function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.keysOnly?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)},e}(),IndexedDbMutationQueue=function(){function e(e,t){this.userId=e,this.serializer=t,this.garbageCollector=null}return e.forUser=function(t,n){return assert$1(""!==t.uid,"UserID must not be an empty string."),new e(t.isUnauthenticated()?"":t.uid,n)},e.prototype.start=function(t){var n=this;return e.loadNextBatchIdFromDb(t).next(function(e){return n.nextBatchId=e,mutationQueuesStore(t).get(n.userId)}).next(function(e){return e||(e=new DbMutationQueue(n.userId,BATCHID_UNKNOWN,"")),n.metadata=e,n.metadata.lastAcknowledgedBatchId>=n.nextBatchId?n.checkEmpty(t).next(function(e){return assert$1(e,"Reset nextBatchID is only possible when the queue is empty"),n.metadata.lastAcknowledgedBatchId=BATCHID_UNKNOWN,mutationQueuesStore(t).put(n.metadata)}):PersistencePromise.resolve()})},e.loadNextBatchIdFromDb=function(e){var t=BATCHID_UNKNOWN;return mutationsStore(e).iterate({reverse:!0},function(e,n,r){var o=e[0];if(e[1]>t&&(t=n.batchId),""===o)r.done();else{var i=immediatePredecessor(o);r.skip([i])}}).next(function(){return t+1})},e.prototype.checkEmpty=function(e){var t=!0,n=IDBKeyRange.bound(this.keyForBatchId(Number.NEGATIVE_INFINITY),this.keyForBatchId(Number.POSITIVE_INFINITY));return mutationsStore(e).iterate({range:n},function(e,n,r){t=!1,r.done()}).next(function(){return t})},e.prototype.getNextBatchId=function(e){return PersistencePromise.resolve(this.nextBatchId)},e.prototype.getHighestAcknowledgedBatchId=function(e){return PersistencePromise.resolve(this.metadata.lastAcknowledgedBatchId)},e.prototype.acknowledgeBatch=function(e,t,n){var r=t.batchId;return assert$1(r>this.metadata.lastAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order"),this.metadata.lastAcknowledgedBatchId=r,this.metadata.lastStreamToken=validateStreamToken(n),mutationQueuesStore(e).put(this.metadata)},e.prototype.getLastStreamToken=function(e){return PersistencePromise.resolve(this.metadata.lastStreamToken)},e.prototype.setLastStreamToken=function(e,t){return this.metadata.lastStreamToken=validateStreamToken(t),mutationQueuesStore(e).put(this.metadata)},e.prototype.addMutationBatch=function(e,t,n){var r=this,o=this.nextBatchId;this.nextBatchId++;var i=new MutationBatch(o,t,n),a=this.serializer.toDbMutationBatch(this.userId,i);return mutationsStore(e).put(a).next(function(){for(var t=0,i=n;t<i.length;t++){var a=i[t],s=(encode(a.key.path),DbDocumentMutation.key(r.userId,a.key.path,o));documentMutationsStore(e).put(s,DbDocumentMutation.PLACEHOLDER)}return PersistencePromise.waitFor([])}).next(function(){return i})},e.prototype.lookupMutationBatch=function(e,t){var n=this;return mutationsStore(e).get(this.keyForBatchId(t)).next(function(e){return e?n.serializer.fromDbMutationBatch(e):null})},e.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=this,r=IDBKeyRange.lowerBound(this.keyForBatchId(t+1)),o=null;return mutationsStore(e).iterate({range:r},function(e,r,i){r.userId===n.userId&&(assert$1(r.batchId>t,"Should have found mutation after "+t),o=n.serializer.fromDbMutationBatch(r)),i.done()}).next(function(){return o})},e.prototype.getAllMutationBatches=function(e){var t=this,n=IDBKeyRange.bound(this.keyForBatchId(BATCHID_UNKNOWN),this.keyForBatchId(Number.POSITIVE_INFINITY));return mutationsStore(e).loadAll(n).next(function(e){return e.map(function(e){return t.serializer.fromDbMutationBatch(e)})})},e.prototype.getAllMutationBatchesThroughBatchId=function(e,t){var n=this,r=IDBKeyRange.bound(this.keyForBatchId(BATCHID_UNKNOWN),this.keyForBatchId(t));return mutationsStore(e).loadAll(r).next(function(e){return e.map(function(e){return n.serializer.fromDbMutationBatch(e)})})},e.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=DbDocumentMutation.prefixForPath(this.userId,t.path),o=IDBKeyRange.lowerBound(r),i=[];return documentMutationsStore(e).iterate({range:o},function(r,o,a){var s=r[0],u=r[1],c=r[2],h=decode$1(u);if(s===n.userId&&t.path.equals(h)){var l=n.keyForBatchId(c);return mutationsStore(e).get(l).next(function(e){null===e&&fail("Dangling document-mutation reference found: "+r+" which points to "+l),i.push(n.serializer.fromDbMutationBatch(e))})}a.done()}).next(function(){return i})},e.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var n=this;assert$1(!t.isDocumentQuery(),"Document queries shouldn't go down this path");var r=t.path,o=r.length+1,i=DbDocumentMutation.prefixForPath(this.userId,r),a=IDBKeyRange.lowerBound(i),s=new SortedSet(primitiveComparator);return documentMutationsStore(e).iterate({range:a},function(e,t,i){var a=e[0],u=e[1],c=e[2],h=decode$1(u);a===n.userId&&r.isPrefixOf(h)?h.length===o&&(s=s.add(c)):i.done()}).next(function(){var t=[],r=[];return s.forEach(function(o){var i=n.keyForBatchId(o);r.push(mutationsStore(e).get(i).next(function(e){null===e&&fail("Dangling document-mutation reference found, which points to "+i),t.push(n.serializer.fromDbMutationBatch(e))}))}),PersistencePromise.waitFor(r).next(function(){return t})})},e.prototype.removeMutationBatches=function(e,t){for(var n=mutationsStore(e),r=documentMutationsStore(e),o=[],i=this,a=0,s=t;a<s.length;a++)!function(e){var t=IDBKeyRange.only(i.keyForBatchId(e.batchId)),a=0,s=n.iterate({range:t},function(e,t,n){return a++,n.delete()});o.push(s.next(function(){assert$1(1===a,"Dangling document-mutation reference found: Missing batch "+e.batchId)}));for(var u=0,c=e.mutations;u<c.length;u++){var h=c[u],l=DbDocumentMutation.key(i.userId,h.key.path,e.batchId);o.push(r.delete(l)),null!==i.garbageCollector&&i.garbageCollector.addPotentialGarbageKey(h.key)}}(s[a]);return PersistencePromise.waitFor(o)},e.prototype.performConsistencyCheck=function(e){var t=this;return this.checkEmpty(e).next(function(n){if(!n)return PersistencePromise.resolve();var r=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(t.userId)),o=[];return documentMutationsStore(e).iterate({range:r},function(e,n,r){if(e[0]===t.userId){var i=decode$1(e[1]);o.push(i)}else r.done()}).next(function(){assert$1(0===o.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+o.map(function(e){return e.canonicalString()}))})})},e.prototype.setGarbageCollector=function(e){this.garbageCollector=e},e.prototype.containsKey=function(e,t){var n=this,r=DbDocumentMutation.prefixForPath(this.userId,t.path),o=r[1],i=IDBKeyRange.lowerBound(r),a=!1;return documentMutationsStore(e).iterate({range:i,keysOnly:!0},function(e,t,r){var i=e[0],s=e[1];i===n.userId&&s===o&&(a=!0),r.done()}).next(function(){return a})},e.prototype.keyForBatchId=function(e){return[this.userId,e]},e}(),IndexedDbQueryCache=function(){function e(e){this.serializer=e,this.lastRemoteSnapshotVersion=SnapshotVersion.MIN,this.metadata=new DbTargetGlobal(0,0,SnapshotVersion.MIN.toTimestamp()),this.garbageCollector=null}return e.prototype.start=function(e){var t=this;return globalTargetStore(e).get(DbTargetGlobal.key).next(function(e){if(null!==e){t.metadata=e;var n=e.lastRemoteSnapshotVersion;t.lastRemoteSnapshotVersion=SnapshotVersion.fromTimestamp(new Timestamp(n.seconds,n.nanos))}return PersistencePromise.resolve()})},e.prototype.getHighestTargetId=function(){return this.metadata.highestTargetId},e.prototype.getLastRemoteSnapshotVersion=function(){return this.lastRemoteSnapshotVersion},e.prototype.setLastRemoteSnapshotVersion=function(e,t){return this.lastRemoteSnapshotVersion=t,this.metadata.lastRemoteSnapshotVersion=t.toTimestamp(),globalTargetStore(e).put(DbTargetGlobal.key,this.metadata)},e.prototype.addQueryData=function(e,t){var n=this,r=t.targetId,o=targetsStore(e).put(this.serializer.toDbTarget(t));return r>this.metadata.highestTargetId?(this.metadata.highestTargetId=r,o.next(function(){return globalTargetStore(e).put(DbTargetGlobal.key,n.metadata)})):o},e.prototype.removeQueryData=function(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(function(){targetsStore(e).delete(t.targetId)})},e.prototype.getQueryData=function(e,t){var n=this,r=t.canonicalId(),o=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),i=null;return targetsStore(e).iterate({range:o,index:DbTarget.queryTargetsIndexName},function(e,r,o){var a=n.serializer.fromDbTarget(r);t.equals(a.query)&&(i=a,o.done())}).next(function(){return i})},e.prototype.addMatchingKeys=function(e,t,n){var r=[],o=documentTargetStore(e);return t.forEach(function(e){var t=encode(e.path);r.push(o.put(new DbTargetDocument(n,t)))}),PersistencePromise.waitFor(r)},e.prototype.removeMatchingKeys=function(e,t,n){var r=this,o=[],i=documentTargetStore(e);return t.forEach(function(e){var t=encode(e.path);o.push(i.delete([n,t])),null!==r.garbageCollector&&r.garbageCollector.addPotentialGarbageKey(e)}),PersistencePromise.waitFor(o)},e.prototype.removeMatchingKeysForTargetId=function(e,t){var n=documentTargetStore(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return this.notifyGCForRemovedKeys(e,r).next(function(){return n.delete(r)})},e.prototype.notifyGCForRemovedKeys=function(e,t){var n=this,r=documentTargetStore(e);return null!==this.garbageCollector&&this.garbageCollector.isEager?r.iterate({range:t,keysOnly:!0},function(e,t,r){var o=decode$1(e[1]),i=new DocumentKey(o);assert$1(null!==n.garbageCollector,"GarbageCollector for query cache set to null during key removal."),n.garbageCollector.addPotentialGarbageKey(i)}):PersistencePromise.resolve()},e.prototype.getMatchingKeysForTargetId=function(e,t){var n=IDBKeyRange.bound([t],[t+1],!1,!0),r=documentTargetStore(e),o=documentKeySet();return r.iterate({range:n,keysOnly:!0},function(e,t,n){var r=decode$1(e[1]),i=new DocumentKey(r);o=o.add(i)}).next(function(){return o})},e.prototype.setGarbageCollector=function(e){this.garbageCollector=e},e.prototype.containsKey=function(e,t){assert$1(null!==e,"Persistence Transaction cannot be null for query cache containsKey");var n=encode(t.path),r=IDBKeyRange.bound([n],[immediateSuccessor(n)],!1,!0),o=0;return documentTargetStore(e).iterate({index:DbTargetDocument.documentTargetsIndex,keysOnly:!0,range:r},function(e,t,n){o++,n.done()}).next(function(){return o>0})},e}(),IndexedDbRemoteDocumentCache=function(){function e(e){this.serializer=e}return e.prototype.addEntry=function(e,t){return remoteDocumentsStore(e).put(dbKey(t.key),this.serializer.toDbRemoteDocument(t))},e.prototype.removeEntry=function(e,t){return remoteDocumentsStore(e).delete(dbKey(t))},e.prototype.getEntry=function(e,t){var n=this;return remoteDocumentsStore(e).get(dbKey(t)).next(function(e){return e?n.serializer.fromDbRemoteDocument(e):null})},e.prototype.getDocumentsMatchingQuery=function(e,t){var n=this,r=documentMap(),o=t.path.toArray(),i=IDBKeyRange.lowerBound(o);return remoteDocumentsStore(e).iterate({range:i},function(e,o,i){var a=n.serializer.fromDbRemoteDocument(o);t.path.isPrefixOf(a.key.path)?a instanceof Document&&t.matches(a)&&(r=r.insert(a.key,a)):i.done()}).next(function(){return r})},e}(),LocalSerializer=function(){function e(e){this.remoteSerializer=e}return e.prototype.fromDbRemoteDocument=function(e){if(e.document)return this.remoteSerializer.fromDocument(e.document);if(e.noDocument){var t=DocumentKey.fromSegments(e.noDocument.path),n=e.noDocument.readTime,r=new Timestamp(n.seconds,n.nanos);return new NoDocument(t,SnapshotVersion.fromTimestamp(r))}return fail("Unexpected DbRemoteDocument")},e.prototype.toDbRemoteDocument=function(e){if(e instanceof Document){var t=this.remoteSerializer.toDocument(e);return new DbRemoteDocument(null,t)}var n=e.key.path.toArray(),r=e.version.toTimestamp(),o=new DbTimestamp(r.seconds,r.nanos);return new DbRemoteDocument(new DbNoDocument(n,o),null)},e.prototype.toDbMutationBatch=function(e,t){var n=this,r=t.mutations.map(function(e){return n.remoteSerializer.toMutation(e)});return new DbMutationBatch(e,t.batchId,t.localWriteTime.toEpochMilliseconds(),r)},e.prototype.fromDbMutationBatch=function(e){var t=this,n=e.mutations.map(function(e){return t.remoteSerializer.fromMutation(e)}),r=Timestamp.fromEpochMilliseconds(e.localWriteTimeMs);return new MutationBatch(e.batchId,r,n)},e.prototype.fromDbTarget=function(e){var t,n=new Timestamp(e.readTime.seconds,e.readTime.nanos),r=SnapshotVersion.fromTimestamp(n);return t=isDocumentQuery(e.query)?this.remoteSerializer.fromDocumentsTarget(e.query):this.remoteSerializer.fromQueryTarget(e.query),new QueryData(t,e.targetId,QueryPurpose.Listen,r,e.resumeToken)},e.prototype.toDbTarget=function(e){assert$1(QueryPurpose.Listen===e.purpose,"Only queries with purpose "+QueryPurpose.Listen+" may be stored, got "+e.purpose);var t,n=e.snapshotVersion.toTimestamp(),r=new DbTimestamp(n.seconds,n.nanos);t=e.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(e.query):this.remoteSerializer.toQueryTarget(e.query),assert$1("string"==typeof e.resumeToken,"Persisting non-string resume token not supported.");var o=e.resumeToken;return new DbTarget(e.targetId,e.query.canonicalId(),r,o,0,t)},e}(),LOG_TAG$3="IndexedDbPersistence",OWNER_LEASE_MAX_AGE_MS=5e3,OWNER_LEASE_REFRESH_INTERVAL_MS=4e3,ZOMBIE_OWNER_LOCALSTORAGE_SUFFIX="zombiedOwnerId",EXISTING_OWNER_ERROR_MSG="There is another tab open with offline persistence enabled. Only one such tab is allowed at a time. The other tab must be closed or persistence must be disabled.",UNSUPPORTED_PLATFORM_ERROR_MSG="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",IndexedDbPersistence=function(){function e(t,n){this.ownerId=this.generateOwnerId(),this.dbName=t+e.MAIN_DATABASE,this.serializer=new LocalSerializer(n),this.localStoragePrefix=t}return e.prototype.start=function(){var t=this;return e.isAvailable()?(assert$1(!this.started,"IndexedDbPersistence double-started!"),this.started=!0,SimpleDb.openOrCreate(this.dbName,SCHEMA_VERSION,createOrUpgradeDb).then(function(e){t.simpleDb=e}).then(function(){return t.tryAcquireOwnerLease()}).then(function(){t.scheduleOwnerLeaseRefreshes(),t.attachWindowUnloadHook()})):(this.persistenceError=new FirestoreError(Code.UNIMPLEMENTED,UNSUPPORTED_PLATFORM_ERROR_MSG),Promise.reject(this.persistenceError))},e.prototype.shutdown=function(){var e=this;return assert$1(this.started,"IndexedDbPersistence shutdown without start!"),this.started=!1,this.detachWindowUnloadHook(),this.stopOwnerLeaseRefreshes(),this.releaseOwnerLease().then(function(){e.simpleDb.close()})},e.prototype.getMutationQueue=function(e){return IndexedDbMutationQueue.forUser(e,this.serializer)},e.prototype.getQueryCache=function(){return new IndexedDbQueryCache(this.serializer)},e.prototype.getRemoteDocumentCache=function(){return new IndexedDbRemoteDocumentCache(this.serializer)},e.prototype.runTransaction=function(e,t){var n=this;return this.persistenceError?Promise.reject(this.persistenceError):(debug(LOG_TAG$3,"Starting transaction:",e),this.simpleDb.runTransaction("readwrite",ALL_STORES,function(e){return n.ensureOwnerLease(e).next(function(){return t(e)})}))},e.isAvailable=function(){return SimpleDb.isAvailable()},e.buildStoragePrefix=function(e){var t=e.databaseId.projectId;return e.databaseId.isDefaultDatabase||(t+="."+e.databaseId.database),"firestore/"+e.persistenceKey+"/"+t+"/"},e.prototype.tryAcquireOwnerLease=function(){var e=this;return this.simpleDb.runTransaction("readwrite",[DbOwner.store],function(t){var n=t.store(DbOwner.store);return n.get("owner").next(function(t){if(e.validOwner(t))return debug(LOG_TAG$3,"Valid owner already. Failing. Current owner:",t),e.persistenceError=new FirestoreError(Code.FAILED_PRECONDITION,EXISTING_OWNER_ERROR_MSG),PersistencePromise.reject(e.persistenceError);var r=new DbOwner(e.ownerId,Date.now());return debug(LOG_TAG$3,"No valid owner. Acquiring owner lease. Current owner:",t,"New owner:",r),n.put("owner",r)})})},e.prototype.releaseOwnerLease=function(){var e=this;return this.simpleDb.runTransaction("readwrite",[DbOwner.store],function(t){var n=t.store(DbOwner.store);return n.get("owner").next(function(t){return null!==t&&t.ownerId===e.ownerId?(debug(LOG_TAG$3,"Releasing owner lease."),n.delete("owner")):PersistencePromise.resolve()})})},e.prototype.ensureOwnerLease=function(e){var t=this;return e.store(DbOwner.store).get("owner").next(function(e){return null===e||e.ownerId!==t.ownerId?(t.persistenceError=new FirestoreError(Code.FAILED_PRECONDITION,EXISTING_OWNER_ERROR_MSG),PersistencePromise.reject(t.persistenceError)):PersistencePromise.resolve()})},e.prototype.validOwner=function(e){var t=Date.now(),n=t-OWNER_LEASE_MAX_AGE_MS,r=t;return null!==e&&(!(e.leaseTimestampMs<n)&&(e.leaseTimestampMs>r?(error$1("Persistence owner-lease is in the future. Discarding.",e),!1):e.ownerId!==this.getZombiedOwnerId()))},e.prototype.scheduleOwnerLeaseRefreshes=function(){var e=this;this.ownerLeaseRefreshHandle=setInterval(function(){e.runTransaction("Refresh owner timestamp",function(t){return t.store(DbOwner.store).put("owner",new DbOwner(e.ownerId,Date.now()))}).catch(function(t){error$1(t),e.stopOwnerLeaseRefreshes()})},OWNER_LEASE_REFRESH_INTERVAL_MS)},e.prototype.stopOwnerLeaseRefreshes=function(){this.ownerLeaseRefreshHandle&&(clearInterval(this.ownerLeaseRefreshHandle),this.ownerLeaseRefreshHandle=null)},e.prototype.attachWindowUnloadHook=function(){var e=this;this.windowUnloadHandler=function(){e.setZombiedOwnerId(e.ownerId),e.shutdown()},window.addEventListener("unload",this.windowUnloadHandler)},e.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},e.prototype.getZombiedOwnerId=function(){try{var e=window.localStorage.getItem(this.zombiedOwnerLocalStorageKey());return debug(LOG_TAG$3,"Zombied ownerID from LocalStorage:",e),e}catch(e){return error$1(LOG_TAG$3,"Failed to get zombie owner id.",e),null}},e.prototype.setZombiedOwnerId=function(e){try{null===e?window.localStorage.removeItem(this.zombiedOwnerLocalStorageKey()):window.localStorage.setItem(this.zombiedOwnerLocalStorageKey(),e)}catch(e){error$1(LOG_TAG$3,"Failed to set zombie owner id.",e)}},e.prototype.zombiedOwnerLocalStorageKey=function(){return this.localStoragePrefix+ZOMBIE_OWNER_LOCALSTORAGE_SUFFIX},e.prototype.generateOwnerId=function(){return AutoId.newId()},e.MAIN_DATABASE="main",e}(),LocalDocumentsView=function(){function e(e,t){this.remoteDocumentCache=e,this.mutationQueue=t}return e.prototype.getDocument=function(e,t){var n=this;return this.remoteDocumentCache.getEntry(e,t).next(function(r){return n.computeLocalDocument(e,t,r)})},e.prototype.getDocuments=function(e,t){var n=this,r=[],o=maybeDocumentMap();return t.forEach(function(t){r.push(n.getDocument(e,t).next(function(e){e||(e=new NoDocument(t,SnapshotVersion.forDeletedDoc())),o=o.insert(t,e)}))}),PersistencePromise.waitFor(r).next(function(){return o})},e.prototype.getDocumentsMatchingQuery=function(e,t){return DocumentKey.isDocumentKey(t.path)?this.getDocumentsMatchingDocumentQuery(e,t.path):this.getDocumentsMatchingCollectionQuery(e,t)},e.prototype.getDocumentsMatchingDocumentQuery=function(e,t){return this.getDocument(e,new DocumentKey(t)).next(function(e){var t=documentMap();return e instanceof Document&&(t=t.insert(e.key,e)),t})},e.prototype.getDocumentsMatchingCollectionQuery=function(e,t){var n,r=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(e,t).next(function(t){return r.computeLocalDocuments(e,t)}).next(function(o){return n=o,r.mutationQueue.getAllMutationBatchesAffectingQuery(e,t)}).next(function(t){for(var o=documentKeySet(),i=0,a=t;i<a.length;i++)for(var s=0,u=a[i].mutations;s<u.length;s++){var c=u[s];n.get(c.key)||(o=o.add(c.key))}var h=[];return o.forEach(function(t){h.push(r.getDocument(e,t).next(function(e){e instanceof Document&&(n=n.insert(e.key,e))}))}),PersistencePromise.waitFor(h)}).next(function(){return n.forEach(function(e,r){t.matches(r)||(n=n.remove(e))}),n})},e.prototype.computeLocalDocument=function(e,t,n){return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(e,t).next(function(e){for(var r=0,o=e;r<o.length;r++){var i=o[r];n=i.applyToLocalView(t,n)}return n})},e.prototype.computeLocalDocuments=function(e,t){var n=this,r=[];return t.forEach(function(o,i){r.push(n.computeLocalDocument(e,o,i).next(function(e){e instanceof Document?t=t.insert(e.key,e):e instanceof NoDocument?t=t.remove(e.key):fail("Unknown MaybeDocument: "+e)}))}),PersistencePromise.waitFor(r).next(function(){return t})},e}(),RemoteDocumentChangeBuffer=function(){function e(e){this.remoteDocumentCache=e,this.changes=maybeDocumentMap()}return e.prototype.addEntry=function(e){var t=this.assertChanges();this.changes=t.insert(e.key,e)},e.prototype.getEntry=function(e,t){var n=this.assertChanges().get(t);return n?PersistencePromise.resolve(n):this.remoteDocumentCache.getEntry(e,t)},e.prototype.apply=function(e){var t=this,n=[];return this.assertChanges().forEach(function(r,o){n.push(t.remoteDocumentCache.addEntry(e,o))}),this.changes=null,PersistencePromise.waitFor(n)},e.prototype.assertChanges=function(){return assert$1(null!==this.changes,"Changes have already been applied."),this.changes},e}(),LOG_TAG$5="LocalStore",LocalStore=function(){function e(e,t,n){this.persistence=e,this.garbageCollector=n,this.localViewReferences=new ReferenceSet,this.targetIds={},this.targetIdGenerator=TargetIdGenerator.forLocalStore(),this.heldBatchResults=[],this.mutationQueue=e.getMutationQueue(t),this.remoteDocuments=e.getRemoteDocumentCache(),this.queryCache=e.getQueryCache(),this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue),this.garbageCollector.addGarbageSource(this.localViewReferences),this.garbageCollector.addGarbageSource(this.queryCache),this.garbageCollector.addGarbageSource(this.mutationQueue)}return e.prototype.start=function(){var e=this;return this.persistence.runTransaction("Start LocalStore",function(t){return e.startMutationQueue(t).next(function(){return e.startQueryCache(t)})})},e.prototype.handleUserChange=function(e){var t=this;return this.persistence.runTransaction("Handle user change",function(n){var r;return t.mutationQueue.getAllMutationBatches(n).next(function(o){return r=o,t.garbageCollector.removeGarbageSource(t.mutationQueue),t.mutationQueue=t.persistence.getMutationQueue(e),t.garbageCollector.addGarbageSource(t.mutationQueue),t.startMutationQueue(n)}).next(function(){return t.localDocuments=new LocalDocumentsView(t.remoteDocuments,t.mutationQueue),t.mutationQueue.getAllMutationBatches(n)}).next(function(e){for(var o=documentKeySet(),i=0,a=[r,e];i<a.length;i++)for(var s=0,u=a[i];s<u.length;s++)for(var c=0,h=u[s].mutations;c<h.length;c++){var l=h[c];o=o.add(l.key)}return t.localDocuments.getDocuments(n,o)})})},e.prototype.startQueryCache=function(e){var t=this;return this.queryCache.start(e).next(function(){var e=t.queryCache.getHighestTargetId();t.targetIdGenerator=TargetIdGenerator.forLocalStore(e)})},e.prototype.startMutationQueue=function(e){var t=this;return this.mutationQueue.start(e).next(function(){return t.heldBatchResults=[],t.mutationQueue.getHighestAcknowledgedBatchId(e)}).next(function(n){return n!==BATCHID_UNKNOWN?t.mutationQueue.getAllMutationBatchesThroughBatchId(e,n):PersistencePromise.resolve([])}).next(function(n){return n.length>0?t.mutationQueue.removeMutationBatches(e,n):PersistencePromise.resolve()})},e.prototype.localWrite=function(e){var t=this;return this.persistence.runTransaction("Locally write mutations",function(n){var r,o=Timestamp.now();return t.mutationQueue.addMutationBatch(n,o,e).next(function(e){var o=(r=e).keys();return t.localDocuments.getDocuments(n,o)}).next(function(e){return{batchId:r.batchId,changes:e}})})},e.prototype.acknowledgeBatch=function(e){var t=this;return this.persistence.runTransaction("Acknowledge batch",function(n){var r;return t.mutationQueue.acknowledgeBatch(n,e.batch,e.streamToken).next(function(){if(t.shouldHoldBatchResult(e.commitVersion))return t.heldBatchResults.push(e),r=documentKeySet(),PersistencePromise.resolve();var o=new RemoteDocumentChangeBuffer(t.remoteDocuments);return t.releaseBatchResults(n,[e],o).next(function(e){return r=e,o.apply(n)})}).next(function(){return t.mutationQueue.performConsistencyCheck(n)}).next(function(){return t.localDocuments.getDocuments(n,r)})})},e.prototype.rejectBatch=function(e){var t=this;return this.persistence.runTransaction("Reject batch",function(n){var r,o;return t.mutationQueue.lookupMutationBatch(n,e).next(function(o){return assert$1(null!=o,"Attempt to reject nonexistent batch!"),r=o,t.mutationQueue.getHighestAcknowledgedBatchId(n).next(function(t){return assert$1(e>t,"Acknowledged batches can't be rejected."),r})}).next(function(){return t.removeMutationBatch(n,r)}).next(function(e){return o=e,t.mutationQueue.performConsistencyCheck(n)}).next(function(){return t.localDocuments.getDocuments(n,o)})})},e.prototype.getLastStreamToken=function(){var e=this;return this.persistence.runTransaction("Get last stream token",function(t){return e.mutationQueue.getLastStreamToken(t)})},e.prototype.setLastStreamToken=function(e){var t=this;return this.persistence.runTransaction("Set last stream token",function(n){return t.mutationQueue.setLastStreamToken(n,e)})},e.prototype.getLastRemoteSnapshotVersion=function(){return this.queryCache.getLastRemoteSnapshotVersion()},e.prototype.applyRemoteEvent=function(e){var t=this,n=new RemoteDocumentChangeBuffer(this.remoteDocuments);return this.persistence.runTransaction("Apply remote event",function(r){var o=[];forEachNumber(e.targetChanges,function(e,n){var i=t.targetIds[e];if(i){var a=n.mapping;if(a)if(a instanceof ResetMapping)o.push(t.queryCache.removeMatchingKeysForTargetId(r,e).next(function(){return t.queryCache.addMatchingKeys(r,a.documents,e)}));else{if(!(a instanceof UpdateMapping))return fail("Unknown mapping type: "+JSON.stringify(a));o.push(t.queryCache.removeMatchingKeys(r,a.removedDocuments,e).next(function(){return t.queryCache.addMatchingKeys(r,a.addedDocuments,e)}))}var s=n.resumeToken;s.length>0&&(i=i.update({resumeToken:s,snapshotVersion:n.snapshotVersion}),t.targetIds[e]=i,o.push(t.queryCache.addQueryData(r,i)))}});var i=documentKeySet();e.documentUpdates.forEach(function(e,a){i=i.add(e),o.push(n.getEntry(r,e).next(function(r){null==r||a.version.equals(SnapshotVersion.MIN)||a.version.compareTo(r.version)>=0?n.addEntry(a):debug(LOG_TAG$5,"Ignoring outdated watch update for ",e,". Current version:",r.version," Watch version:",a.version),t.garbageCollector.addPotentialGarbageKey(e)}))});var a=t.queryCache.getLastRemoteSnapshotVersion(),s=e.snapshotVersion;s.equals(SnapshotVersion.MIN)||(assert$1(s.compareTo(a)>=0,"Watch stream reverted to previous snapshot?? "+s+" < "+a),o.push(t.queryCache.setLastRemoteSnapshotVersion(r,s)));var u;return PersistencePromise.waitFor(o).next(function(){return t.releaseHeldBatchResults(r,n)}).next(function(e){return u=e,n.apply(r)}).next(function(){return t.localDocuments.getDocuments(r,i.unionWith(u))})})},e.prototype.notifyLocalViewChanges=function(e){var t=this;return this.persistence.runTransaction("Notify local view changes",function(n){for(var r=[],o=0,i=e;o<i.length;o++)!function(e){r.push(t.queryCache.getQueryData(n,e.query).next(function(n){assert$1(null!==n,"Local view changes contain unallocated query.");var r=n.targetId;t.localViewReferences.addReferences(e.addedKeys,r),t.localViewReferences.removeReferences(e.removedKeys,r)}))}(i[o]);return PersistencePromise.waitFor(r)})},e.prototype.nextMutationBatch=function(e){var t=this;return this.persistence.runTransaction("Get next mutation batch",function(n){return void 0===e&&(e=BATCHID_UNKNOWN),t.mutationQueue.getNextMutationBatchAfterBatchId(n,e)})},e.prototype.readDocument=function(e){var t=this;return this.persistence.runTransaction("read document",function(n){return t.localDocuments.getDocument(n,e)})},e.prototype.allocateQuery=function(e){var t=this;return this.persistence.runTransaction("Allocate query",function(n){var r;return t.queryCache.getQueryData(n,e).next(function(o){if(o)return r=o,PersistencePromise.resolve();var i=t.targetIdGenerator.next();return r=new QueryData(e,i,QueryPurpose.Listen),t.queryCache.addQueryData(n,r)}).next(function(){return assert$1(!t.targetIds[r.targetId],"Tried to allocate an already allocated query: "+e),t.targetIds[r.targetId]=r,r})})},e.prototype.releaseQuery=function(e){var t=this;return this.persistence.runTransaction("Release query",function(n){return t.queryCache.getQueryData(n,e).next(function(r){return assert$1(null!=r,"Tried to release nonexistent query: "+e),t.localViewReferences.removeReferencesForId(r.targetId),delete t.targetIds[r.targetId],t.garbageCollector.isEager?t.queryCache.removeQueryData(n,r):PersistencePromise.resolve()}).next(function(){if(isEmpty$1(t.targetIds)){var e=new RemoteDocumentChangeBuffer(t.remoteDocuments);return t.releaseHeldBatchResults(n,e).next(function(){e.apply(n)})}return PersistencePromise.resolve()})})},e.prototype.executeQuery=function(e){var t=this;return this.persistence.runTransaction("Execute query",function(n){return t.localDocuments.getDocumentsMatchingQuery(n,e)})},e.prototype.remoteDocumentKeys=function(e){var t=this;return this.persistence.runTransaction("Remote document keys",function(n){return t.queryCache.getMatchingKeysForTargetId(n,e)})},e.prototype.collectGarbage=function(){var e=this;return this.persistence.runTransaction("Garbage collection",function(t){return e.garbageCollector.collectGarbage(t).next(function(n){var r=[];return n.forEach(function(n){r.push(e.remoteDocuments.removeEntry(t,n))}),PersistencePromise.waitFor(r)})})},e.prototype.releaseHeldBatchResults=function(e,t){for(var n=[],r=0,o=this.heldBatchResults;r<o.length;r++){var i=o[r];if(!this.isRemoteUpToVersion(i.commitVersion))break;n.push(i)}return 0===n.length?PersistencePromise.resolve(documentKeySet()):(this.heldBatchResults.splice(0,n.length),this.releaseBatchResults(e,n,t))},e.prototype.isRemoteUpToVersion=function(e){var t=this.queryCache.getLastRemoteSnapshotVersion();return e.compareTo(t)<=0||isEmpty$1(this.targetIds)},e.prototype.shouldHoldBatchResult=function(e){return!this.isRemoteUpToVersion(e)||this.heldBatchResults.length>0},e.prototype.releaseBatchResults=function(e,t,n){for(var r=this,o=PersistencePromise.resolve(),i=0,a=t;i<a.length;i++)!function(t){o=o.next(function(){return r.applyWriteToRemoteDocuments(e,t,n)})}(a[i]);return o.next(function(){return r.removeMutationBatches(e,t.map(function(e){return e.batch}))})},e.prototype.removeMutationBatch=function(e,t){return this.removeMutationBatches(e,[t])},e.prototype.removeMutationBatches=function(e,t){for(var n=documentKeySet(),r=0,o=t;r<o.length;r++)for(var i=0,a=o[r].mutations;i<a.length;i++){var s=a[i].key;n=n.add(s)}return this.mutationQueue.removeMutationBatches(e,t).next(function(){return n})},e.prototype.applyWriteToRemoteDocuments=function(e,t,n){var r=t.batch,o=r.keys(),i=PersistencePromise.resolve();return o.forEach(function(o){i=i.next(function(){return n.getEntry(e,o)}).next(function(e){var i=e,a=t.docVersions.get(o);assert$1(null!==a,"ackVersions should contain every doc in the write."),(!i||i.version.compareTo(a)<0)&&((i=r.applyToRemoteDocument(o,i,t))?n.addEntry(i):assert$1(!e,"Mutation batch "+r+" applied to document "+e+" resulted in null"))})}),i},e}(),MemoryMutationQueue=function(){function e(){this.mutationQueue=[],this.nextBatchId=1,this.highestAcknowledgedBatchId=BATCHID_UNKNOWN,this.lastStreamToken=emptyByteString(),this.garbageCollector=null,this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}return e.prototype.start=function(e){return 0===this.mutationQueue.length&&(this.nextBatchId=1,this.highestAcknowledgedBatchId=BATCHID_UNKNOWN),assert$1(this.highestAcknowledgedBatchId<this.nextBatchId,"highestAcknowledgedBatchId must be less than the nextBatchId"),PersistencePromise.resolve()},e.prototype.checkEmpty=function(e){return PersistencePromise.resolve(0===this.mutationQueue.length)},e.prototype.getNextBatchId=function(e){return PersistencePromise.resolve(this.nextBatchId)},e.prototype.getHighestAcknowledgedBatchId=function(e){return PersistencePromise.resolve(this.highestAcknowledgedBatchId)},e.prototype.acknowledgeBatch=function(e,t,n){var r=t.batchId;assert$1(r>this.highestAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order");var o=this.indexOfExistingBatchId(r,"acknowledged"),i=this.mutationQueue[o];return assert$1(r===i.batchId,"Queue ordering failure: expected batch "+r+", got batch "+i.batchId),assert$1(!i.isTombstone(),"Can't acknowledge a previously removed batch"),this.highestAcknowledgedBatchId=r,this.lastStreamToken=n,PersistencePromise.resolve()},e.prototype.getLastStreamToken=function(e){return PersistencePromise.resolve(this.lastStreamToken)},e.prototype.setLastStreamToken=function(e,t){return this.lastStreamToken=t,PersistencePromise.resolve()},e.prototype.addMutationBatch=function(e,t,n){assert$1(0!==n.length,"Mutation batches should not be empty");var r=this.nextBatchId;this.nextBatchId++,this.mutationQueue.length>0&&assert$1(this.mutationQueue[this.mutationQueue.length-1].batchId<r,"Mutation batchIDs must be monotonically increasing order");var o=new MutationBatch(r,t,n);this.mutationQueue.push(o);for(var i=0,a=n;i<a.length;i++){var s=a[i];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(s.key,r))}return PersistencePromise.resolve(o)},e.prototype.lookupMutationBatch=function(e,t){return PersistencePromise.resolve(this.findMutationBatch(t))},e.prototype.getNextMutationBatchAfterBatchId=function(e,t){var n=this.mutationQueue.length;t=Math.max(t+1,this.highestAcknowledgedBatchId);for(var r=this.indexOfBatchId(t),o=r<0?0:r;o<n;o++){var i=this.mutationQueue[o];if(!i.isTombstone())return PersistencePromise.resolve(i)}return PersistencePromise.resolve(null)},e.prototype.getAllMutationBatches=function(e){return PersistencePromise.resolve(this.getAllLiveMutationBatchesBeforeIndex(this.mutationQueue.length))},e.prototype.getAllMutationBatchesThroughBatchId=function(e,t){var n=this.mutationQueue.length,r=this.indexOfBatchId(t);return r<0?r=0:r>=n?r=n:r++,PersistencePromise.resolve(this.getAllLiveMutationBatchesBeforeIndex(r))},e.prototype.getAllMutationBatchesAffectingDocumentKey=function(e,t){var n=this,r=new DocReference(t,0),o=new DocReference(t,Number.POSITIVE_INFINITY),i=[];return this.batchesByDocumentKey.forEachInRange([r,o],function(e){assert$1(t.equals(e.key),"Should only iterate over a single key's batches");var r=n.findMutationBatch(e.targetOrBatchId);assert$1(null!==r,"Batches in the index must exist in the main table"),i.push(r)}),PersistencePromise.resolve(i)},e.prototype.getAllMutationBatchesAffectingQuery=function(e,t){var n=this,r=t.path,o=r.length+1,i=r;DocumentKey.isDocumentKey(i)||(i=i.child(""));var a=new DocReference(new DocumentKey(i),0),s=new SortedSet(primitiveComparator);this.batchesByDocumentKey.forEachWhile(function(e){var t=e.key.path;return!!r.isPrefixOf(t)&&(t.length===o&&(s=s.add(e.targetOrBatchId)),!0)},a);var u=[];return s.forEach(function(e){var t=n.findMutationBatch(e);null!==t&&u.push(t)}),PersistencePromise.resolve(u)},e.prototype.removeMutationBatches=function(e,t){var n=t.length;assert$1(n>0,"Should not remove mutations when none exist.");var r=t[0].batchId,o=this.mutationQueue.length,i=this.indexOfExistingBatchId(r,"removed");assert$1(this.mutationQueue[i].batchId===r,"Removed batches must exist in the queue");for(var a=1,s=i+1;a<n&&s<o;)(d=this.mutationQueue[s]).isTombstone()?s++:(assert$1(d.batchId===t[a].batchId,"Removed batches must be contiguous in the queue"),a++,s++);if(0===i){for(;s<o&&(d=this.mutationQueue[s]).isTombstone();s++);var u=s-i;this.mutationQueue.splice(i,u)}else for(var c=i;c<s;c++)this.mutationQueue[c]=this.mutationQueue[c].toTombstone();for(var h=this.batchesByDocumentKey,l=0,f=t;l<f.length;l++)for(var d=f[l],p=d.batchId,m=0,y=d.mutations;m<y.length;m++){var g=y[m].key;null!==this.garbageCollector&&this.garbageCollector.addPotentialGarbageKey(g);var v=new DocReference(g,p);h=h.delete(v)}return this.batchesByDocumentKey=h,PersistencePromise.resolve()},e.prototype.setGarbageCollector=function(e){this.garbageCollector=e},e.prototype.containsKey=function(e,t){var n=new DocReference(t,0),r=this.batchesByDocumentKey.firstAfterOrEqual(n);return PersistencePromise.resolve(t.equals(r&&r.key))},e.prototype.performConsistencyCheck=function(e){return 0===this.mutationQueue.length&&assert$1(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),PersistencePromise.resolve()},e.prototype.getAllLiveMutationBatchesBeforeIndex=function(e){for(var t=[],n=0;n<e;n++){var r=this.mutationQueue[n];r.isTombstone()||t.push(r)}return t},e.prototype.indexOfExistingBatchId=function(e,t){var n=this.indexOfBatchId(e);return assert$1(n>=0&&n<this.mutationQueue.length,"Batches must exist to be "+t),n},e.prototype.indexOfBatchId=function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId},e.prototype.findMutationBatch=function(e){var t=this.indexOfBatchId(e);if(t<0||t>=this.mutationQueue.length)return null;var n=this.mutationQueue[t];return assert$1(n.batchId===e,"If found batch must match"),n.isTombstone()?null:n},e}(),MemoryQueryCache=function(){function e(){this.queries=new ObjectMap(function(e){return e.canonicalId()}),this.lastRemoteSnapshotVersion=SnapshotVersion.MIN,this.highestTargetId=0,this.references=new ReferenceSet}return e.prototype.start=function(e){return PersistencePromise.resolve()},e.prototype.getLastRemoteSnapshotVersion=function(){return this.lastRemoteSnapshotVersion},e.prototype.getHighestTargetId=function(){return this.highestTargetId},e.prototype.setLastRemoteSnapshotVersion=function(e,t){return this.lastRemoteSnapshotVersion=t,PersistencePromise.resolve()},e.prototype.addQueryData=function(e,t){this.queries.set(t.query,t);var n=t.targetId;return n>this.highestTargetId&&(this.highestTargetId=n),PersistencePromise.resolve()},e.prototype.removeQueryData=function(e,t){return this.queries.delete(t.query),this.references.removeReferencesForId(t.targetId),PersistencePromise.resolve()},e.prototype.getQueryData=function(e,t){var n=this.queries.get(t)||null;return PersistencePromise.resolve(n)},e.prototype.addMatchingKeys=function(e,t,n){return this.references.addReferences(t,n),PersistencePromise.resolve()},e.prototype.removeMatchingKeys=function(e,t,n){return this.references.removeReferences(t,n),PersistencePromise.resolve()},e.prototype.removeMatchingKeysForTargetId=function(e,t){return this.references.removeReferencesForId(t),PersistencePromise.resolve()},e.prototype.getMatchingKeysForTargetId=function(e,t){var n=this.references.referencesForId(t);return PersistencePromise.resolve(n)},e.prototype.setGarbageCollector=function(e){this.references.setGarbageCollector(e)},e.prototype.containsKey=function(e,t){return this.references.containsKey(e,t)},e}(),MemoryRemoteDocumentCache=function(){function e(){this.docs=maybeDocumentMap()}return e.prototype.addEntry=function(e,t){return this.docs=this.docs.insert(t.key,t),PersistencePromise.resolve()},e.prototype.removeEntry=function(e,t){return this.docs=this.docs.remove(t),PersistencePromise.resolve()},e.prototype.getEntry=function(e,t){return PersistencePromise.resolve(this.docs.get(t))},e.prototype.getDocumentsMatchingQuery=function(e,t){for(var n=documentMap(),r=new DocumentKey(t.path.child("")),o=this.docs.getIteratorFrom(r);o.hasNext();){var i=o.getNext(),a=i.key,s=i.value;if(!t.path.isPrefixOf(a.path))break;s instanceof Document&&t.matches(s)&&(n=n.insert(s.key,s))}return PersistencePromise.resolve(n)},e}(),LOG_TAG$6="MemoryPersistence",MemoryPersistence=function(){function e(){this.mutationQueues={},this.remoteDocumentCache=new MemoryRemoteDocumentCache,this.queryCache=new MemoryQueryCache,this.started=!1}return e.prototype.start=function(){return assert$1(!this.started,"MemoryPersistence double-started!"),this.started=!0,Promise.resolve()},e.prototype.shutdown=function(){return assert$1(this.started,"MemoryPersistence shutdown without start!"),this.started=!1,Promise.resolve()},e.prototype.getMutationQueue=function(e){var t=this.mutationQueues[e.toKey()];return t||(t=new MemoryMutationQueue,this.mutationQueues[e.toKey()]=t),t},e.prototype.getQueryCache=function(){return this.queryCache},e.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},e.prototype.runTransaction=function(e,t){return debug(LOG_TAG$6,"Starting transaction:",e),t(new MemoryPersistenceTransaction).toPromise()},e}(),MemoryPersistenceTransaction=function(){return function(){}}(),NoOpGarbageCollector=function(){function e(){this.isEager=!1}return e.prototype.addGarbageSource=function(e){},e.prototype.removeGarbageSource=function(e){},e.prototype.addPotentialGarbageKey=function(e){},e.prototype.collectGarbage=function(e){return PersistencePromise.resolve(documentKeySet())},e}(),Deferred$1=function(){return function(){var e=this;this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})}}(),LOG_TAG$8="ExponentialBackoff",ExponentialBackoff=function(){function e(e,t,n){this.initialDelayMs=e,this.backoffFactor=t,this.maxDelayMs=n,this.reset()}return e.prototype.reset=function(){this.currentBaseMs=0},e.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},e.prototype.backoffAndWait=function(){var e=new Deferred$1,t=this.currentBaseMs+this.jitterDelayMs();return this.currentBaseMs>0&&debug(LOG_TAG$8,"Backing off for "+t+" ms (base delay: "+this.currentBaseMs+" ms)"),setTimeout(function(){e.resolve()},t),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs),e.promise},e.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},e}(),__extends$6=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),LOG_TAG$7="PersistentStream",PersistentStreamState;!function(e){e[e.Initial=0]="Initial",e[e.Auth=1]="Auth",e[e.Open=2]="Open",e[e.Error=3]="Error",e[e.Backoff=4]="Backoff",e[e.Stopped=5]="Stopped"}(PersistentStreamState||(PersistentStreamState={}));var BACKOFF_INITIAL_DELAY_MS=1e3,BACKOFF_MAX_DELAY_MS=6e4,BACKOFF_FACTOR=1.5,IDLE_TIMEOUT_MS=6e4,PersistentStream=function(){function e(e,t,n,r){this.queue=e,this.connection=t,this.credentialsProvider=n,this.idle=!1,this.stream=null,this.listener=null,this.backoff=new ExponentialBackoff(r||BACKOFF_INITIAL_DELAY_MS,BACKOFF_FACTOR,BACKOFF_MAX_DELAY_MS),this.state=PersistentStreamState.Initial}return e.prototype.isStarted=function(){return this.state===PersistentStreamState.Backoff||this.state===PersistentStreamState.Auth||this.state===PersistentStreamState.Open},e.prototype.isOpen=function(){return this.state===PersistentStreamState.Open},e.prototype.start=function(e){this.state!==PersistentStreamState.Error?(assert$1(this.state===PersistentStreamState.Initial,"Already started"),this.listener=e,this.auth()):this.performBackoff(e)},e.prototype.stop=function(){this.isStarted()&&this.close(PersistentStreamState.Stopped)},e.prototype.inhibitBackoff=function(){assert$1(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=PersistentStreamState.Initial,this.backoff.reset()},e.prototype.markIdle=function(){var e=this;this.idle=!0,this.queue.schedule(function(){return e.handleIdleCloseTimer()},IDLE_TIMEOUT_MS).catch(function(e){assert$1(e.code===Code.CANCELLED,"Received unexpected error in idle timeout closure. Expected CANCELLED, but was: "+e)})},e.prototype.sendRequest=function(e){this.cancelIdleCheck(),this.stream.send(e)},e.prototype.handleIdleCloseTimer=function(){return this.isOpen()&&this.idle?this.close(PersistentStreamState.Initial):Promise.resolve()},e.prototype.cancelIdleCheck=function(){this.idle=!1},e.prototype.close=function(e,t){assert$1(e==PersistentStreamState.Error||isNullOrUndefined(t),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),e!=PersistentStreamState.Error?this.backoff.reset():t&&t.code===Code.RESOURCE_EXHAUSTED&&(debug(LOG_TAG$7,"Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=e;var n=this.listener;return this.listener=null,e!=PersistentStreamState.Stopped?n.onClose(t):Promise.resolve()},e.prototype.tearDown=function(){},e.prototype.auth=function(){var e=this;assert$1(this.state===PersistentStreamState.Initial,"Must be in initial state to auth"),this.state=PersistentStreamState.Auth,this.credentialsProvider.getToken(!1).then(function(t){e.startStream(t)},function(t){e.queue.schedule(function(){if(e.state!==PersistentStreamState.Stopped){var n=new FirestoreError(Code.UNKNOWN,"Fetching auth token failed: "+t.message);return e.handleStreamClose(n)}return Promise.resolve()})})},e.prototype.startStream=function(e){var t=this;if(this.state!==PersistentStreamState.Stopped){assert$1(this.state===PersistentStreamState.Auth,"Trying to start stream in a non-auth state");var n=function(e,n){t.queue.schedule(function(){return t.stream===e?n():Promise.resolve()})};if(null!==this.listener){var r=this.startRpc(e);this.stream=r,this.stream.onOpen(function(){n(r,function(){return assert$1(t.state===PersistentStreamState.Auth,"Expected stream to be in state auth, but was "+t.state),t.state=PersistentStreamState.Open,t.listener.onOpen()})}),this.stream.onClose(function(e){n(r,function(){return t.handleStreamClose(e)})}),this.stream.onMessage(function(e){n(r,function(){return t.onMessage(e)})})}}},e.prototype.performBackoff=function(e){var t=this;assert$1(this.state===PersistentStreamState.Error,"Should only perform backoff in an error case"),this.state=PersistentStreamState.Backoff,this.backoff.backoffAndWait().then(function(){t.queue.schedule(function(){return t.state===PersistentStreamState.Stopped?Promise.resolve():(t.state=PersistentStreamState.Initial,t.start(e),assert$1(t.isStarted(),"PersistentStream should have started"),Promise.resolve())})})},e.prototype.handleStreamClose=function(e){return assert$1(this.isStarted(),"Can't handle server close on non-started stream"),debug(LOG_TAG$7,"close with error: "+e),this.stream=null,this.close(PersistentStreamState.Error,e)},e}(),PersistentListenStream=function(e){function t(t,n,r,o,i,a){var s=e.call(this,n,r,o,a)||this;return s.databaseInfo=t,s.serializer=i,s}return __extends$6(t,e),t.prototype.startRpc=function(e){return this.connection.openStream("Listen",e)},t.prototype.onMessage=function(e){this.backoff.reset();var t=this.serializer.fromWatchChange(e),n=this.serializer.versionFromListenResponse(e);return this.listener.onWatchChange(t,n)},t.prototype.watch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.addTarget=this.serializer.toTarget(e);var n=this.serializer.toListenRequestLabels(e);n&&(t.labels=n),this.sendRequest(t)},t.prototype.unwatch=function(e){var t={};t.database=this.serializer.encodedDatabaseId,t.removeTarget=e,this.sendRequest(t)},t}(PersistentStream),PersistentWriteStream=function(e){function t(t,n,r,o,i,a){var s=e.call(this,n,r,o,a)||this;return s.databaseInfo=t,s.serializer=i,s.handshakeComplete_=!1,s}return __extends$6(t,e),Object.defineProperty(t.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),t.prototype.start=function(t){this.handshakeComplete_=!1,e.prototype.start.call(this,t)},t.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},t.prototype.startRpc=function(e){return this.connection.openStream("Write",e)},t.prototype.onMessage=function(e){if(assert$1(!!e.streamToken,"Got a write response without a stream token"),this.lastStreamToken=e.streamToken,this.handshakeComplete_){this.backoff.reset();var t=this.serializer.fromWriteResults(e.writeResults),n=this.serializer.fromVersion(e.commitTime);return this.listener.onMutationResult(n,t)}return assert$1(!e.writeResults||0===e.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},t.prototype.writeHandshake=function(){assert$1(this.isOpen(),"Writing handshake requires an opened stream"),assert$1(!this.handshakeComplete_,"Handshake already completed");var e={};e.database=this.serializer.encodedDatabaseId,this.sendRequest(e)},t.prototype.writeMutations=function(e){var t=this;assert$1(this.isOpen(),"Writing mutations requires an opened stream"),assert$1(this.handshakeComplete_,"Handshake must be complete before writing mutations"),assert$1(this.lastStreamToken.length>0,"Trying to write mutation without a token");var n={streamToken:this.lastStreamToken,writes:e.map(function(e){return t.serializer.toMutation(e)})};this.sendRequest(n)},t}(PersistentStream),Datastore=function(){function e(e,t,n,r,o,i){this.databaseInfo=e,this.queue=t,this.connection=n,this.credentials=r,this.serializer=o,this.initialBackoffDelay=i}return e.prototype.newPersistentWriteStream=function(){return new PersistentWriteStream(this.databaseInfo,this.queue,this.connection,this.credentials,this.serializer,this.initialBackoffDelay)},e.prototype.newPersistentWatchStream=function(){return new PersistentListenStream(this.databaseInfo,this.queue,this.connection,this.credentials,this.serializer,this.initialBackoffDelay)},e.prototype.commit=function(e){var t=this,n={writes:e.map(function(e){return t.serializer.toMutation(e)})};return this.invokeRPC("commit",n).then(function(e){return t.serializer.fromWriteResults(e.writeResults)})},e.prototype.lookup=function(e){var t=this,n={documents:e.map(function(e){return t.serializer.toName(e)})};return this.invokeRPC("batchGet",n).then(function(n){var r=maybeDocumentMap();n.forEach(function(e){var n=t.serializer.fromMaybeDocument(e);r=r.insert(n.key,n)});var o=[];return e.forEach(function(e){var t=r.get(e);assert$1(!!t,"Missing entity in write response for "+e),o.push(t)}),o})},e.prototype.invokeRPC=function(e,t){var n=this;return this.credentials.getToken(!1).then(function(r){return n.connection.invoke(e,t,r)})},e}(),Transaction$1=function(){function e(e){this.datastore=e,this.readVersions=documentVersionMap(),this.mutations=[],this.committed=!1}return e.prototype.recordVersion=function(e){var t=e.version;e instanceof NoDocument&&(t=SnapshotVersion.forDeletedDoc());var n=this.readVersions.get(e.key);if(null!==n){if(!t.equals(n))throw new FirestoreError(Code.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(e.key,t)},e.prototype.lookup=function(e){var t=this;return this.committed?Promise.reject("Transaction has already completed."):this.mutations.length>0?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(e).then(function(e){return e.forEach(function(e){return t.recordVersion(e)}),e})},e.prototype.write=function(e){if(this.committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(e)},e.prototype.precondition=function(e){var t=this.readVersions.get(e);return t?Precondition.updateTime(t):Precondition.NONE},e.prototype.preconditionForUpdate=function(e){var t=this.readVersions.get(e);if(t&&t.equals(SnapshotVersion.forDeletedDoc()))throw new FirestoreError(Code.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return t?Precondition.updateTime(t):Precondition.exists(!0)},e.prototype.set=function(e,t){this.write(t.toMutations(e,this.precondition(e)))},e.prototype.update=function(e,t){this.write(t.toMutations(e,this.preconditionForUpdate(e)))},e.prototype.delete=function(e){this.write([new DeleteMutation(e,this.precondition(e))]),this.readVersions=this.readVersions.insert(e,SnapshotVersion.forDeletedDoc())},e.prototype.commit=function(){var e=this,t=this.readVersions;return this.mutations.forEach(function(e){t=t.remove(e.key)}),t.isEmpty()?this.datastore.commit(this.mutations).then(function(){e.committed=!0}):Promise.reject(Error("Every document read in a transaction must also be written."))},e}(),LOG_TAG$9="RemoteStore",MAX_PENDING_WRITES=10,ONLINE_ATTEMPTS_BEFORE_FAILURE=2,RemoteStore=function(){function e(e,t,n,r,o){this.databaseInfo=e,this.asyncQueue=t,this.localStore=n,this.datastore=r,this.onlineStateHandler=o,this.pendingWrites=[],this.lastBatchSeen=BATCHID_UNKNOWN,this.listenTargets={},this.pendingTargetResponses={},this.accumulatedWatchChanges=[],this.watchStream=null,this.writeStream=null,this.watchStreamOnlineState=OnlineState.Unknown,this.watchStreamFailures=0}return e.prototype.start=function(){return this.enableNetwork()},e.prototype.setOnlineStateToHealthy=function(){this.updateAndBroadcastOnlineState(OnlineState.Healthy)},e.prototype.setOnlineStateToUnknown=function(){this.watchStreamFailures=0,this.updateAndBroadcastOnlineState(OnlineState.Unknown)},e.prototype.updateOnlineStateAfterFailure=function(){this.watchStreamOnlineState===OnlineState.Healthy?this.setOnlineStateToUnknown():(this.watchStreamFailures++,this.watchStreamFailures>=ONLINE_ATTEMPTS_BEFORE_FAILURE&&this.updateAndBroadcastOnlineState(OnlineState.Failed))},e.prototype.updateAndBroadcastOnlineState=function(e){var t=this.watchStreamOnlineState!==e;this.watchStreamOnlineState=e,t&&this.onlineStateHandler(e)},e.prototype.isNetworkEnabled=function(){return assert$1(null==this.watchStream==(null==this.writeStream),"WatchStream and WriteStream should both be null or non-null"),null!=this.watchStream},e.prototype.enableNetwork=function(){var e=this;return assert$1(null==this.watchStream,"enableNetwork() called with non-null watchStream."),assert$1(null==this.writeStream,"enableNetwork() called with non-null writeStream."),this.watchStream=this.datastore.newPersistentWatchStream(),this.writeStream=this.datastore.newPersistentWriteStream(),this.localStore.getLastStreamToken().then(function(t){return e.writeStream.lastStreamToken=t,e.shouldStartWatchStream()&&e.startWatchStream(),e.updateAndBroadcastOnlineState(OnlineState.Unknown),e.fillWritePipeline()})},e.prototype.disableNetwork=function(){return this.updateAndBroadcastOnlineState(OnlineState.Failed),this.watchStream.stop(),this.writeStream.stop(),this.cleanUpWatchStreamState(),this.cleanUpWriteStreamState(),this.writeStream=null,this.watchStream=null,Promise.resolve()},e.prototype.shutdown=function(){return debug(LOG_TAG$9,"RemoteStore shutting down."),this.disableNetwork(),Promise.resolve(void 0)},e.prototype.listen=function(e){assert$1(!contains$2(this.listenTargets,e.targetId),"listen called with duplicate targetId!"),this.listenTargets[e.targetId]=e,this.shouldStartWatchStream()?this.startWatchStream():this.isNetworkEnabled()&&this.watchStream.isOpen()&&this.sendWatchRequest(e)},e.prototype.unlisten=function(e){assert$1(contains$2(this.listenTargets,e),"unlisten called without assigned target ID!"),delete this.listenTargets[e],this.isNetworkEnabled()&&this.watchStream.isOpen()&&(this.sendUnwatchRequest(e),isEmpty$1(this.listenTargets)&&this.watchStream.markIdle())},e.prototype.sendWatchRequest=function(e){this.recordPendingTargetRequest(e.targetId),this.watchStream.watch(e)},e.prototype.sendUnwatchRequest=function(e){this.recordPendingTargetRequest(e),this.watchStream.unwatch(e)},e.prototype.recordPendingTargetRequest=function(e){this.pendingTargetResponses[e]=(this.pendingTargetResponses[e]||0)+1},e.prototype.startWatchStream=function(){assert$1(this.shouldStartWatchStream(),"startWriteStream() called when shouldStartWatchStream() is false."),this.watchStream.start({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)})},e.prototype.shouldStartWatchStream=function(){return this.isNetworkEnabled()&&!this.watchStream.isStarted()&&!isEmpty$1(this.listenTargets)},e.prototype.cleanUpWatchStreamState=function(){this.accumulatedWatchChanges=[],this.pendingTargetResponses={}},e.prototype.onWatchStreamOpen=function(){var e=this;return forEachNumber(this.listenTargets,function(t,n){e.sendWatchRequest(n)}),Promise.resolve()},e.prototype.onWatchStreamClose=function(e){return assert$1(this.isNetworkEnabled(),"onWatchStreamClose() should only be called when the network is enabled"),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.updateOnlineStateAfterFailure(),this.startWatchStream()):this.setOnlineStateToUnknown(),Promise.resolve()},e.prototype.onWatchStreamChange=function(e,t){if(this.setOnlineStateToHealthy(),e instanceof WatchTargetChange&&e.state===WatchTargetChangeState.Removed&&e.cause)return this.handleTargetError(e);if(this.accumulatedWatchChanges.push(e),!t.equals(SnapshotVersion.MIN)&&t.compareTo(this.localStore.getLastRemoteSnapshotVersion())>=0){var n=this.accumulatedWatchChanges;return this.accumulatedWatchChanges=[],this.handleWatchChangeBatch(t,n)}return Promise.resolve()},e.prototype.handleWatchChangeBatch=function(e,t){var n=this,r=new WatchChangeAggregator(e,this.listenTargets,this.pendingTargetResponses);r.addChanges(t);var o=r.createRemoteEvent();this.pendingTargetResponses=r.pendingTargetResponses;var i=[];return forEachNumber(r.existenceFilters,function(t,r){var a=n.listenTargets[t];if(a){var s=a.query;if(s.isDocumentQuery())if(0===r.count){var u=new DocumentKey(s.path),c=new NoDocument(u,e);o.addDocumentUpdate(c)}else assert$1(1===r.count,"Single document existence filter with count: "+r.count);else{var h=n.localStore.remoteDocumentKeys(t).then(function(e){if(o.targetChanges[t]){var i=o.targetChanges[t].mapping;null!==i&&(i instanceof UpdateMapping?e=i.applyToKeySet(e):(assert$1(i instanceof ResetMapping,"Expected either reset or update mapping but got something else: "+i),e=i.documents))}if(e.size!==r.count){o.handleExistenceFilterMismatch(t);var u=new QueryData(s,t,a.purpose);n.listenTargets[t]=u,n.sendUnwatchRequest(t);var c=new QueryData(s,t,QueryPurpose.ExistenceFilterMismatch);n.sendWatchRequest(c)}});i.push(h)}}}),Promise.all(i).then(function(){return forEachNumber(o.targetChanges,function(e,t){if(t.resumeToken.length>0){var r=n.listenTargets[e];r&&(n.listenTargets[e]=r.update({resumeToken:t.resumeToken,snapshotVersion:t.snapshotVersion}))}}),n.syncEngine.applyRemoteEvent(o)})},e.prototype.handleTargetError=function(e){var t=this;assert$1(!!e.cause,"Handling target error without a cause");var n=e.cause,r=Promise.resolve();return e.targetIds.forEach(function(e){r=r.then(function(){return contains$2(t.listenTargets,e)?(delete t.listenTargets[e],t.syncEngine.rejectListen(e,n)):Promise.resolve()})}),r},e.prototype.cleanUpWriteStreamState=function(){this.lastBatchSeen=BATCHID_UNKNOWN,this.pendingWrites=[]},e.prototype.fillWritePipeline=function(){var e=this;return this.canWriteMutations()?this.localStore.nextMutationBatch(this.lastBatchSeen).then(function(t){return null===t?(0==e.pendingWrites.length&&e.writeStream.markIdle(),Promise.resolve()):(e.commit(t),e.fillWritePipeline())}):Promise.resolve()},e.prototype.canWriteMutations=function(){return this.isNetworkEnabled()&&this.pendingWrites.length<MAX_PENDING_WRITES},e.prototype.outstandingWrites=function(){return this.pendingWrites.length},e.prototype.commit=function(e){assert$1(this.canWriteMutations(),"commit called when batches can't be written"),this.lastBatchSeen=e.batchId,this.pendingWrites.push(e),this.shouldStartWriteStream()?this.startWriteStream():this.isNetworkEnabled()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(e.mutations)},e.prototype.shouldStartWriteStream=function(){return this.isNetworkEnabled()&&!this.writeStream.isStarted()&&this.pendingWrites.length>0},e.prototype.startWriteStream=function(){assert$1(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."),this.writeStream.start({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})},e.prototype.onWriteStreamOpen=function(){return this.writeStream.writeHandshake(),Promise.resolve()},e.prototype.onWriteHandshakeComplete=function(){var e=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var t=0,n=e.pendingWrites;t<n.length;t++){var r=n[t];e.writeStream.writeMutations(r.mutations)}})},e.prototype.onMutationResult=function(e,t){var n=this;assert$1(this.pendingWrites.length>0,"Got result for empty pending writes");var r=this.pendingWrites.shift(),o=MutationBatchResult.from(r,e,t,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(o).then(function(){return n.fillWritePipeline()})},e.prototype.onWriteStreamClose=function(e){var t=this;if(assert$1(this.isNetworkEnabled(),"onWriteStreamClose() should only be called when the network is enabled"),e&&this.pendingWrites.length>0){assert$1(!!e,"We have pending writes, but the write stream closed without an error");return(this.writeStream.handshakeComplete?this.handleWriteError(e):this.handleHandshakeError(e)).then(function(){t.shouldStartWriteStream()&&t.startWriteStream()})}return Promise.resolve()},e.prototype.handleHandshakeError=function(e){return isPermanentError(e.code)||e.code===Code.ABORTED?(debug(LOG_TAG$9,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=emptyByteString(),this.localStore.setLastStreamToken(emptyByteString())):Promise.resolve()},e.prototype.handleWriteError=function(e){var t=this;if(isPermanentError(e.code)){var n=this.pendingWrites.shift();return this.writeStream.inhibitBackoff(),this.syncEngine.rejectFailedWrite(n.batchId,e).then(function(){return t.fillWritePipeline()})}return Promise.resolve()},e.prototype.createTransaction=function(){return new Transaction$1(this.datastore)},e.prototype.handleUserChange=function(e){return debug(LOG_TAG$9,"RemoteStore changing users: uid=",e.uid),this.disableNetwork(),this.enableNetwork()},e}(),LOG_TAG$1="FirestoreClient",FirestoreClient=function(){function e(e,t,n,r){this.platform=e,this.databaseInfo=t,this.credentials=n,this.asyncQueue=r}return e.prototype.start=function(e){var t=this,n=new Deferred$1,r=new Deferred$1,o=!1;return this.credentials.setUserChangeListener(function(i){o?t.asyncQueue.schedule(function(){return t.handleUserChange(i)}):(o=!0,t.initializePersistence(e,r).then(function(){return t.initializeRest(i)}).then(n.resolve,n.reject))}),this.asyncQueue.schedule(function(){return n.promise}),r.promise},e.prototype.enableNetwork=function(){var e=this;return this.asyncQueue.schedule(function(){return e.remoteStore.enableNetwork()})},e.prototype.initializePersistence=function(e,t){var n=this;return e?this.startIndexedDbPersistence().then(t.resolve).catch(function(e){return t.reject(e),n.canFallback(e)?(console.warn("Error enabling offline storage. Falling back to storage disabled: "+e),n.startMemoryPersistence()):Promise.reject(e)}):(t.resolve(),this.startMemoryPersistence())},e.prototype.canFallback=function(e){return e.code===Code.FAILED_PRECONDITION||e.code===Code.UNIMPLEMENTED},e.prototype.startIndexedDbPersistence=function(){this.garbageCollector=new NoOpGarbageCollector;var e=IndexedDbPersistence.buildStoragePrefix(this.databaseInfo),t=new JsonProtoSerializer(this.databaseInfo.databaseId,{useProto3Json:!0});return this.persistence=new IndexedDbPersistence(e,t),this.persistence.start()},e.prototype.startMemoryPersistence=function(){return this.garbageCollector=new EagerGarbageCollector,this.persistence=new MemoryPersistence,this.persistence.start()},e.prototype.initializeRest=function(e){var t=this;return this.platform.loadConnection(this.databaseInfo).then(function(n){t.localStore=new LocalStore(t.persistence,e,t.garbageCollector);var r=t.platform.newSerializer(t.databaseInfo.databaseId),o=new Datastore(t.databaseInfo,t.asyncQueue,n,t.credentials,r);return t.remoteStore=new RemoteStore(t.databaseInfo,t.asyncQueue,t.localStore,o,function(e){t.eventMgr.onOnlineStateChanged(e)}),t.syncEngine=new SyncEngine(t.localStore,t.remoteStore,e),t.remoteStore.syncEngine=t.syncEngine,t.eventMgr=new EventManager(t.syncEngine),t.localStore.start()}).then(function(){return t.remoteStore.start()})},e.prototype.handleUserChange=function(e){return this.asyncQueue.verifyOperationInProgress(),debug(LOG_TAG$1,"User Changed: "+e.uid),this.syncEngine.handleUserChange(e)},e.prototype.disableNetwork=function(){var e=this;return this.asyncQueue.schedule(function(){return e.remoteStore.disableNetwork()})},e.prototype.shutdown=function(){var e=this;return this.asyncQueue.schedule(function(){return e.credentials.removeUserChangeListener(),e.remoteStore.shutdown()}).then(function(){return e.persistence.shutdown()})},e.prototype.listen=function(e,t,n){var r=this,o=new QueryListener(e,t,n);return this.asyncQueue.schedule(function(){return r.eventMgr.listen(o)}),o},e.prototype.unlisten=function(e){var t=this;this.asyncQueue.schedule(function(){return t.eventMgr.unlisten(e)})},e.prototype.write=function(e){var t=this,n=new Deferred$1;return this.asyncQueue.schedule(function(){return t.syncEngine.write(e,n)}),n.promise},e.prototype.databaseId=function(){return this.databaseInfo.databaseId},e.prototype.transaction=function(e){var t=this;return this.asyncQueue.schedule(function(){return Promise.resolve()}).then(function(){return t.syncEngine.runTransaction(e)})},e}(),AsyncObserver=function(){function e(e){this.observer=e,this.muted=!1}return e.prototype.next=function(e){this.scheduleEvent(this.observer.next,e)},e.prototype.error=function(e){this.scheduleEvent(this.observer.error,e)},e.prototype.mute=function(){this.muted=!0},e.prototype.scheduleEvent=function(e,t){var n=this;this.muted||setTimeout(function(){n.muted||e(t)},0)},e}(),AsyncQueue=function(){function e(){this.tail=Promise.resolve(),this.delayedOperations=[],this.delayedOperationsCount=0,this.operationInProgress=!1}return e.prototype.schedule=function(e,t){var n=this;if(this.failure&&fail("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message)),(t||0)>0){this.delayedOperationsCount++;var r={handle:null,op:e,deferred:new Deferred$1};return r.handle=setTimeout(function(){n.scheduleInternal(function(){return r.op().then(function(e){r.deferred.resolve(e)})}),r.handle=null,n.delayedOperationsCount--,0===n.delayedOperationsCount&&(n.delayedOperations=[])},t),this.delayedOperations.push(r),r.deferred.promise}return this.scheduleInternal(e)},e.prototype.scheduleInternal=function(e){var t=this;return this.tail=this.tail.then(function(){return t.operationInProgress=!0,e().catch(function(e){t.failure=e,t.operationInProgress=!1;var n=e.stack||e.message||"";throw error$1("INTERNAL UNHANDLED ERROR: ",n),n.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw e},0),e}).then(function(){t.operationInProgress=!1})}),this.tail},e.prototype.verifyOperationInProgress=function(){assert$1(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},e.prototype.drain=function(e){var t=this;return this.delayedOperations.forEach(function(n){n.handle&&(clearTimeout(n.handle),e?t.scheduleInternal(n.op).then(n.deferred.resolve,n.deferred.reject):n.deferred.reject(new FirestoreError(Code.CANCELLED,"Operation cancelled by shutdown")))}),this.delayedOperations=[],this.delayedOperationsCount=0,this.schedule(function(){return Promise.resolve()})},e}(),User=function(){function e(e){this.uid=e}return e.prototype.isUnauthenticated=function(){return null==this.uid},e.prototype.toKey=function(){return this.isUnauthenticated()?"anonymous-user":"uid:"+this.uid},e.prototype.equals=function(e){return e.uid===this.uid},e.UNAUTHENTICATED=new e(null),e.GOOGLE_CREDENTIALS=new e("google-credentials-uid"),e.FIRST_PARTY=new e("first-party-uid"),e}(),OAuthToken=function(){return function(e,t){this.user=t,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+e}}}(),EmptyCredentialsProvider=function(){function e(){this.userListener=null}return e.prototype.getToken=function(e){return Promise.resolve(null)},e.prototype.setUserChangeListener=function(e){assert$1(!this.userListener,"Can only call setUserChangeListener() once."),this.userListener=e,e(User.UNAUTHENTICATED)},e.prototype.removeUserChangeListener=function(){assert$1(null!==this.userListener,"removeUserChangeListener() when no listener registered"),this.userListener=null},e}(),FirebaseCredentialsProvider=function(){function e(e){var t=this;this.app=e,this.tokenListener=null,this.userCounter=0,this.userListener=null,this.tokenListener=function(){var e=t.getUser();t.currentUser&&e.equals(t.currentUser)||(t.currentUser=e,t.userCounter++,t.userListener&&t.userListener(t.currentUser))},this.userCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return e.prototype.getToken=function(e){var t=this;assert$1(null!=this.tokenListener,"getToken cannot be called after listener removed.");var n=this.userCounter;return this.app.INTERNAL.getToken(e).then(function(e){if(t.userCounter!==n)throw new FirestoreError(Code.ABORTED,"getToken aborted due to uid change.");return e?(assert$1("string"==typeof e.accessToken,"Invalid tokenData returned from getToken():"+e),new OAuthToken(e.accessToken,t.currentUser)):null})},e.prototype.setUserChangeListener=function(e){assert$1(!this.userListener,"Can only call setUserChangeListener() once."),this.userListener=e,this.currentUser&&e(this.currentUser)},e.prototype.removeUserChangeListener=function(){assert$1(null!=this.tokenListener,"removeUserChangeListener() called twice"),assert$1(null!==this.userListener,"removeUserChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.userListener=null},e.prototype.getUser=function(){"function"!=typeof this.app.INTERNAL.getUid&&fail("This version of the Firestore SDK requires at least version 3.7.0 of firebase.js.");var e=this.app.INTERNAL.getUid();return assert$1(null===e||"string"==typeof e,"Received invalid UID: "+e),new User(e)},e}(),GoogleCredentialsProvider=function(){function e(e){this.authClient=e}return e.prototype.getToken=function(e){var t=this;return new Promise(function(e,n){t.authClient.getAccessToken(function(t,r){t?n(t):e(new OAuthToken(r,User.GOOGLE_CREDENTIALS))})})},e.prototype.setUserChangeListener=function(e){e(User.GOOGLE_CREDENTIALS)},e.prototype.removeUserChangeListener=function(){},e}(),FirstPartyToken=function(){function e(e,t){this.gapi=e,this.sessionIndex=t,this.type="FirstParty",this.user=User.FIRST_PARTY,assert$1(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return Object.defineProperty(e.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0}),e}(),FirstPartyCredentialsProvider=function(){function e(e,t){this.gapi=e,this.sessionIndex=t,assert$1(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}return e.prototype.getToken=function(e){return Promise.resolve(new FirstPartyToken(this.gapi,this.sessionIndex))},e.prototype.setUserChangeListener=function(e){e(User.FIRST_PARTY)},e.prototype.removeUserChangeListener=function(){},e}(),__extends$7=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),FieldValueImpl=function(){function e(){}return e.delete=function(){return DeleteFieldValueImpl.instance},e.serverTimestamp=function(){return ServerTimestampFieldValueImpl.instance},e}(),DeleteFieldValueImpl=function(e){function t(){return e.call(this)||this}return __extends$7(t,e),t.instance=new t,t}(FieldValueImpl),ServerTimestampFieldValueImpl=function(e){function t(){return e.call(this)||this}return __extends$7(t,e),t.instance=new t,t}(FieldValueImpl),PublicFieldValue=makeConstructorPrivate(FieldValueImpl,"Use FieldValue.<field>() instead."),RESERVED_FIELD_REGEX=/^__.*__$/,ParsedSetData=function(){function e(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return e.prototype.toMutations=function(e,t){var n=[];return null!==this.fieldMask?n.push(new PatchMutation(e,this.data,this.fieldMask,t)):n.push(new SetMutation(e,this.data,t)),this.fieldTransforms.length>0&&n.push(new TransformMutation(e,this.fieldTransforms)),n},e}(),ParsedUpdateData=function(){function e(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}return e.prototype.toMutations=function(e,t){var n=[new PatchMutation(e,this.data,this.fieldMask,t)];return this.fieldTransforms.length>0&&n.push(new TransformMutation(e,this.fieldTransforms)),n},e}(),UserDataSource;!function(e){e[e.Set=0]="Set",e[e.Update=1]="Update",e[e.MergeSet=2]="MergeSet",e[e.QueryValue=3]="QueryValue"}(UserDataSource||(UserDataSource={}));var ParseContext=function(){function e(e,t,n,r,o,i){this.dataSource=e,this.methodName=t,this.path=n,this.arrayElement=r,void 0===o&&this.validatePath(),this.arrayElement=void 0!==r&&r,this.fieldTransforms=o||[],this.fieldMask=i||[]}return e.prototype.childContextForField=function(t){var n=null==this.path?null:this.path.child(t),r=new e(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePathSegment(t),r},e.prototype.childContextForFieldPath=function(t){var n=null==this.path?null:this.path.child(t),r=new e(this.dataSource,this.methodName,n,!1,this.fieldTransforms,this.fieldMask);return r.validatePath(),r},e.prototype.childContextForArray=function(t){return new e(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},e.prototype.createError=function(e){var t=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+e+t)},e.prototype.validatePath=function(){if(null!==this.path)for(var e=0;e<this.path.length;e++)this.validatePathSegment(this.path.get(e))},e.prototype.validatePathSegment=function(e){if(isWrite(this.dataSource)&&RESERVED_FIELD_REGEX.test(e))throw this.createError("Document fields cannot begin and end with __")},e.prototype.isWrite=function(){return this.dataSource===UserDataSource.Set||this.dataSource===UserDataSource.Update},e}(),DocumentKeyReference=function(){return function(e,t){this.databaseId=e,this.key=t}}(),UserDataConverter=function(){function e(e){this.preConverter=e}return e.prototype.parseSetData=function(e,t){var n=new ParseContext(UserDataSource.Set,e,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",n,t);var r=this.parseData(t,n);return new ParsedSetData(r,null,n.fieldTransforms)},e.prototype.parseMergeData=function(e,t){var n=new ParseContext(UserDataSource.MergeSet,e,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",n,t);var r=this.parseData(t,n),o=new FieldMask(n.fieldMask);return new ParsedSetData(r,o,n.fieldTransforms)},e.prototype.parseUpdateData=function(e,t){var n=this,r=new ParseContext(UserDataSource.Update,e,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",r,t);var o=[],i=ObjectValue.EMPTY;forEach$1(t,function(t,a){var s=fieldPathFromDotSeparatedString(e,t),u=r.childContextForFieldPath(s);if((a=n.runPreConverter(a,u))instanceof DeleteFieldValueImpl)o.push(s);else{var c=n.parseData(a,u);null!=c&&(o.push(s),i=i.set(s,c))}});var a=new FieldMask(o);return new ParsedUpdateData(i,a,r.fieldTransforms)},e.prototype.parseUpdateVarargs=function(e,t,n,r){var o=new ParseContext(UserDataSource.Update,e,FieldPath.EMPTY_PATH),i=[fieldPathFromArgument(e,t)],a=[n];if(r.length%2!=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+e+"() needs to be called with an even number of arguments that alternate between field names and values.");for(c=0;c<r.length;c+=2)i.push(fieldPathFromArgument(e,r[c])),a.push(r[c+1]);for(var s=[],u=ObjectValue.EMPTY,c=0;c<i.length;++c){var h=i[c],l=o.childContextForFieldPath(h),f=this.runPreConverter(a[c],l);if(f instanceof DeleteFieldValueImpl)s.push(h);else{var d=this.parseData(f,l);null!=d&&(s.push(h),u=u.set(h,d))}}var p=new FieldMask(s);return new ParsedUpdateData(u,p,o.fieldTransforms)},e.prototype.parseQueryValue=function(e,t){var n=new ParseContext(UserDataSource.QueryValue,e,FieldPath.EMPTY_PATH),r=this.parseData(t,n);return assert$1(null!=r,"Parsed data should not be null."),assert$1(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),r},e.prototype.runPreConverter=function(e,t){try{return this.preConverter(e)}catch(e){var n=errorMessage(e);throw t.createError(n)}},e.prototype.parseData=function(e,t){if((e=this.runPreConverter(e,t))instanceof Array){if(t.arrayElement)throw t.createError("Nested arrays are not supported");return t.path&&t.fieldMask.push(t.path),this.parseArray(e,t)}return looksLikeJsonObject(e)?(validatePlainObject("Unsupported field value:",t,e),this.parseObject(e,t)):(t.path&&t.fieldMask.push(t.path),this.parseScalarValue(e,t))},e.prototype.parseArray=function(e,t){for(var n=[],r=0,o=0,i=e;o<i.length;o++){var a=i[o],s=this.parseData(a,t.childContextForArray(r));null==s&&(s=NullValue.INSTANCE),n.push(s),r++}return new ArrayValue(n)},e.prototype.parseObject=function(e,t){var n=this,r=new SortedMap(primitiveComparator);return forEach$1(e,function(e,o){var i=n.parseData(o,t.childContextForField(e));null!=i&&(r=r.insert(e,i))}),new ObjectValue(r)},e.prototype.parseScalarValue=function(e,t){if(null===e)return NullValue.INSTANCE;if("number"==typeof e)return isSafeInteger(e)?new IntegerValue(e):new DoubleValue(e);if("boolean"==typeof e)return BooleanValue.of(e);if("string"==typeof e)return new StringValue(e);if(e instanceof Date)return new TimestampValue(Timestamp.fromDate(e));if(e instanceof GeoPoint)return new GeoPointValue(e);if(e instanceof Blob)return new BlobValue(e);if(e instanceof DocumentKeyReference)return new RefValue(e.databaseId,e.key);if(e instanceof FieldValueImpl){if(e instanceof DeleteFieldValueImpl){if(t.dataSource==UserDataSource.MergeSet)return null;throw t.dataSource===UserDataSource.Update?(assert$1(null==t.path||t.path.length>0,"FieldValue.delete() at the top level should have already been handled."),t.createError("FieldValue.delete() can only appear at the top level of your update data")):t.createError("FieldValue.delete() can only be used with update() and set() with {merge:true}")}if(e instanceof ServerTimestampFieldValueImpl){if(!isWrite(t.dataSource))throw t.createError("FieldValue.serverTimestamp() can only be used with set() and update()");if(null===t.path)throw t.createError("FieldValue.serverTimestamp() is not currently supported inside arrays");return t.fieldTransforms.push(new FieldTransform(t.path,ServerTimestampTransform.instance)),null}return fail("Unknown FieldValue type: "+e)}throw t.createError("Unsupported field value: "+valueDescription(e))},e}(),__extends$5=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),DEFAULT_HOST="firestore.googleapis.com",DEFAULT_SSL=!0,FirestoreSettings=function(){function e(e){if(void 0===e.host){if(void 0!==e.ssl)throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=DEFAULT_HOST,this.ssl=DEFAULT_SSL}else validateNamedType("settings","string","host",e.host),this.host=e.host,validateNamedOptionalType("settings","boolean","ssl",e.ssl),this.ssl=defaulted(e.ssl,DEFAULT_SSL);validateOptionNames("settings",e,["host","ssl","credentials"]),validateNamedOptionalType("settings","object","credentials",e.credentials),this.credentials=e.credentials}return e.prototype.equals=function(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials},e}(),FirestoreConfig=function(){return function(){}}(),Firestore=function(){function e(t){var n=this;this._queue=new AsyncQueue,this.INTERNAL={delete:function(){return n._firestoreClient?n._firestoreClient.shutdown():Promise.resolve()},disableNetwork:function(){return n._firestoreClient.disableNetwork()},enableNetwork:function(){return n._firestoreClient.enableNetwork()},drainAsyncQueue:function(e){return n._queue.drain(e)}};var r=new FirestoreConfig;if("object"==typeof t.options){var o=t;r.firebaseApp=o,r.databaseId=e.databaseIdFromApp(o),r.persistenceKey=r.firebaseApp.name,r.credentials=new FirebaseCredentialsProvider(o)}else{var i=t;if(!i.projectId)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide projectId");r.databaseId=new DatabaseId(i.projectId,i.database),r.persistenceKey="[DEFAULT]",r.credentials=new EmptyCredentialsProvider}r.settings=new FirestoreSettings({}),this._config=r,this._databaseId=r.databaseId}return e.prototype.settings=function(e){if(validateExactNumberOfArgs("Firestore.settings",arguments,1),validateArgType("Firestore.settings","object",1,e),contains$2(e,"persistence"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var t=new FirestoreSettings(e);if(this._firestoreClient&&!this._config.settings.equals(t))throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=t,void 0!==t.credentials&&(this._config.credentials=makeCredentialsProvider(t.credentials))},e.prototype.enablePersistence=function(){if(this._firestoreClient)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(!0)},e.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(!1),this._firestoreClient},e.prototype.configureClient=function(e){var t=this;assert$1(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),assert$1(!this._firestoreClient,"configureClient() called multiple times");var n=new DatabaseInfo(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);return this._dataConverter=new UserDataConverter(function(e){if(e instanceof DocumentReference){var n=t._config.databaseId,r=e.firestore._config.databaseId;if(!r.equals(n))throw new FirestoreError(Code.INVALID_ARGUMENT,"Document reference is for database "+r.projectId+"/"+r.database+" but should be for database "+n.projectId+"/"+n.database);return new DocumentKeyReference(t._config.databaseId,e._key)}return e}),this._firestoreClient=new FirestoreClient(PlatformSupport.getPlatform(),n,this._config.credentials,this._queue),this._firestoreClient.start(e)},e.databaseIdFromApp=function(e){var t=e.options;if(!contains$2(t,"projectId")){if(contains$2(t,"firestoreId"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"firestoreId" is now specified as "projectId" in firebase.initializeApp.');throw new FirestoreError(Code.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}if(contains$2(t,"firestoreOptions"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"firestoreOptions" values are now specified with Firestore.settings()');var n=t.projectId;if(!n||"string"!=typeof n)throw new FirestoreError(Code.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new DatabaseId(n)},Object.defineProperty(e.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),e.prototype.collection=function(e){if(validateExactNumberOfArgs("Firestore.collection",arguments,1),validateArgType("Firestore.collection","string",1,e),!e)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection path to collection()");return this.ensureClientConfigured(),new CollectionReference(ResourcePath.fromString(e),this)},e.prototype.doc=function(e){if(validateExactNumberOfArgs("Firestore.doc",arguments,1),validateArgType("Firestore.doc","string",1,e),!e)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty document path to doc()");return this.ensureClientConfigured(),DocumentReference.forPath(ResourcePath.fromString(e),this)},e.prototype.runTransaction=function(e){var t=this;return validateExactNumberOfArgs("Firestore.runTransaction",arguments,1),validateArgType("Firestore.runTransaction","function",1,e),this.ensureClientConfigured().transaction(function(n){return e(new Transaction(t,n))})},e.prototype.batch=function(){return this.ensureClientConfigured(),new WriteBatch(this)},Object.defineProperty(e,"logLevel",{get:function(){switch(getLogLevel()){case LogLevel.DEBUG:return"debug";case LogLevel.ERROR:return"error";case LogLevel.SILENT:return"silent";default:return fail("Unknown log level: "+getLogLevel())}},enumerable:!0,configurable:!0}),e.setLogLevel=function(e){switch(validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1),validateArgType("Firestore.setLogLevel","string",1,e),e){case"debug":setLogLevel(LogLevel.DEBUG);break;case"error":setLogLevel(LogLevel.ERROR);break;case"silent":setLogLevel(LogLevel.SILENT);break;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid log level: "+e)}},e}(),Transaction=function(){function e(e,t){this._firestore=e,this._transaction=t}return e.prototype.get=function(e){var t=this;validateExactNumberOfArgs("Transaction.get",arguments,1);var n=validateReference("Transaction.get",e,this._firestore);return this._transaction.lookup([n._key]).then(function(e){if(!e||1!==e.length)return fail("Mismatch in docs returned from document lookup.");var r=e[0];return r instanceof NoDocument?new DocumentSnapshot(t._firestore,n._key,null,!1):new DocumentSnapshot(t._firestore,n._key,r,!1)})},e.prototype.set=function(e,t,n){validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var r=validateReference("Transaction.set",e,this._firestore),o=(n=validateSetOptions("Transaction.set",n)).merge?this._firestore._dataConverter.parseMergeData("Transaction.set",t):this._firestore._dataConverter.parseSetData("Transaction.set",t);return this._transaction.set(r._key,o),this},e.prototype.update=function(e,t,n){for(var r=[],o=3;o<arguments.length;o++)r[o-3]=arguments[o];var i,a;return"string"==typeof t||t instanceof FieldPath$1?(validateAtLeastNumberOfArgs("Transaction.update",arguments,3),i=validateReference("Transaction.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",t,n,r)):(validateExactNumberOfArgs("Transaction.update",arguments,2),i=validateReference("Transaction.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateData("Transaction.update",t)),this._transaction.update(i._key,a),this},e.prototype.delete=function(e){validateExactNumberOfArgs("Transaction.delete",arguments,1);var t=validateReference("Transaction.delete",e,this._firestore);return this._transaction.delete(t._key),this},e}(),WriteBatch=function(){function e(e){this._firestore=e,this._mutations=[],this._committed=!1}return e.prototype.set=function(e,t,n){validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var r=validateReference("WriteBatch.set",e,this._firestore),o=(n=validateSetOptions("WriteBatch.set",n)).merge?this._firestore._dataConverter.parseMergeData("WriteBatch.set",t):this._firestore._dataConverter.parseSetData("WriteBatch.set",t);return this._mutations=this._mutations.concat(o.toMutations(r._key,Precondition.NONE)),this},e.prototype.update=function(e,t,n){for(var r=[],o=3;o<arguments.length;o++)r[o-3]=arguments[o];this.verifyNotCommitted();var i,a;return"string"==typeof t||t instanceof FieldPath$1?(validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3),i=validateReference("WriteBatch.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",t,n,r)):(validateExactNumberOfArgs("WriteBatch.update",arguments,2),i=validateReference("WriteBatch.update",e,this._firestore),a=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",t)),this._mutations=this._mutations.concat(a.toMutations(i._key,Precondition.exists(!0))),this},e.prototype.delete=function(e){validateExactNumberOfArgs("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var t=validateReference("WriteBatch.delete",e,this._firestore);return this._mutations=this._mutations.concat(new DeleteMutation(t._key,Precondition.NONE)),this},e.prototype.commit=function(){return this.verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._firestore.ensureClientConfigured().write(this._mutations):Promise.resolve()},e.prototype.verifyNotCommitted=function(){if(this._committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},e}(),DocumentReference=function(){function e(e,t){this._key=e,this.firestore=t,this._firestoreClient=this.firestore.ensureClientConfigured()}return e.forPath=function(t,n){if(t.length%2!=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+t.canonicalString()+" has "+t.length);return new e(new DocumentKey(t),n)},Object.defineProperty(e.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return new CollectionReference(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),e.prototype.collection=function(e){if(validateExactNumberOfArgs("DocumentReference.collection",arguments,1),validateArgType("DocumentReference.collection","string",1,e),!e)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var t=ResourcePath.fromString(e);return new CollectionReference(this._key.path.child(t),this.firestore)},e.prototype.isEqual=function(t){if(!(t instanceof e))throw invalidClassError("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this._key.equals(t._key)},e.prototype.set=function(e,t){validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2);var n=(t=validateSetOptions("DocumentReference.set",t)).merge?this.firestore._dataConverter.parseMergeData("DocumentReference.set",e):this.firestore._dataConverter.parseSetData("DocumentReference.set",e);return this._firestoreClient.write(n.toMutations(this._key,Precondition.NONE))},e.prototype.update=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o;return"string"==typeof e||e instanceof FieldPath$1?(validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2),o=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",e,t,n)):(validateExactNumberOfArgs("DocumentReference.update",arguments,1),o=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",e)),this._firestoreClient.write(o.toMutations(this._key,Precondition.exists(!0)))},e.prototype.delete=function(){return validateExactNumberOfArgs("DocumentReference.delete",arguments,0),this._firestoreClient.write([new DeleteMutation(this._key,Precondition.NONE)])},e.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var n,r={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||isPartialObserver(e[o])||(validateOptionNames("DocumentReference.onSnapshot",r=e[o],["includeMetadataChanges"]),validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",r.includeMetadataChanges),o++);var i={includeDocumentMetadataChanges:r.includeMetadataChanges,includeQueryMetadataChanges:r.includeMetadataChanges};return isPartialObserver(e[o])?n=e[o]:(validateArgType("DocumentReference.onSnapshot","function",o,e[o]),validateOptionalArgType("DocumentReference.onSnapshot","function",o+1,e[o+1]),validateOptionalArgType("DocumentReference.onSnapshot","function",o+2,e[o+2]),n={next:e[o],error:e[o+1],complete:e[o+2]}),this.onSnapshotInternal(i,n)},e.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var o=new AsyncObserver({next:function(e){if(t.next){assert$1(e.docs.size<=1,"Too many documents returned on a document query");var r=e.docs.get(n._key);t.next(new DocumentSnapshot(n.firestore,n._key,r,e.fromCache))}},error:r}),i=this._firestoreClient.listen(Query.atPath(this._key.path),o,e);return function(){o.mute(),n._firestoreClient.unlisten(i)}},e.prototype.get=function(){var e=this;return validateExactNumberOfArgs("DocumentReference.get",arguments,0),new Promise(function(t,n){var r=e.onSnapshotInternal({includeQueryMetadataChanges:!0,includeDocumentMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(e){r(),!e.exists&&e.metadata.fromCache?n(new FirestoreError(Code.ABORTED,"Failed to get document because the client is offline.")):t(e)},error:n})})},e}(),DocumentSnapshot=function(){function e(e,t,n,r){this._firestore=e,this._key=t,this._document=n,this._fromCache=r}return e.prototype.data=function(){if(validateExactNumberOfArgs("DocumentSnapshot.data",arguments,0),!this._document)throw new FirestoreError(Code.NOT_FOUND,"This document doesn't exist. Check doc.exists to make sure the document exists before calling doc.data().");return this.convertObject(this._document.data)},e.prototype.get=function(e){if(validateExactNumberOfArgs("DocumentSnapshot.get",arguments,1),!this._document)throw new FirestoreError(Code.NOT_FOUND,"This document doesn't exist. Check doc.exists to make sure the document exists before calling doc.get().");var t=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",e));return void 0===t?void 0:this.convertValue(t)},Object.defineProperty(e.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ref",{get:function(){return new DocumentReference(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metadata",{get:function(){return{hasPendingWrites:null!==this._document&&this._document.hasLocalMutations,fromCache:this._fromCache}},enumerable:!0,configurable:!0}),e.prototype.convertObject=function(e){var t=this,n={};return e.forEach(function(e,r){n[e]=t.convertValue(r)}),n},e.prototype.convertValue=function(e){if(e instanceof ObjectValue)return this.convertObject(e);if(e instanceof ArrayValue)return this.convertArray(e);if(e instanceof RefValue){var t=e.value(),n=this._firestore.ensureClientConfigured().databaseId();return e.databaseId.equals(n)||error$1("Document "+this._key.path+" contains a document reference within a different database ("+e.databaseId.projectId+"/"+e.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+n.projectId+"/"+n.database+") instead."),new DocumentReference(t,this._firestore)}return e.value()},e.prototype.convertArray=function(e){var t=this;return e.internalValue.map(function(e){return t.convertValue(e)})},e}(),Query$1=function(){function e(e,t){this._query=e,this.firestore=t}return e.prototype.where=function(t,n,r){validateExactNumberOfArgs("Query.where",arguments,3),validateArgType("Query.where","string",2,n),validateDefined("Query.where",3,r);var o,i=fieldPathFromArgument("Query.where",t);if(i.isKeyField())if("string"==typeof r){if(-1!==r.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it contains a slash.");if(""===r)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");var a=this._query.path.child(new ResourcePath([r]));assert$1(a.length%2==0,"Path should be a document key"),o=new RefValue(this.firestore._databaseId,new DocumentKey(a))}else{if(!(r instanceof DocumentReference))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+valueDescription(r)+".");var s=r;o=new RefValue(this.firestore._databaseId,s._key)}else o=this.firestore._dataConverter.parseQueryValue("Query.where",r);var u=fieldFilter(i,RelationOp.fromString(n),o);return this.validateNewFilter(u),new e(this._query.addFilter(u),this.firestore)},e.prototype.orderBy=function(t,n){validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2),validateOptionalArgType("Query.orderBy","string",2,n);var r;if(void 0===n||"asc"===n)r=Direction.ASCENDING;else{if("desc"!==n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+n+"', expected 'asc' or 'desc'.");r=Direction.DESCENDING}if(null!==this._query.startAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var o=fieldPathFromArgument("Query.orderBy",t),i=new OrderBy(o,r);return this.validateNewOrderBy(i),new e(this._query.addOrderBy(i),this.firestore)},e.prototype.limit=function(t){if(validateExactNumberOfArgs("Query.limit",arguments,1),validateArgType("Query.limit","number",1,t),t<=0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. Query limit ("+t+") is invalid. Limit must be positive.");return new e(this._query.withLimit(t),this.firestore)},e.prototype.startAt=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];validateAtLeastNumberOfArgs("Query.startAt",arguments,1);var o=this.boundFromDocOrFields("Query.startAt",t,n,!0);return new e(this._query.withStartAt(o),this.firestore)},e.prototype.startAfter=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];validateAtLeastNumberOfArgs("Query.startAfter",arguments,1);var o=this.boundFromDocOrFields("Query.startAfter",t,n,!1);return new e(this._query.withStartAt(o),this.firestore)},e.prototype.endBefore=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);var o=this.boundFromDocOrFields("Query.endBefore",t,n,!0);return new e(this._query.withEndAt(o),this.firestore)},e.prototype.endAt=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];validateAtLeastNumberOfArgs("Query.endAt",arguments,1);var o=this.boundFromDocOrFields("Query.endAt",t,n,!1);return new e(this._query.withEndAt(o),this.firestore)},e.prototype.isEqual=function(t){if(!(t instanceof e))throw invalidClassError("isEqual","Query",1,t);return this.firestore===t.firestore&&this._query.equals(t._query)},e.prototype.boundFromDocOrFields=function(e,t,n,r){if(validateDefined(e,1,t),t instanceof DocumentSnapshot){if(n.length>0)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+e+"().");var o=t;if(!o.exists)throw new FirestoreError(Code.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+e+"().");return this.boundFromDocument(e,o._document,r)}var i=[t].concat(n);return this.boundFromFields(e,i,r)},e.prototype.boundFromDocument=function(e,t,n){for(var r=[],o=0,i=this._query.orderBy;o<i.length;o++){var a=i[o];if(a.field.isKeyField())r.push(new RefValue(this.firestore._databaseId,t.key));else{var s=t.field(a.field);if(void 0===s){var u=a.field.canonicalString();throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+u+"' (used as the orderBy) does not exist.")}r.push(s)}}return new Bound(r,n)},e.prototype.boundFromFields=function(e,t,n){var r=this._query.explicitOrderBy;if(t.length>r.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+e+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var o=[],i=0;i<t.length;i++){var a=t[i];if(r[i].field.isKeyField()){if("string"!=typeof a)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+e+"(), but got a "+typeof a);if(-1!==a.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Document ID '"+a+"' contains a slash in "+e+"()");var s=new DocumentKey(this._query.path.child(a));o.push(new RefValue(this.firestore._databaseId,s))}else{var u=this.firestore._dataConverter.parseQueryValue(e,a);o.push(u)}}return new Bound(o,n)},e.prototype.onSnapshot=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);var n,r={},o=0;return"object"!=typeof e[o]||isPartialObserver(e[o])||(validateOptionNames("Query.onSnapshot",r=e[o],["includeQueryMetadataChanges","includeDocumentMetadataChanges"]),validateNamedOptionalType("Query.onSnapshot","boolean","includeDocumentMetadataChanges",r.includeDocumentMetadataChanges),validateNamedOptionalType("Query.onSnapshot","boolean","includeQueryMetadataChanges",r.includeQueryMetadataChanges),o++),isPartialObserver(e[o])?n=e[o]:(validateArgType("Query.onSnapshot","function",o,e[o]),validateOptionalArgType("Query.onSnapshot","function",o+1,e[o+1]),validateOptionalArgType("Query.onSnapshot","function",o+2,e[o+2]),n={next:e[o],error:e[o+1],complete:e[o+2]}),this.onSnapshotInternal(r,n)},e.prototype.onSnapshotInternal=function(e,t){var n=this,r=function(e){console.error("Uncaught Error in onSnapshot:",e)};t.error&&(r=t.error.bind(t));var o=new AsyncObserver({next:function(e){t.next&&t.next(new QuerySnapshot(n.firestore,n._query,e))},error:r}),i=this.firestore.ensureClientConfigured(),a=i.listen(this._query,o,e);return function(){o.mute(),i.unlisten(a)}},e.prototype.get=function(){var e=this;return validateExactNumberOfArgs("Query.get",arguments,0),new Promise(function(t,n){var r=e.onSnapshotInternal({includeDocumentMetadataChanges:!1,includeQueryMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(e){r(),t(e)},error:n})})},e.prototype.validateNewFilter=function(e){if(e instanceof RelationFilter&&e.isInequality()){var t=this._query.getInequalityFilterField();if(null!==t&&!t.equals(e.field))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+t.toString()+"' and '"+e.field.toString()+"'");var n=this._query.getFirstOrderByField();null!==n&&this.validateOrderByAndInequalityMatch(e.field,n)}},e.prototype.validateNewOrderBy=function(e){if(null===this._query.getFirstOrderByField()){var t=this._query.getInequalityFilterField();null!==t&&this.validateOrderByAndInequalityMatch(t,e.field)}},e.prototype.validateOrderByAndInequalityMatch=function(e,t){if(!t.equals(e))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+e.toString()+"' and so you must also use '"+e.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+t.toString()+"' instead.")},e}(),QuerySnapshot=function(){function e(e,t,n){this._firestore=e,this._originalQuery=t,this._snapshot=n,this._cachedChanges=null,this.metadata={fromCache:n.fromCache,hasPendingWrites:n.hasPendingWrites}}return Object.defineProperty(e.prototype,"docs",{get:function(){var e=[];return this.forEach(function(t){return e.push(t)}),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e,t){var n=this;validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2),validateArgType("QuerySnapshot.forEach","function",1,e),this._snapshot.docs.forEach(function(r){e.call(t,n.convertToDocumentImpl(r))})},Object.defineProperty(e.prototype,"query",{get:function(){return new Query$1(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"docChanges",{get:function(){return this._cachedChanges||(this._cachedChanges=changesFromSnapshot(this._firestore,this._snapshot)),this._cachedChanges},enumerable:!0,configurable:!0}),e.prototype.convertToDocumentImpl=function(e){return new DocumentSnapshot(this._firestore,e.key,e,this.metadata.fromCache)},e}(),CollectionReference=function(e){function t(t,n){var r=e.call(this,Query.atPath(t),n)||this;if(t.length%2!=1)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+t.canonicalString()+" has "+t.length);return r}return __extends$5(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){var e=this._query.path.popLast();return e.isEmpty()?null:new DocumentReference(new DocumentKey(e),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),t.prototype.doc=function(e){if(validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1),0===arguments.length&&(e=AutoId.newId()),validateArgType("CollectionReference.doc","string",1,e),""===e)throw new FirestoreError(Code.INVALID_ARGUMENT,"Document path must be a non-empty string");var t=ResourcePath.fromString(e);return DocumentReference.forPath(this._query.path.child(t),this.firestore)},t.prototype.add=function(e){validateExactNumberOfArgs("CollectionReference.add",arguments,1),validateArgType("CollectionReference.add","object",1,e);var t=this.doc();return t.set(e).then(function(){return t})},t}(Query$1),PublicFirestore=makeConstructorPrivate(Firestore,"Use firebase.firestore() instead."),PublicTransaction=makeConstructorPrivate(Transaction,"Use firebase.firestore().runTransaction() instead."),PublicWriteBatch=makeConstructorPrivate(WriteBatch,"Use firebase.firestore().batch() instead."),PublicDocumentReference=makeConstructorPrivate(DocumentReference,"Use firebase.firestore().doc() instead."),PublicDocumentSnapshot=makeConstructorPrivate(DocumentSnapshot),PublicQuery=makeConstructorPrivate(Query$1),PublicQuerySnapshot=makeConstructorPrivate(QuerySnapshot),PublicCollectionReference=makeConstructorPrivate(CollectionReference,"Use firebase.firestore().collection() instead."),firestoreNamespace={Firestore:PublicFirestore,GeoPoint:GeoPoint,Blob:PublicBlob,Transaction:PublicTransaction,WriteBatch:PublicWriteBatch,DocumentReference:PublicDocumentReference,DocumentSnapshot:PublicDocumentSnapshot,Query:PublicQuery,QuerySnapshot:PublicQuerySnapshot,CollectionReference:PublicCollectionReference,FieldPath:FieldPath$1,FieldValue:PublicFieldValue,setLogLevel:Firestore.setLogLevel};registerFirestore(firebase$1);class FbContentEditor{render(){var e={apiKey:this.id,authDomain:this.id+".firebaseapp.com",databaseURL:"https://"+this.id+".firebaseio.com",projectId:this.id,storageBucket:this.id+".appspot.com"};app.initializeApp(e);var t=app.firestore();return this.dataRef=t.collection("posts").doc(this.doc),h("div",{class:"contentEditorWrapper"},h("div",{class:"contentTextWrapper"},h("textarea",{class:"contentTextField",id:"content"})),h("div",{class:"contentButtonWrapper"},h("button",{class:"contentEditorButton",onClick:()=>{this.send()}},"Submit")))}send(){this.content=document.getElementById("content").value,this.excerpt=this.content.substring(0,25)+"...",1==confirm("Submit   "+this.excerpt+"?")&&this.dataRef.set({data:this.content})}}class FbString{render(){var e={apiKey:this.id,authDomain:this.id+".firebaseapp.com",databaseURL:"https://"+this.id+".firebaseio.com",projectId:this.id,storageBucket:this.id+".appspot.com"};app.initializeApp(e);var t=app.firestore();return this.dataRef=t.collection("posts").doc(this.item),this.dataRef.onSnapshot(function(e){this.docData=e.data().data,document.getElementById("fbDataTarget").innerHTML=this.docData}),h("div",{id:"fbDataTarget"})}}exports["fb-content-editor"]=FbContentEditor,exports["fb-string"]=FbString},["fb-content-editor",[["doc",1,1,1],["id",1,1,1],["key",1,1,1]],{}],["fb-string",[["id",1,1,1],["item",1,1,2],["key",1,1,1]],{}]);;